<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unperformed experiments have no results</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <style>
            body {
            background-color: #000000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            }
            button, select, a, a:visited {
            padding: 8px 12px 8px 12px;
            border: none;
            border-radius: 5px;
            margin-right: 5px;
            color: #ffffff;
            background-color: #000000;
            opacity: 0.5;
            font-family: Monospace;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            }
            button:hover, select:hover, a:hover {
            opacity: 1;
            box-shadow: 0 0 4px #FFF;
            }
            option {
            color: #ffffff;
            background-color: #000000;
            }
            ::-webkit-scrollbar
            {
            width:10px;
            }
            ::-webkit-scrollbar-track-piece
            {
            background-color:transparent;
            }
            ::-webkit-scrollbar-corner
            {
            background-color:transparent;
            }
        .dg {
            font-family: Monaco, sans-serif;
            font-size:8pt;
            }
        </style>
        </style>
        <script src="silencio/js/dat.gui.js"></script>
        <script src='silencio/js/jquery.js'></script>
        <script src='silencio/js/helpers.js'></script>
        <script src="silencio/js/codemirror.js"></script>
        <script src="silencio/js/glsl.js"></script>
        <script src="silencio/js/tinycolor.js"></script>
        <script src="silencio/js/Silencio.js"></script>
        <script src="silencio/js/ChordSpace.js"></script>
        <script src="silencio/js/sprintf.js"></script>
    </head>
    <body>
        <textarea class="code" id="orc" hidden rows=24 cols=80>

sr = 48000
ksmps = 100
nchnls = 2
0dbfs = 1500000

connect "FM_Clang", "outleft", "ReverbLeft", "inleft"
connect "FM_Clang", "outright", "ReverbRight", "inright"
connect "Harpsichord", "outleft", "Reverb2Left", "inleft"
connect "Harpsichord", "outright", "Reverb2Right", "inright"
connect "PianoOut", "outleft", "MasterOutput", "inleft"
connect "PianoOut", "outright", "MasterOutput", "inright"
connect "PianoOut", "outleft", "Reverb2Left", "inleft"
connect "PianoOut", "outright", "Reverb2Right", "inright"
connect "ReverbLeft", "outleft", "MasterOutput", "inleft"
connect "ReverbRight", "outright", "MasterOutput", "inright"
connect "Reverb2Left", "outleft", "MasterOutput", "inleft"
connect "Reverb2Right", "outright", "MasterOutput", "inright"

alwayson "FM_Clang_controls"
alwayson "Controls"
alwayson "PianoOut"
alwayson "ReverbLeft"
alwayson "ReverbRight"
alwayson "Reverb2Left"
alwayson "Reverb2Right"
alwayson "FM_Clang_preset"
alwayson "ParametricEQ"
alwayson "MasterOutput"

gk_overlap init .25

gaSendM,gaSendL,gaSendR init 0
gi_FM_Clang_sine ftgen 0,0,4096,10,1 ;A SINE WAVE. USED BY THE LFOs.
gi_FM_Clang_detuning ftgen 0,0,128,21,1,1 ; random array used for fixing unique detune values for each note
gi_FM_Clang_DryMap ftgen 0,0,4096,7,1,2048,1,2048,0 ; dry mixer control mapping
gi_FM_Clang_WetMap ftgen 0,0,4096,7,0,2048,1,2048,1 ; wet mixer control mapping
gaSendL,gaSendR init 0 ; initialise variable used for sending audio between instruments
gi_FM_Clang_Imp ftgen 0,0,4097,9,0.5,1,0 ; shape for the hammer inpulse
gi_FM_Clang_stereo ftgen 0,0,256,21,1,1 ; random array used for fixing unique stereo values for each note
gi_FM_Clang_detune ftgen 0,0,256,21,1,1 ; random array used for fixing unique detune values for each note
gi_FM_Clang_scale ftgen 0,0,128,-7,-1,128,1

instr FM_Clang_controls ; Read in widgets
iporttime = 0.05
gk_FM_Clang_mod chnget "mod"
gk_FM_Clang_mod port gk_FM_Clang_mod,iporttime
gk_FM_Clang_NdxVel chnget "NdxVel"
gk_FM_Clang_Dur chnget "Dur"
gk_FM_Clang_FiltFund chnget "FiltFund"
gk_FM_Clang_NdxCurve chnget "NdxCurve"
gk_FM_Clang_LPF chnget "LPF"
gk_FM_Clang_ModDep chnget "ModDep"
gk_FM_Clang_ModRte chnget "ModRte"
gk_FM_Clang_ModRteKyb chnget "ModRteKyb"
gk_FM_Clang_ModMix chnget "ModMix"
gk_FM_Clang_Sustain chnget "Sustain"
gk_FM_Clang_CarKyb chnget "CarKyb"
gk_FM_Clang_StWidth chnget "StWidth"
gk_FM_Clang_StWidth init 0.01
gk_FM_Clang_StMix chnget "StMix"
gk_FM_Clang_DryWet chnget "RvbDryWet"
gk_FM_Clang_Dry table gk_FM_Clang_DryWet,gi_FM_Clang_DryMap,1 ; map dry/wet control
gk_FM_Clang_Wet table gk_FM_Clang_DryWet,gi_FM_Clang_WetMap,1 ;
gk_FM_Clang_RvbSize chnget "RvbSize"
gk_FM_Clang_Detune chnget "Detune"
gk_FM_Clang_DtnMix chnget "DtnMix"
gk_FM_Clang_Amp chnget "Amp"
gk_FM_Clang_level chnget "gk_FM_Clang_level"
gk_FM_Clang_Amp port gk_FM_Clang_Amp,iporttime
gk_FM_Clang_AttTim chnget "AttTim"
gk_FM_Clang_AttVel chnget "AttVel"
gk_FM_Clang_NseAmp chnget "NseAmp"
gk_FM_Clang_NseBW chnget "NseBW"
gk_FM_Clang_NseFllw chnget "NseFllw"
endin

;#include "patches/PianoNoteFluidsynth.inc"
#include "patches/PianoNotePianoteq.inc"

gk_Harpsichord_level init .25
gk_Harpsichord_pick init .75
gk_Harpsichord_reflection init .5
gk_Harpsichord_pluck init .75
instr Harpsichord
insno 		 = p1
itime 		 = p2
iduration 		 = p3
ikey 		 = p4
ivelocity = p5
iphase = p6
ipan = p7
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
gk_Harpsichord_pan = .5
iattack = .005
isustain = p3
irelease = .3
p3 = iattack + isustain + irelease
iHz = cpsmidinn(ikey)
kHz = k(iHz)
iamplitude = ampdb(ivelocity) * 10
aenvelope 	 transeg 1.0, 20.0, -10.0, 0.05
;apluck 	 pluck 1, kHz, iHz, 0, 1
;apluck 	 pluck 1, kHz, iHz, 0, 6
k_amplitude = 1
apluck wgpluck2 i(gk_Harpsichord_pluck), k_amplitude, iHz, gk_Harpsichord_pick, gk_Harpsichord_reflection
iharptable 	 ftgenonce 0, 0, 65536, 7, -1, 1024, 1, 1024, -1
aharp 	 poscil 1, kHz, iharptable
aharp2 	 balance apluck, aharp
asignal	= (apluck + aharp2) * iamplitude * aenvelope * gk_Harpsichord_level
adeclick linsegr 0, iattack, 1, isustain, 1, irelease, 0
asignal = asignal * adeclick
aleft, aright pan2 asignal, ipan
kgain = ampdb(gk_Harpsichord_level)
outleta "outleft", aleft * kgain
outleta "outright", aright * kgain
;;;;;;;;;;;;;;;;;;;;i
prints "Harpsichord i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

opcode FM_Clang_veloc, i, iii
; *p->r = *p->ilo + csound->curip->m_veloc*(*p->ihi - *p->ilo) * dv127;
ivel, ilow, ihigh xin
xout ilow + ivel * (ihigh - ilow) * 0.007874
endop

instr FM_Clang ; Sound producing instrument. Triggered by MIDI notes or score notes.
//////////////////////////////////////////////
// Original by Iain McCurdy.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
kgain init 1
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p6
ipan = p7
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
icps = cpsmidinn(ikey)
inum = ikey
iamplitude = ampdb(ivelocity)
; icps cpsmidi
; inum notnum
iKybdScl table inum,gi_FM_Clang_scale ; Keyboard scaling value. Note '0' maps to a value of -1, note 64 maps to a value of zero and note 127 maps to a value of 1.
; Amplitude Envelope
idur = i(gk_FM_Clang_Dur)
iAmpCurve = -8
iRelTim = (i(gk_FM_Clang_Sustain)==1?idur:0.1)
;iAttVel veloc i(gk_FM_Clang_AttVel)*0.05,0
iAttVel FM_Clang_veloc ivelocity, i(gk_FM_Clang_AttVel)*0.05,0
iAttTim = iAttVel + i(gk_FM_Clang_AttTim)
if iAttTim==0 then
aAEnv transegr 1,idur,iAmpCurve,0, iRelTim,iAmpCurve,0
else
aAEnv transegr 0,iAttTim,iAmpCurve, 1,idur,iAmpCurve,0, iRelTim,iAmpCurve,0
endif
; Key velocity to amplitude
;iAVel veloc 0,0.1
iAVel FM_Clang_veloc ivelocity, 0, 0.1
; FM index
iNdx veloc 0,i(gk_FM_Clang_NdxVel) ; Key velocity to FM index
iNdx FM_Clang_veloc ivelocity, 0,i(gk_FM_Clang_NdxVel) ; Key velocity to FM index
kIEnv transeg iNdx*octave(-iKybdScl*4),idur,-i(gk_FM_Clang_NdxCurve),0 ; Index envelope. Amplitude influenced by 'Index' widget control and keyboard scaling (index reduced for higher notes, increased for lower notes)
; Carrier frequency keyboard scaling
icar = 1 * octave(iKybdScl*i(gk_FM_Clang_CarKyb))
; Carrier ratio modulation
iModRte table inum,gi_FM_Clang_scale
iModRte = octave(iModRte*i(gk_FM_Clang_ModRteKyb))
kDepEnv transeg 1,idur,-4,0
amod lfo gk_FM_Clang_ModDep*0.1*kDepEnv, gk_FM_Clang_ModRte * iModRte, 0
; Noise bandpass filter cutoff as it respond to the 'Carrier Follow' switch
kcf = gk_FM_Clang_NseFllw==1?icps*gk_FM_Clang_mod:icps
; Noise amplitude keyboard following
kNseAmp = octave(iKybdScl*-4)*gk_FM_Clang_NseAmp
; Main FM algorithm
if gk_FM_Clang_NseAmp>0 then ; If noise amplitude is greater than zero...
aNse gauss kNseAmp ; ... generate some gaussian noise
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW ; bandpass filter the noise
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW ; and again
else
aNse = 0 ; Otherwise no noise signal!
endif
idetune table inum,gi_FM_Clang_detune ; Read a detuning value from a random table
asig foscil iAVel, icps*cent(-gk_FM_Clang_Detune*idetune), icar +aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; FM pair
aModSig foscil iAVel, icps*cent(-gk_FM_Clang_Detune*idetune), icar+amod+aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; FM pair with modulation
asig = asig + (aModSig * gk_FM_Clang_ModMix) ; Mix the two FM pairs.
; Auxilliary FM algorithm (used for detuning)
if gk_FM_Clang_DtnMix>0&&gk_FM_Clang_Detune>0 then
if gk_FM_Clang_NseAmp>0 then
aNse gauss kNseAmp
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW
else
aNse = 0
endif
idetune table inum+128,gi_FM_Clang_detune ; Read a detuning value from a random table
asig2 foscil iAVel, icps*cent(gk_FM_Clang_Detune*idetune), icar +aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; Detuning applied to fundemental
aModSig2 foscil iAVel, icps*cent(gk_FM_Clang_Detune*idetune), icar+amod+aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine
asig2 = asig2 + (aModSig2 * gk_FM_Clang_ModMix)
asig = asig + asig2*gk_FM_Clang_DtnMix
endif
; Filter Fundemental
if i(gk_FM_Clang_FiltFund)==1 then ; If filter fundemental switch is active
asig butbr asig,icps*icar,icps*icar*0.3 ; Filter out fundemental
asig butbr asig,icps*icar,icps*icar*0.3 ; and again to make sure it is all gone
endif
; Lowpass Filter
if i(gk_FM_Clang_LPF)<32 then ; If lowpass filter is less than maximum...
kCF limit icps*gk_FM_Clang_LPF,20,20000 ; ...create the cutoff value in CPS based on fundemental and LPF ratio control. Limit to prevent out of range values.
asig clfilt asig,kCF,0,2 ; Butterworth lowpass filter
endif
; Amplitude Envelope
kgain = ampdb(gk_FM_Clang_level)
asig = asig * aAEnv * gk_FM_Clang_Amp * kgain; Apply amplitude envelope
; Stereo Effect
iDlyTimL table inum,gi_FM_Clang_stereo ; Read a delay time value from a random table based on note played
iDlyTimR table inum+128,gi_FM_Clang_stereo ; Read a different delay time value from a random table based on note played
if gk_FM_Clang_StWidth>0&&gk_FM_Clang_StMix>0 then ; If 'width' is above zero and 'mix' is above zero...
aL vdelay asig, iDlyTimL*gk_FM_Clang_StWidth*1000, 0.2*1000 ; ...left channel delay
aR vdelay asig, iDlyTimR*gk_FM_Clang_StWidth*1000, 0.2*1000 ; right channel delay
aL ntrpol asig, aL, gk_FM_Clang_StMix ; Mix delayed and dry signal
aR ntrpol asig, aR, gk_FM_Clang_StMix ;
aleft = aL;*gk_FM_Clang_Dry
aright = aR;*gk_FM_Clang_Dry
gaSendL = gaSendL + aL ; Send to reverb
gaSendR = gaSendR + aR
else
aleft = asig;*gk_FM_Clang_Dry
aright = asig;*gk_FM_Clang_Dry
gaSendL = gaSendL + asig ; Send to reverb
gaSendR = gaSendR + asig
endif
aleft1 = aleft * ampdb(ivelocity)
aright1 = aright * ampdb(ivelocity)
asignal = (aleft1 + aright1) *100
aleft2, aright2 pan2 asignal, ipan
outleta "outleft", aleft2
outleta "outright", aright2
prints "FM_Clang    i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_FM_Clang_preset init 1
instr FM_Clang_preset
gk_FM_Clang_preset chnget "gk_FM_Clang_preset"
gk_FM_Clang_preset_ int gk_FM_Clang_preset
ktrig changed gk_FM_Clang_preset_
#define SET_PRESET(N'Amp'AttTim'AttVel'Dur'Sustain'mod'NdxVel'NdxCurve'CarKyb'DtnMix'Detune'LPF'FiltFund'NseAmp'NseBW'NseFllw'ModMix'ModDep'ModRte'ModRteKyb'StMix'StWidth'RvbDryWet'RvbSize)
#
if i(gk_FM_Clang_preset_)==$N then
printks2 "Setting preset %d\n", $N
chnset $Amp ,"Amp"
chnset $AttTim ,"AttTim"
chnset $AttVel ,"AttVel"
chnset $Dur ,"Dur"
chnset $Sustain ,"Sustain"
chnset $mod ,"mod"
chnset $NdxVel ,"NdxVel"
chnset $NdxCurve ,"NdxCurve"
chnset $CarKyb ,"CarKyb"
chnset $DtnMix ,"DtnMix"
chnset $Detune ,"Detune"
chnset $LPF ,"LPF"
chnset $FiltFund ,"FiltFund"
chnset $NseAmp ,"NseAmp"
chnset $NseBW ,"NseBW"
chnset $NseFllw ,"NseFllw"
chnset $ModMix ,"ModMix"
chnset $ModDep ,"ModDep"
chnset $ModRte ,"ModRte"
chnset $ModRteKyb,"ModRteKyb"
chnset $StMix ,"StMix"
chnset $StWidth ,"StWidth"
chnset $RvbDryWet,"RvbDryWet"
chnset $RvbSize ,"RvbSize"
endif
#
if ktrig==1 then
reinit SEND_PRESET
endif
SEND_PRESET:
; N'Amp'AttTim'AttVel'Dur'Sustain'mod 'NdxVel'NdxCurve'CarKyb'DtnMix'Detune'LPF'FiltFund'NseAmp'NseBW'NseFllw'ModMix'ModDep'ModRte'ModRteKyb'StMix'StWidth'RvbDryWet'RvbSize)
$SET_PRESET(1'0.5'0 '0 '12 '1 '2.29'1 '16 '0 '1 '1.5 '16 '1 '1000 '0.001'0 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(2'0.8'0 '0 '1.7'1 '5.04'0.55 '100 '0 '0 '0 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.1 '0.55 )
$SET_PRESET(3'0.5'0.1 '0.5 '3.8'1 '1.00'2 '28 '0 '1 '15 '16 '0 '500 '0.0077'1 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(4'0.5'0 '0.006 '24 '1 '3.19'1 '15 '0 '0.47 '2.5 '16 '1 '0 '0.001'0 '1 '0.1 '0.33 '1.7 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(5'0.8'0 '1 '6.6'0 '1.12'1 '13 '-2.68 '1 '25 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '1 '0.02 '0.172 '0.21 )
$SET_PRESET(6'3.25'0.1 '1 '1.28'0 '2.55'0.55 '35 '-2.3 '0 '1.5 '16 '1 '2000 '0.0025'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.68 '0.93 )
$SET_PRESET(7'4 '0.1 '1 '2.39'1 '2.55'0.55 '35 '-2.3 '0 '1.5 '16 '1 '16 '0.1262'0 '0 '0.1 '3 '0 '0 '0.01 '1.00 '0 )
$SET_PRESET(8'1 '0 '0 '14.25'1 '6.97'0.55 '35 '-2.3 '0.13 '1.5 '4.78'1 '16 '0.0326'0 '1 '0.1 '3 '0 '0 '0.01 '0.6 '0 )
$SET_PRESET(9'1.65'0 '0 '1.7'1 '1.20'0.55 '100 '0 '0 '0 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.1 '0.55 )
$SET_PRESET(10'2' 0 '0 '1 '1 '2.15'0.55 '100 '0 '0.21 '12 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.35 '0.37 )
$SET_PRESET(11'2 '0.1 '1 '3.44'1 '3.75'0.55 '100 '0 '0.21 '25 '16 '0 '0 '0.001'1 '0 '0.1 '3 '0 '0.5 '0.05 '0 '0.37 )
$SET_PRESET(12'2 '0.1 '1 '1.45'1 '2.66'1.00 '16 '0 '0.21 '25 '16 '0 '0 '0.001'1 '0 '0.1 '3 '0 '0.5 '0.05 '0.6 '0.37 )
$SET_PRESET(13'1.9'0 '0 '24 '1 '2.29'1.00 '23.25 '-4 '1 '1.5 '16 '1 '151 '0.0178'1 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
endin

;#include "patches/PianoOutFluidsynth.inc"
#include "patches/PianoOutPianoteq.inc"

gk_Reverb_Feedback init 0.975
gk_Delay_Modulation init 0.875

instr ReverbLeft
aleft init 0
azero init 0
aleft inleta "inleft"
aleft, aright reverbsc aleft, azero, gk_Reverb_Feedback, 15000.
outleta "outleft", aleft
;;;;;;;;;;;;;;;;;;;;i
prints "ReverbLeft  i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

instr ReverbRight
aleft init 0
azero init 0
aright inleta "inright"
aleft, aright reverbsc azero, aright, gk_Reverb_Feedback, 15000.0
outleta "outright", aright
;;;;;;;;;;;;;;;;;;;;i
prints "ReverbRight i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_Reverb2_Feedback init 0.975
gk_Delay2_Modulation init 0.875

instr Reverb2Left
aleft init 0
azero init 0
aleft inleta "inleft"
aleft, aright reverbsc aleft, azero, gk_Reverb2_Feedback, 15000.
outleta "outleft", aleft
;;;;;;;;;;;;;;;;;;;;i
prints "Reverb2Left i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

instr Reverb2Right
aleft init 0
azero init 0
aright inleta "inright"
aleft, aright reverbsc azero, aright, gk_Reverb2_Feedback, 15000.0
outleta "outright", aright
;;;;;;;;;;;;;;;;;;;;i
prints "Reverb2Righ i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_CenterHz init 200
gk_Gain init 1
gk_Q init 0.7071067 ; sqrt(.5)
instr ParametricEQ
aleft inleta "inleft"
aright inleta "inright"
aleft pareq aleft, gk_CenterHz, ampdb(gk_Gain), gk_Q, 0
aright pareq aright, gk_CenterHz, ampdb(gk_Gain), gk_Q, 0
outleta "outleft", aleft
outleta "outright", aright
;;;;;;;;;;;;;;;;;;;;i
prints "ParametrcEQ i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_MasterOutput_level init .5
instr MasterOutput
aleft inleta "inleft"
aright inleta "inright"
kgain = ampdb(gk_MasterOutput_level)
; printks2 "Master gain: %f\n", kgain
iamp init 1
iattack init .01
idecay init 10
isustain = 2400 - (iattack + idecay)
aenvelope transeg 0.0, iattack / 2.0, 1.5, iamp / 2.0, iattack / 2.0, -1.5, iamp, isustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
aright butterlp aright, 16000
aleft butterlp aleft, 16000
outs aleft * kgain * aenvelope, aright * kgain * aenvelope
Sfilename init  "Black Mountain 18.wav"
prints sprintf("Output filename: %s\n", Sfilename)
; We want something that will play on my phone.
i_amplitude_adjustment = ampdbfs(-3) / 32767
fout Sfilename, 18, aleft * i_amplitude_adjustment, aright * i_amplitude_adjustment
;;;;;;;;;;;;;;;;;;;;i
prints "MasterOutpt i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

instr Controls
    gk_Harpsichord_level chnget "gk_Harpsichord_level"
    gk_Harpsichord_pick chnget "gk_Harpsichord_pick"
    gk_Harpsichord_reflection chnget "gk_Harpsichord_reflection"
    gk_Harpsichord_pluck chnget "gk_Harpsichord_pluck"
    gk_MasterOutput_level chnget "gk_MasterOutput_level"
    gk_Piano_level chnget "gk_Piano_level"
    gk_Reverb_Feedback chnget "gk_Reverb_Feedback"
    gk_Reverb2_Feedback chnget "gk_Reverb2_Feedback"
    gk_overlap chnget "gk_overlap"
;;;;;;;;;;;;;;;;;;;;i
prints "Controls    i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

    </textarea>
        <script id="example" type="x-shader/x-fragment">
            precision mediump float;
            uniform float time;
            uniform vec2 mouse;
            uniform vec2 resolution;

            vec3 pal(float t, vec3 a, vec3 b, vec3 c, vec3 d)
            {
                return a + b * cos(6.28318 * (c * t + d));
            }

            void main(){
                vec2 uv = gl_FragCoord.xy / resolution.xy;
                uv = uv * 2. - 1.;
                uv.x *= resolution.x / resolution.y;
                float e = time * .125;
                float d = 128.*mouse.x / resolution.x + 8.5;
                float zoom = 64.;
                vec2 g = uv * zoom;
                uv = d * (floor(g) + .5) / zoom;
                g = fract(g) * 2. - 1.;
                float f = dot(uv, uv) - e;
                vec4 c = vec4(
                    pal(f *.5 + e,
                        vec3(0.5, 0.5, 0.5),
                        vec3(0.5, 0.5, 0.5),
                        vec3(1.0, 1.0, 1.0),
                        vec3(0.0, 0.10, 0.20)), 1.);
                gl_FragColor = c * (1. - dot(g, g)) * .2 / abs((fract(f) - .5) * 8.);
            }

        </script>
        <script id="fragmentShader" type="x-shader/x-fragment">
            precision mediump float;
            uniform vec2 resolution;
            uniform sampler2D texture;

            void main(){
                vec2 uv = gl_FragCoord.xy / resolution.xy;
                gl_FragColor = texture2D(texture, uv);
            }

        </script>
        <script id="vertexShader" type="x-shader/x-vertex">
            precision mediump float;
            attribute vec3 position;

            void main(){
                gl_Position = vec4(position, 1.0);
            }
        </script>
        <script id="surfaceVertexShader" type="x-shader/x-vertex">
            precision mediump float;
            attribute vec3 position;
            attribute vec2 surfacePosAttrib;
            varying vec2 surfacePosition;

            void main(){
                surfacePosition = surfacePosAttrib;
                gl_Position = vec4(position, 1.0);
            }
        </script>
        <script>
/* jshint bitwise: true, strict:false */
            "use strict";
            try {
               var csound = require('csound.node');
               console.log('csound:', csound);
                var fs = require('fs');
               var nwgui = require('nw.gui');
               var nw_window = nwgui.Window.get();
               nw_window.on('close', function() {
                  console.log('Closing down...');
                  this.close(true);
                  });
               var score = new Silencio.Score();
               var FM9 = ChordSpace.chordForName('FM9');
               var Bb7 = ChordSpace.chordForName('Bb7');
               var chord = Bb7.clone();
               var modality = chord.clone();
            initialize_helper();
            var compressor=initialize_compressor();
            if (!window.requestAnimationFrame){
                window.requestAnimationFrame = (function(){
                    return window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function (callback, element){
                            window.setTimeout(callback, 1000 / parameters.frames_per_second);
                        };
                })();
            }
            // Get older browsers safely through init code, so users can read the
            // message about how to download newer browsers.
            if (!Date.now){
                Date.now = function(){
                    return +new Date();
                };
            }
            var quality = 2, quality_levels = [0.5, 1, 2, 4, 8];
            var toolbar, compileButton, fullscreenButton, compileTimer, errorLines = [];
            var code, canvas, gl, buffer, currentProgram, vertexPosition, screenVertexPosition, panButton;
            var parameters = {
                frames_per_second: 24,
                startTime: Date.now(),
                time: 0,
                mouseX: 0.5,
                mouseY: 0.5,
                screenWidth: 0,
                screenHeight: 0,
                gk_Harpsichord_level: 0.5,
                gk_Harpsichord_pick: 0.75,
                gk_Harpsichord_reflection: 0.5,
                gk_Harpsichord_pluck: 0.75,
                gk_Piano_level: 0.5,
                gk_Reverb_Feedback: 0.975,
                gk_Reverb2_Feedback: 0.7,
                gk_MasterOutput_level: 0.4,
                gk_overlap: 0.05,
                gk_FM_Clang_preset: 1,
                gk_FM_Clang_level: 0,
                Play: function() {
                    //csound.stop();
                    try {
                        csound.setMessageCallback(csoundMessage);
                    } catch(e) {
                        console.log(e);
                    }
                    csound.setOption('-m0');
                    //csound.setOption('-j3');
                    csound.setOption('--nodisplays');
                    csound.setOption('-odac');
                    var orc = document.getElementById('orc').value;
                    csound.compileOrc(orc);
                    csound.readScore('f 0 360\n');
                    csound.start();
                    csound.perform();
                    ///startTime = csound.getScoreTime();
                },
                Stop: function() {
                    csound.stop();
                },
                Developer_tools: function() {
                    nwgui.Window.get().showDevTools();
                },
                Close: function() {
                    try {
                        csound.stop();
                        window.close();
                    } catch (e) {
                        console.log(e);
                    }
                },
                FM9: function() {
                    chord = FM9.clone();
                    csound.message('FM9:\n' + chord.information());
                },
                Bb7: function() {
                    chord = Bb7.clone();
                    csound.message('Bb7:\n' + chord.information());
                },
                K: function() {
                    chord = chord.K();
                    csound.message('K():\n' + chord.information());
                },
                Q2: function() {
                    chord = chord.Q(2, modality);
                    csound.message('Q(2, modality):\n' + chord.information());
                },
                Q3: function() {
                    chord = chord.Q(3, modality);
                    csound.message('Q(3, modality):\n' + chord.information());
                },
                Q5: function() {
                    chord = chord.Q(5, modality);
                    csound.message('Q(5, modality):\n' + chord.information());
                },
                J2_2: function() {
                    var chords = chord.J(2);
                    if (chords.length > 1) {
                        chord = chords[1];
                        csound.message('J(2,2):\n' + chord.information());
                    }
                },
                J2_3: function() {
                    var chords = chord.J(2);
                    if (chords.length > 2) {
                        chord = chords[2];
                        csound.message('J(2,3):\n' + chord.information());
                    }
                },
                J3_1: function() {
                   var chords = chord.J(3);
                    if (chords.length > 0) {
                        chord = chords[0];
                        csound.message('J(3,1):\n' + chord.information());
                    }
                },
                T5: function() {
                    chord = chord.T(5);
                    csound.message('D():\n' + chord.information());
                },
            };
            var surface = { centerX: 0, centerY: 0, width: 1, height: 1, isPanning: false, isZooming: false, lastX: 0, lastY: 0 },
            frontTarget, backTarget, screenProgram, getWebGL, resizer = {}, compileOnChangeCode = true;
            var csoundMessage = function(text) {
                console.log(text);
            }
            var init = function(){
                canvas = document.createElement('canvas');
                canvas.style.display = 'block';
                document.body.appendChild(canvas);
                toolbar = document.createElement('div');
                toolbar.style.position = 'absolute';
                toolbar.style.top = '25px';
                toolbar.style.left = '25px';
                //document.body.appendChild(toolbar);
                var rightside = document.createElement('div');
                rightside.style.cssFloat = 'right';
                toolbar.appendChild(rightside);
                panButton = document.createElement('button');
                panButton.textContent = 'pan/zoom';
                panButton.style.cursor = 'move';
                panButton.style.display = 'none';
                panButton.title = "Pan: left-drag, Zoom: right-drag. Use 'hide code' for a large pan/zoom area.";
                rightside.appendChild(panButton);
                fullscreenButton = document.createElement('button');
                fullscreenButton.textContent = 'fullscreen';
                fullscreenButton.title = 'Press F11 to enter or leave fullscreen mode';
                fullscreenButton.addEventListener('click', function (event){
                    if (document.body.requestFullScreen){
                        document.body.requestFullScreen();
                    } else if (document.body.mozRequestFullScreen){
                        document.body.mozRequestFullScreen();
                    } else if (document.body.webkitRequestFullScreen){
                        document.body.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                }, false);
               rightside.appendChild(fullscreenButton);
               var button = document.createElement('a');
               button.textContent = 'gallery';
               button.href = '/';
               rightside.appendChild(button);
                var button = document.createElement('button');
                button.textContent = 'show fragment';
                button.addEventListener('click', function (event){
                    if (isCodeVisible()){
                        button.textContent = 'show fragment';
                        code.getWrapperElement().style.display = 'none';
                        compileButton.style.visibility = 'hidden';
                        set_save_button('hidden');
                        set_parent_button('hidden');
                        ///stopHideUI();
                    } else {
                        button.textContent = 'hide fragment';
                        code.getWrapperElement().style.display = '';
                        compileButton.style.visibility = 'visible';
                        set_save_button('visible');
                        set_parent_button('visible');
                    }
                }, false);
                toolbar.appendChild(button);
                var select = document.createElement('select');
                for (var i = 0; i < quality_levels.length; i ++){
                    var option = document.createElement('option');
                    option.textContent = quality_levels[i];
                    if (quality_levels[i] == quality)option.selected = true;
                    select.appendChild(option);
                }
                select.addEventListener('change', function (event){
                    quality = quality_levels[event.target.selectedIndex];
                    onWindowResize();
                }, false);
                toolbar.appendChild(select);
                compileButton = document.createElement('button');
                compileButton.textContent = 'compile';
                compileButton.addEventListener('click', function (event){
                    compile();
                }, false);
                toolbar.appendChild(compileButton);
                // from helper.js
                add_server_buttons();
                gl = canvas.getContext('experimental-webgl', { preserveDrawingBuffer: true });
               // enable dFdx, dFdy, fwidth
               gl.getExtension('OES_standard_derivatives');
               // Create vertex buffer (2 triangles)
               buffer = gl.createBuffer();
               gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
               gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([- 1.0, - 1.0, 1.0, - 1.0, - 1.0, 1.0, 1.0, - 1.0, 1.0, 1.0, - 1.0, 1.0]), gl.STATIC_DRAW);
               // Create surface buffer (coordinates at screen corners)
               surface.buffer = gl.createBuffer();
                code = CodeMirror(document.body, {
                    lineNumbers: true,
                    matchBrackets: true,
                    indentWithTabs: false,
                    tabSize: 4,
                    indentUnit: 4,
                    mode: "text/x-glsl",
                    onChange: function (){
                        if (compileOnChangeCode){
                            clearTimeout(compileTimer);
                            compileTimer = setTimeout(compile, 500);
                        }
                    }
                });
                code.getWrapperElement().style.display = '';
                resizer.offsetMouseX = 0;
                resizer.offsetMouseY = 0;
                resizer.isResizing = false;
                var size_ = 100;
                resizer.currentWidth = size_;
                resizer.currentHeight = size_;
                resizer.minWidth = size_;
                resizer.minHeight = size_;
                resizer.maxWidth = size_;
                resizer.maxHeight = size_;
                resizer.element = document.createElement('div');
                resizer.element.className = 'resizer';
                code.getWrapperElement().appendChild(resizer.element);
                resizer.element.addEventListener('mousedown', function (event){
                    if (event.button !== 2){
                        resizer.offsetMouseX = event.clientX - resizer.currentWidth;
                        resizer.offsetMouseY = event.clientY - resizer.currentHeight;
                        resizer.isResizing = true;
                        event.preventDefault();
                    }
                }, false);
                var surfaceMouseDown = function (event){
                    if (event.shiftKey){
                        resetSurface();
                    }
                    if (event.button === 0){
                        surface.isPanning = true;
                        document.body.style.cursor = 'move';
                    } else {
                        surface.isZooming = true;
                        document.body.style.cursor = 'se-resize';
                        panButton.style.cursor = 'se-resize';
                    }
                    surface.lastX = event.clientX;
                    surface.lastY = event.clientY;
                    event.preventDefault();
                };
                var noContextMenu = function (event){
                    event.preventDefault();
                };
                canvas.addEventListener('mousedown', surfaceMouseDown, false);
                panButton.addEventListener('mousedown', surfaceMouseDown, false);
                canvas.addEventListener('contextmenu', noContextMenu, false);
                panButton.addEventListener('contextmenu', noContextMenu, false);
                var clientXLast, clientYLast;
                document.addEventListener('mousemove', function (event){
                    var clientX = event.clientX;
                    var clientY = event.clientY;
                    if (clientXLast == clientX && clientYLast == clientY)
                        return;
                    clientXLast = clientX;
                    clientYLast = clientY;
                    ///stopHideUI();
                    var codeElement, dx, dy;
                    parameters.mouseX = clientX / window.innerWidth;
                    parameters.mouseY = 1 - clientY / window.innerHeight;
                    if (resizer.isResizing){
                        resizer.currentWidth = Math.max(Math.min(clientX - resizer.offsetMouseX, resizer.maxWidth), resizer.minWidth);
                        resizer.currentHeight = Math.max(Math.min(clientY - resizer.offsetMouseY, resizer.maxHeight), resizer.minWidth);
                        codeElement = code.getWrapperElement();
                        codeElement.style.width = resizer.currentWidth + 'px';
                        codeElement.style.height = resizer.currentHeight + 'px';
                        code.refresh();
                        event.preventDefault();
                    } else if (surface.isPanning){
                        dx = clientX - surface.lastX;
                        dy = clientY - surface.lastY;
                        surface.centerX -= dx * surface.width / window.innerWidth;
                        surface.centerY += dy * surface.height / window.innerHeight;
                        surface.lastX = clientX;
                        surface.lastY = clientY;
                        computeSurfaceCorners();
                        event.preventDefault();
                    } else if (surface.isZooming){
                        dx = clientX - surface.lastX;
                        dy = clientY - surface.lastY;
                        surface.height *= Math.pow(0.997, dx + dy);
                        surface.lastX = clientX;
                        surface.lastY = clientY;
                        computeSurfaceCorners();
                        event.preventDefault();
                    }
                }, false);
                function settleDown (event){
                    resizer.isResizing = surface.isPanning = surface.isZooming = false;
                    document.body.style.cursor = 'default';
                    panButton.style.cursor = 'move';
                }
                function mouseLeave(event){
                    settleDown(event);
                    ///if (!isCodeVisible())
                        ///startHideUITimer();
                }
                document.addEventListener('mouseup', settleDown, false);
                document.addEventListener('mouseleave', mouseLeave, false);
                onWindowResize();
                window.addEventListener('resize', onWindowResize, false);
                load_url_code();
                compileScreenProgram();
            }
            init();
            animate();

            function computeSurfaceCorners(){
                if (gl){
                    surface.width = surface.height * parameters.screenWidth / parameters.screenHeight;
                    var halfWidth = surface.width * 0.5, halfHeight = surface.height * 0.5;
                    gl.bindBuffer(gl.ARRAY_BUFFER, surface.buffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                        surface.centerX - halfWidth, surface.centerY - halfHeight,
                        surface.centerX + halfWidth, surface.centerY - halfHeight,
                        surface.centerX - halfWidth, surface.centerY + halfHeight,
                        surface.centerX + halfWidth, surface.centerY - halfHeight,
                        surface.centerX + halfWidth, surface.centerY + halfHeight,
                        surface.centerX - halfWidth, surface.centerY + halfHeight]), gl.STATIC_DRAW);
                }
            }

            function resetSurface(){
                surface.centerX = surface.centerY = 0;
                surface.height = 1;
                computeSurfaceCorners();
            }

            function compile(){
                var program = gl.createProgram();
                var fragment = code.getValue();
                var vertex = document.getElementById('surfaceVertexShader').textContent;
                var vs = createShader(vertex, gl.VERTEX_SHADER);
                var fs = createShader(fragment, gl.FRAGMENT_SHADER);
                if (vs === null || fs === null)return null;
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.deleteShader(vs);
                gl.deleteShader(fs);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)){
                    var error = gl.getProgramInfoLog(program);
                    compileButton.title = error;
                    console.error(error);
                    console.error('VALIDATE_STATUS: ' + gl.getProgramParameter(program, gl.VALIDATE_STATUS), 'ERROR: ' + gl.getError());
                    compileButton.style.color = '#ff0000';
                    compileButton.textContent = 'compiled with errors';
                    set_save_button('hidden');
                    return;
                }
                if (currentProgram){
                    gl.deleteProgram(currentProgram);
                    setURL(fragment);
                }
                currentProgram = program;
                compileButton.style.color = '#00ff00';
                compileButton.textContent = 'compiled successfully';
                set_save_button('visible');
                panButton.style.display = (fragment.indexOf('varying vec2 surfacePosition;')>= 0)? 'inline' : 'none';
                // Cache uniforms
                cacheUniformLocation(program, 'time');
                cacheUniformLocation(program, 'mouse');
                cacheUniformLocation(program, 'resolution');
                cacheUniformLocation(program, 'backbuffer');
                cacheUniformLocation(program, 'surfaceSize');
                // Load program into GPU
                gl.useProgram(currentProgram);
                // Set up buffers
                surface.positionAttribute = gl.getAttribLocation(currentProgram, "surfacePosAttrib");
                gl.enableVertexAttribArray(surface.positionAttribute);
                vertexPosition = gl.getAttribLocation(currentProgram, "position");
                gl.enableVertexAttribArray(vertexPosition);
            }

            function compileScreenProgram(){
                var program = gl.createProgram();
                var fragment = document.getElementById('fragmentShader').textContent;
                var vertex = document.getElementById('vertexShader').textContent;
                var vs = createShader(vertex, gl.VERTEX_SHADER);
                var fs = createShader(fragment, gl.FRAGMENT_SHADER);
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.deleteShader(vs);
                gl.deleteShader(fs);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)){
                    console.error('VALIDATE_STATUS: ' + gl.getProgramParameter(program, gl.VALIDATE_STATUS), 'ERROR: ' + gl.getError());
                    return;
                }
                screenProgram = program;
                gl.useProgram(screenProgram);
                cacheUniformLocation(program, 'resolution');
                cacheUniformLocation(program, 'texture');
                screenVertexPosition = gl.getAttribLocation(screenProgram, "position");
                gl.enableVertexAttribArray(screenVertexPosition);
            }

            function cacheUniformLocation(program, label){
                if (program.uniformsCache === undefined){
                    program.uniformsCache = {};
                }
                program.uniformsCache[label] = gl.getUniformLocation(program, label);
            }

            function createTarget(width, height){
                var target = {};
                target.framebuffer = gl.createFramebuffer();
                target.renderbuffer = gl.createRenderbuffer();
                target.texture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, target.texture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                gl.bindFramebuffer(gl.FRAMEBUFFER, target.framebuffer);
                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, target.texture, 0);
                gl.bindRenderbuffer(gl.RENDERBUFFER, target.renderbuffer);
                gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, width, height);
                gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, target.renderbuffer);
                gl.bindTexture(gl.TEXTURE_2D, null);
                gl.bindRenderbuffer(gl.RENDERBUFFER, null);
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                return target;
            }

            function createRenderTargets(){
                frontTarget = createTarget(parameters.screenWidth, parameters.screenHeight);
                backTarget = createTarget(parameters.screenWidth, parameters.screenHeight);
            }

            function htmlEncode(str){
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function createShader(src, type){
                var shader = gl.createShader(type);
                var line, lineNum, lineError, index = 0, indexEnd;
                while (errorLines.length > 0){
                    line = errorLines.pop();
                    code.setLineClass(line, null);
                    code.clearMarker(line);
                }
                gl.shaderSource(shader, src);
                gl.compileShader(shader);
                compileButton.title = '';
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)){
                    var error = gl.getShaderInfoLog(shader);
                    // Remove trailing linefeed, for FireFox's benefit.
                    while ((error.length > 1)&& (error.charCodeAt(error.length - 1)< 32)){
                        error = error.substring(0, error.length - 1);
                    }
                    compileButton.title = error;
                    console.error(error);
                    compileButton.style.color = '#ff0000';
                    compileButton.textContent = 'compiled with errors';
                    set_save_button('hidden');
                    while (index >= 0){
                        index = error.indexOf("ERROR: 0:", index);
                        if (index < 0){ break; }
                        index += 9;
                        indexEnd = error.indexOf(':', index);
                        if (indexEnd > index){
                            lineNum = parseInt(error.substring(index, indexEnd));
                            if ((!isNaN(lineNum))&& (lineNum > 0)){
                                index = indexEnd + 1;
                                indexEnd = error.indexOf("ERROR: 0:", index);
                                lineError = htmlEncode((indexEnd > index)? error.substring(index, indexEnd): error.substring(index));
                                line = code.setMarker(lineNum - 1, '<abbr title="' + lineError + '">' + lineNum + '</abbr>', "errorMarker");
                                code.setLineClass(line, "errorLine");
                                errorLines.push(line);
                            }
                        }
                    }
                    return null;
                }
                return shader;
            }

            function onWindowResize(event){
                var isMaxWidth = ((resizer.currentWidth === resizer.maxWidth)|| (resizer.currentWidth === resizer.minWidth)),
                    isMaxHeight = ((resizer.currentHeight === resizer.maxHeight)|| (resizer.currentHeight === resizer.minHeight));
                toolbar.style.width = window.innerWidth - 47 + 'px';
                resizer.isResizing = false;
                resizer.maxWidth = window.innerWidth - 75;
                resizer.maxHeight = window.innerHeight - 125;
                if (isMaxWidth || (resizer.currentWidth > resizer.maxWidth)){
                    resizer.currentWidth = resizer.maxWidth;
                }
                if (isMaxHeight || (resizer.currentHeight > resizer.maxHeight)){
                    resizer.currentHeight = resizer.maxHeight;
                }
                if (resizer.currentWidth < resizer.minWidth){ resizer.currentWidth = resizer.minWidth; }
                if (resizer.currentHeight < resizer.minHeight){ resizer.currentHeight = resizer.minHeight; }
                code.getWrapperElement().style.top = '75px';
                code.getWrapperElement().style.left = '25px';
                code.getWrapperElement().style.width = resizer.currentWidth + 'px';
                code.getWrapperElement().style.height = resizer.currentHeight + 'px';
                canvas.width = window.innerWidth / quality;
                canvas.height = window.innerHeight / quality;
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                parameters.screenWidth = canvas.width;
                parameters.screenHeight = canvas.height;
                computeSurfaceCorners();
                gl.viewport(0, 0, canvas.width, canvas.height);
                createRenderTargets();
            }
            var old_pixels = null;
            var new_pixels = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);

            // https://www.opengl.org/sdk/docs/man/html/glReadPixels.xhtml
            // glReadPixels and glReadnPixels return values from each pixel
            // with lower left corner at (x+i,y+j) for 0<=i<width and
            // 0<=j<height. This pixel is said to be the ith column in the
            // jth row. Pixels are returned in row order from the lowest to
            // the highest row, left to right in each row.

            var value_threshold = 0.75;
            var instrument_count = 3;
            var range = 72;
            var bass = 24;
            var dynamic_range = 20;
            var softest = 40;
            var maximum_value = 0;

            /**
             * Converts an RGB color value to HSV. Conversion formula
             * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
             * Assumes r, g, and b are contained in the set [0, 255] and
             * returns h, s, and v in the set [0, 1].
             *
             * @param   Number  r       The red color value
             * @param   Number  g       The green color value
             * @param   Number  b       The blue color value
             * @return  Array           The HSV representation
             */
            var rgb_to_hsv = function(r, g, b){
                r = r / 255;
                g = g / 255;
                b = b / 255;
                var max = Math.max(r, g, b);
                var min = Math.min(r, g, b);
                var h, s, v = max;
                var d = max - min;
                s = max === 0 ? 0 : d / max;
                if (max == min){
                    h = 0;
                } else {
                    // More efficient than switch?
                    if        (max == r) {
                        h = (g - b) / d + (g < b ? 6 : 0);
                    } else if (max == g) {
                        h = (b - r) / d + 2;
                    } else if (max == b) {
                        h = (r - g) / d + 4;
                    }
                    h /= 6;
                }
                return [h, s, v];
            }

            var create_on_event = function(score, x, y, h, v) {
               var insno = (x / gl.drawingBufferWidth) * instrument_count + 1;
               var key = Math.floor((y / gl.drawingBufferHeight) * range + bass);
               var velocity = Math.floor(v * dynamic_range + softest);
               var pan = Math.floor(v * dynamic_range + softest);
               insno = insno + key / range;
               score.add(0, -1, 144.0, insno, key, velocity, pan);
            }

            var create_off_event = function(score, x, y, h, v) {
               var insno = - ((x / gl.drawingBufferWidth) * instrument_count + 1);
               var key = Math.floor((y / gl.drawingBufferHeight) * range + bass);
               var velocity = Math.floor(v * dynamic_range + softest);
               var pan = Math.floor(v * dynamic_range + softest);
               insno = insno + key / range;
               score.add(0, -1, 144.0, insno, key, velocity, pan);
            }

            var send_events = function() {
               score.clear();
               maximum_value = 0;
               var old_hsv;
               var new_hsv;
               // By row from bottom (0) to top (height - 1).
               var row_stride = Math.floor(gl.drawingBufferHeight / range);
               var column_stride = Math.floor(gl.drawingBufferWidth / instrument_count);
               for (var row_index = 0; row_index < gl.drawingBufferHeight; row_index += row_stride) {
                  // By column from left (0) to right (width - 1).
                  for (var column_index = 0; column_index < gl.drawingBufferWidth; column_index += column_stride) {
                     var i = 4 * (row_index * gl.drawingBufferHeight + column_index);
                     old_hsv = rgb_to_hsv(old_pixels[i + 0], old_pixels[i + 1], old_pixels[i + 2], old_pixels[i + 3]);
                     new_hsv = rgb_to_hsv(new_pixels[i + 0], new_pixels[i + 1], new_pixels[i + 2], new_pixels[i + 3]);
                     if (new_hsv[2] > maximum_value) {
                        maximum_value = new_hsv[2];
                     }
                     if (isNaN(new_hsv[2]) || isNaN(old_hsv[2])) {                                //
                        alert('Indexing is wrong: isNaN for:' + new_hsv + ' or ' + old_hsv);
                     }
                     // On event.
                     if ((old_hsv[2] < value_threshold) && (new_hsv[2] >= value_threshold)) {
                        create_on_event(score, column_index, row_index, new_hsv[0], new_hsv[2]);
                     }
                     // Off event.
                     if ((old_hsv[2] >= value_threshold) && (new_hsv[2] < value_threshold)) {
                        create_off_event(score, column_index, row_index, new_hsv[0], new_hsv[2]);
                     }
                  }
               }
               score.temper();
               ChordSpace.conformScoreToChord(score, chord, false);
               score.sendToCsound(csound);
            }

            function render() {
                if (!currentProgram) return;
                parameters.time = Date.now() - parameters.startTime;
                // Set uniforms for custom shader
                gl.useProgram(currentProgram);
                gl.uniform1f(currentProgram.uniformsCache.time, parameters.time / 1000);
                ///gl.uniform2f(currentProgram.uniformsCache['mouse'], parameters.mouseX, parameters.mouseY);
                gl.uniform2f(currentProgram.uniformsCache.mouse, surface.lastX, surface.lastY);
                gl.uniform2f(currentProgram.uniformsCache.resolution, parameters.screenWidth, parameters.screenHeight);
                gl.uniform1i(currentProgram.uniformsCache.backbuffer, 0);
                gl.uniform2f(currentProgram.uniformsCache.surfaceSize, surface.width, surface.height);
                gl.bindBuffer(gl.ARRAY_BUFFER, surface.buffer);
                gl.vertexAttribPointer(surface.positionAttribute, 2, gl.FLOAT, false, 0, 0);
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.vertexAttribPointer(vertexPosition, 2, gl.FLOAT, false, 0, 0);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, backTarget.texture);
                // Render custom shader to front buffer
                gl.bindFramebuffer(gl.FRAMEBUFFER, frontTarget.framebuffer);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                // Set uniforms for screen shader
                gl.useProgram(screenProgram);
                gl.uniform2f(screenProgram.uniformsCache.resolution, parameters.screenWidth, parameters.screenHeight);
                gl.uniform1i(screenProgram.uniformsCache.texture, 1);
                gl.bindBuffer(gl.ARRAY_BUFFER, buffer);
                gl.vertexAttribPointer(screenVertexPosition, 2, gl.FLOAT, false, 0, 0);
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, frontTarget.texture);
                // Render front buffer to screen
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                old_pixels = new_pixels.slice();
                // Use pixel buffer objects here?
                gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, new_pixels);
                send_events();
            }

            function animate() {
                requestAnimationFrame(animate);
                render();
            }

            var gui = null;
            var default_json = {
            "remembered": {
            "Default": {
            "0": {
            "gk_overlap": 2.8396989919068556,
            "gk_Reverb_Feedback": 0.8962799943206012,
            "gk_Reverb2_Feedback": 0.8519096975720566,
            "gk_MasterOutput_level": 16.32429797719947,
            "gk_FM_Clang_preset": 9,
            "gk_FM_Clang_level": 6,
            "gk_Blower_grainDensity": 0.15,
            "gk_Blower_grainDuration": 0.2,
            "gk_Blower_grainAmplitudeRange": 0.1,
            "gk_Blower_grainFrequencyRange": 0.033,
            "gk_Blower_level": 0.5,
            "gk_Bower_pressure": 0.2,
            "gk_Bower_level": -2,
            "gk_Buzzer_Harmonics": 15,
            "gk_Buzzer_level": 0.5,
            "gk_Droner_partial1": 0.05,
            "gk_Droner_partial2": 0.4,
            "gk_Droner_partial3": 0.1,
            "gk_Droner_partial4": 0.1,
            "gk_Droner_partial5": 0.25,
            "gk_Droner_level": 2.485784659335444,
            "gk_Harpsichord_pick": 0.2563797350132311,
            "gk_Harpsichord_reflection": 0.8149206707351692,
            "gk_Harpsichord_pluck": 0.75,
            "gk_Harpsichord_level": -6,
            "gk_Phaser_ratio1": 1,
            "gk_Phaser_ratio2": 0.5040504050405045,
            "gk_Phaser_index1": 1,
            "gk_Phaser_index2": 0.30603060306030627,
            "gk_Phaser_level": 0.125,
            "gk_Piano_level": -19,
            "gk_Shiner_level": 3.2043204320432395,
            "gk_Sweeper_britel": 1.2452729986356939,
            "gk_Sweeper_briteh": 0.5860108228873854,
            "gk_Sweeper_britels": 2.4905459972713877,
            "gk_Sweeper_britehs": 1.25,
            "gk_Sweeper_level": 1.0207576021169729,
            "gk_YiString_reverb_send": 0.5,
            "gk_YiString_chorus_send": 0.5,
            "gk_YiString_level": 0
            }
            },
            "undefined": {
            "0": {
            "gk_overlap": 1,
            "gk_Reverb_Feedback": 0.83,
            "gk_Reverb2_Feedback": 0.7,
            "gk_MasterOutput_level": 27,
            "gk_FM_Clang_preset": 9.460531255436628,
            "gk_FM_Clang_level": -6.049188283446092,
            "gk_Blower_grainDensity": 150.60932492125144,
            "gk_Blower_grainDuration": 0.03214223397709634,
            "gk_Blower_grainAmplitudeRange": 168.47811158012328,
            "gk_Blower_grainFrequencyRange": 36.62567643046158,
            "gk_Blower_level": -31.68716178476921,
            "gk_Bower_pressure": 0.29,
            "gk_Bower_level": -22.419675313378438,
            "gk_Buzzer_Harmonics": 6.0432366110261615,
            "gk_Buzzer_level": -41.759222803146145,
            "gk_Droner_partial1": 0.05,
            "gk_Droner_partial2": 0.4,
            "gk_Droner_partial3": 0.1,
            "gk_Droner_partial4": 0.1,
            "gk_Droner_partial5": 0.25,
            "gk_Droner_level": -46.33743235695384,
            "gk_Harpsichord_pick": 0.36625676430461584,
            "gk_Harpsichord_reflection": 0.3296314286119785,
            "gk_Harpsichord_pluck": 0.15565912482946173,
            "gk_Harpsichord_level": -45,
            "gk_Phaser_ratio1": 1.684781115801233,
            "gk_Phaser_ratio2": 0.5040504050405045,
            "gk_Phaser_index1": 1,
            "gk_Phaser_index2": 0.3296310878741543,
            "gk_Phaser_level": -20.69945885563073,
            "gk_Piano_level": -31,
            "gk_Shiner_level": -40,
            "gk_Sweeper_britel": 1.2452729986356939,
            "gk_Sweeper_briteh": 0.5860108228873854,
            "gk_Sweeper_britels": 1.6115297629403098,
            "gk_Sweeper_britehs": 1.25,
            "gk_Sweeper_level": -30.771519874007666,
            "gk_YiString_reverb_send": 0.6958878521787701,
            "gk_YiString_chorus_send": 0.6226364993178469,
            "gk_YiString_level": -27
            }
            }
            },
            "closed": false,
            "folders": {
            "Master effects": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Instruments": {
            "preset": "Default",
            "closed": false,
            "folders": {
            "FM Clang": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Blower": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Bower": {
            "preset": "Default",
            "closed": true,
            "folders": {}
            },
            "Buzzer": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Droner": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Harpsichord": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Phaser": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Piano": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Shiner": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Sweeper": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "YiString": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            }
            }
            }
            },
            "preset": "undefined"
            };
            window.onload = function() {
                try {
                    var temporary_json = Silencio.restoreDatGuiJson(default_json);
                    default_json = temporary_json;
                } catch(e) {
                }
                gui = new dat.GUI({load: default_json, width: 300});
                gui.remember(parameters);
                gui.add(parameters, 'Play').name('Play [Ctrl-P]');
                gui.add(parameters, 'Stop').name('Stop [Ctrl-S]');
                gui.add(parameters, 'Developer_tools').name('Debugger');
                gui.add(parameters, 'Close').name('Close').name('Exit [Ctrl-X]');
                var Master = gui.addFolder('Master effects');
                add_slider(Master, 'gk_overlap', 0, 20);
                add_slider(Master, 'gk_Reverb_Feedback', 0, 1);
                add_slider(Master, 'gk_Reverb2_Feedback', 0, 1);
                add_slider(Master, 'gk_MasterOutput_level', -40, 40);
                var intruments = gui.addFolder('Instruments');
                var fmclang = intruments.addFolder('FM Clang');
                add_slider(fmclang, 'gk_FM_Clang_preset', 1, 13);
                add_slider(fmclang, 'gk_FM_Clang_level', -40, 40);
                var Harpsichord = intruments.addFolder('Harpsichord');
                add_slider(Harpsichord, 'gk_Harpsichord_level', -40, 40);
                var Piano = intruments.addFolder('Piano');
                add_slider(Piano, 'gk_Piano_level', -40, 40);
                var Chords = gui.addFolder('Chords and transformations');
                Chords.add(parameters, 'Bb7');
                Chords.add(parameters, 'FM9');
                Chords.add(parameters, 'K').name('K() [Ctrl-K]');
                Chords.add(parameters, 'Q2').name('Q(2)');
                Chords.add(parameters, 'Q3').name('Q(3) [Ctrl-Q]');
                Chords.add(parameters, 'Q5').name('Q(5)');
                Chords.add(parameters, 'J2_2').name('J(2,2)');
                Chords.add(parameters, 'J2_3').name('J(2,3)');
                Chords.add(parameters, 'J3_1').name('J(3,1)');
                Chords.add(parameters, 'T5').name('D() [Ctrl-D]');
                gui.revert();
            };
            function gk_update(name, value) {
                if (typeof csound !== 'undefined') {
                    var numberValue = parseFloat(value);
                    csound.setControlChannel(name, numberValue);
                    csound.message(name + ': ' + numberValue + '\n');
                }
            }
            function add_slider(gui_folder, token, minimum, maximum) {
                var on_parameter_change = function(value) {
                    if (token.startsWith('gk_')) {
                        gk_update(token, value);
                    }
                };
                var slider = gui_folder.add(parameters, token, minimum, maximum);
                slider.onChange(on_parameter_change);
                return slider;
            };
            function logMessage(message) {
                console.log(message);
            }
            // Used to find out what actually happens when a key is pressed.
            function printKey(e) {
              e = e || event;
              //if (document.forms.keyform[e.type + 'Ignore'].checked) return
              var evt = e.type;
              while (evt.length < 10) evt += ' ';
              var data = evt +
                ' keyCode=' + e.keyCode +
                ' which=' + e.which +
                ' charCode=' + e.charCode +
                ' char=' + String.fromCharCode(e.keyCode || e.charCode) +
                (e.shiftKey ? ' +shift' : '') +
                (e.ctrlKey ? ' +ctrl' : '') +
                (e.altKey ? ' +alt' : '') +
                (e.metaKey ? ' +meta' : '') + '\n';
              logMessage(data);
            }
            // The 'keydown' event is used for key bindings.
            $(document).on("keydown", function (e) {
                //printKey(e);
                var e_char = String.fromCharCode(e.keyCode || e.charCode);
                if (e.ctrlKey === true) {
                    if        (e_char === 'H') {
                        $("#statistics").toggle();
                        gui.toggle();
                    } else if (e_char === 'K') {
                        parameters.K();
                    } else if (e_char === 'Q') {
                        parameters.Q3();
                    } else if (e_char === 'D') {
                        parameters.T5();
                    } else if (e_char === 'T') {
                        chord = chord.T(2);
                    } else if (e_char === 'P') {
                        parameters.Play();
                    } else if (e_char === 'S') {
                        parameters.Stop();
                    } else if (e_char === 'X') {
                        parameters.Close();
                    }

                } else if (e.altKey === true) {
                    var sign = -1;
                    if (e.shiftKey === true) {
                        sign = 1;
                    }
                }
                return false;
             });
            } catch (err) {
                alert(err);
                console.log(err.message);
            }
        </script>
    </body>
</html>
