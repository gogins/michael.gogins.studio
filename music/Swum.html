<!DOCTYPE html>
<html>
    <head>
        <title>Swum</title>
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <!-- <script data-main="silencio/js" src="silencio/js/require.js"></script> -->
        <script src="silencio/js/system.js"></script>
        <script src="csound_samples.js"></script>
        <script src="csound_extended.js"></script> 
        <script src="CsoundAudioNode.js"></script>
        <script src="csound_loader.js"></script>
        <script src="silencio/js/Silencio.js"></script>
        <script src="silencio/js/ChordSpace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.1/dat.gui.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sprintf/1.1.1/sprintf.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/91/three.js"></script>
        <script src="silencio/js/clubber.js"></script>
        <script src="silencio/js/flame.js"></script>
        <style>
            ::-webkit-scrollbar
            {
            width:10px;
            }
            ::-webkit-scrollbar-track-piece
            {
            background-color:transparent;
            }
            ::-webkit-scrollbar-corner
            {
            background-color:transparent;
            }
        .dg {
            font-family: Monaco, sans-serif;
            font-size:8pt;
            }
        </style>
    </head>
    <body style="background:black;">
        <div id = 'webgl_cell' class='canvas' style="width:98vw;height:98vh;"/>
        <table id = 'statistics' style="table-layout:fixed;position:absolute;left:1vw;color:#eee;top:1vw;font-family:Monaco, sans-serif;font-size:8pt;">
            <col width=400px>
            <col width=208px>
            <tr style="color:gold;">
                <!-- Copyright (C) 2016 by Michael Gogins -->
                <td><b><i>Swum</i></b>, for Csound+HTML5</td>
                <td style="text-align:right;">Michael Gogins</td>
            <tr>
                <td colspan="2" style="color:gold;text-align:left">Click "Play"; if you don't hear sound, adjust "Master effects" group "gk_MasterOutput_level" slider and some instrument level sliders, click "Save", click "Revert."</td>
            </tr>
            </tr>
            <tr>
                <td>Time:</td>
                <td id="Time_cell" style="text-align:right;color:LawnGreen;font-weight:bold;">0</td>
            </tr>
            <tr>
                <td>Chord: </td>
                <td id="Chord_cell" style="color:SkyBlue;text-align:right;"></td>
            </tr>
            <tr>
                <td>Notes: </td>
                <td id="Notes_cell" style="color:SkyBlue;text-align:right;"></td>
            </tr>
            <tr id='messages'>
                <td colspan="2"><textarea id="console" style="width:100%;color:SkyBlue;background-color:transparent;border:none;text-align:left;height:200px;overflow:auto;padding:0;margin:0;border-collapse:collapse;font-family:Courier, sans-serif;font-size:9pt;"></textarea></td>
            </tr>
        </table>
        <textarea class="code" id="csd" hidden rows=24 cols=80>
<CsoundSynthesizer>
<CsLicense>
Copyright (C) 2018 by Michael Gogins.
All rights reserved.
</CsLicense>
<CsOptions>
-odac -m35 -d
</CsOptions>
<CsInstruments>
sr = 48000
ksmps = 128
nchnls = 2
nchnls_i = 1
0dbfs = 10000

#define USE_SPATIALIZATION #1#

gShelp init {{
S P A T I A L I Z E

Copyright (c) 2014 by Michael Gogins.
This software is licensed under the terms of the
GNU Lesser Public License.

Many thanks to Jan Jacob Hofmann for his advanced Csound
spatialization system, which I have adapted here.

This software is a system of Ambisonic and/or HRTF-based
audio spatialization for Csound. I have simplified Hofmann's
excellent code by avoiding all Csound macros, and instead
using user-defined opcodes along with the signal flow graph
opcodes that send and receive signals using audio-rate array
variables.

If a single source fans out to one or more sinks, the sinks are opcodes.
If multiple sources fan in to a single sink, the sources are instr outlets
and the sink is an instr inlet.

The available apeaker rigs are:

 0 Ambisonic stereo with minimal distance cues
 (possibly the best choice for efficiency in live performance).
 1 Ambisonic binaural with HRTF decoding (periphonic, a suitable choice
   for checking in stereophonic studio work).
 2 Ambisonic quadraphonic.
 3 Ambisonic pentaphonic or 5.0 (might work for 5.1, omit .1)
 4 Ambisonic octaphonic.
 5 Ambisonic cubic (periphonic, probably the best choice for concerts).

Please note the coordinate conventions. The listener is always the origin.
In this system, spatial locations are passed to the spatialize opcode in
Cartesian coordinates. These are the same as those used in physics:

-- x runs from ahead to behind.
-- y runs from left to right. This is the same as stereo pan.
-- z runs from below to above.

Spherical coordinates are more or less standard for Ambisonics, and are
similar to but not identical with those used in physics. The only differences
are that Ambisonics uses elevation but physics uses inclination, and
Ambisonics uses degrees but physics uses radians.

-- r is distance.
-- azimuth or theta is anti-clockwise angle from 0 in front of the listener.
-- elevation or phi is angle above or below the x-y plane. (Note that
   inclination, also called polar angle, would be angle away from the
   zenith pole.)

USAGE

In the orchestra header:

gk_BformatDecoder_SpeakerRig init 5

alwayson SpatialReverb
alwayson Bformat3Decoder

connect "SpatializingInstrument", "out", "SpatialReverb", "in"
connect "SpatializingInstrument", "outbformat", "Bformat3Decoder", "inbformat"
connect "SpatialReverb", "outbformat", "Bformat3Decoder", "inbformat"

instr SpatializingInstrument
absignal[] init 16
asignal STKBlowBotl cpsmidinn(p4), 1, 4, kv1, 11, 10, 1, 50, 128
absignal, asend Spatializer asignal, 87, 15, 15
; Send a signal with only distance cues to the global spatial reverb instr.
outleta "out", asend
; Send the spatialized signal to the global Ambisonc decoder instr.
outletv "outbformat", absignal
endin

TODO

-- Upgrade demonstration piece with jspline spatial trajectories
   and algorithmically generated percussive notes.

-- Plug in and test early reflections code.

-- Test with rigs 2 through 5.

-- See if babo can be adapted for spatial reverb.

-- Upgrade panning with arbitrary measured speaker positions.

-- Try spat3d for global reverb and early reflections (not doing,
   as not periphonic).

}}

prints gShelp

; Global parameters that can be re-defined in the orchestra header.

gk_Spatialize_Verbose init 0
gk_BformatDecoder_SpeakerRig init 5
gk_Spatialize_SpeakerRigRadius init 5.0

opcode CartesianToPolar, kkk, kkk
kx, ky, kz xin
; Calculate the distance from the origin (the listener).
kdistance = sqrt(kx^2 + ky^2 + kz^2)
; Normalize the coordinates to unit vectors from the origin.
kx = kx / kdistance
ky = ky / kdistance
kz = kz / kdistance
; Limit distance to prevent too close a sound becoming too loud.
kdistance = (kdistance < 0.3 ? 0.3 : kdistance)
; Calculate the elevation.
kelevation = cosinv(sqrt(1 - kz^2))
; If z is negative, make elevation negative also.
kelevation = (kz < 0 ? -kelevation : kelevation)
; Calculate the angle.
kangle = sininv(ky / cos(kelevation))
; Distinguish between positive x and negative x.
kangle = (kx >= 0 ? kangle : 3.14159265 - kangle)
; Distinguish between positive and negative y and x.
kangle = (ky <= 0 && kx >= 0 ? 6.28318531 + kangle : kangle)
xout kangle, kelevation, kdistance
endop

opcode CartesianToPolarDegrees, kkk, kkk
kx, ky, kz xin
; Calculate the distance from the origin (the listener).
kdistance = sqrt(kx^2 + ky^2 + kz^2)
; Normalize the coordinates to unit vectors from the origin.
kx = kx / kdistance
ky = ky / kdistance
kz = kz / kdistance
; Limit distance to prevent too close a sound becoming too loud.
kdistance = (kdistance < 0.3 ? 0.3 : kdistance)
; Calculate the elevation.
kelevation = cosinv(sqrt(1 - kz^2))
; If z is negative, make elevation negative also.
kelevation = (kz < 0 ? -kelevation : kelevation)
; Calculate the angle.
kangle = sininv(ky / cos(kelevation))
; Distinguish between positive x and negative x.
kangle = (kx >= 0 ? kangle : 3.14159265 - kangle)
; Distinguish between positive and negative y and x.
kangle = (ky <= 0 && kx >= 0 ? 6.28318531 + kangle : kangle)
kangle = kangle * 57.295779513
kelevation = kelevation * 57.295779513
xout kangle, kelevation, kdistance
endop

; Zero distance blows this up.
gk_DopplerByDistance_Mach init 340.29
opcode DopplerByDistance, a, ak
asignal, kdistance xin
; ashifted doppler asource, ksourceposition, kmicposition [, isoundspeed, ifiltercutoff]
adopplered doppler asignal, kdistance * gk_Spatialize_SpeakerRigRadius, 0, i(gk_DopplerByDistance_Mach), 6
xout adopplered
endop

; Zero distance blows this up.
opcode LowpassByDistance, a, ak
asignal, kdistance xin
afiltered butterlp asignal, 22000 * sqrt(1.0 / kdistance)
abalanced balance afiltered, asignal
xout abalanced
endop

opcode ReverbSC, a, akkkk
asignal, kReverbFeedback, kDelayModulation, kReverbWet, itone xin
; p4 = gain of reverb. Adjust empirically
; for desired reverb time. .6 gives
; a good small "live" room sound, .8
; a small hall, .9 a large hall,
; .99 an enormous stone cavern.

; p5 = amount of random pitch modulation
; for the delay lines. 1 is the "normal"
; amount, but this may be too high for
; held pitches such as piano tones.
; Adjust to taste.

; p6 = cutoff frequency of lowpass filters
; in feedback loops of delay lines,
; in Hz. Lower cutoff frequencies results
; in a sound with more high-frequency
; damping.

; 8 delay line FDN reverb, with feedback matrix based upon
; physical modeling scattering junction of 8 lossless waveguides
; of equal characteristic impedance. Based on Julius O. Smith III,
; "A New Approach to Digital Reverberation using Closed Waveguide
; Networks," Proceedings of the International Computer Music
; Conference 1985, p. 47-53 (also available as a seperate
; publication from CCRMA), as well as some more recent papers by
; Smith and others.
; Coded by Sean Costello, October 1999
afilt1 init 0
afilt2 init 0
afilt3 init 0
afilt4 init 0
afilt5 init 0
afilt6 init 0
afilt7 init 0
afilt8 init 0
idel1 = (2473.000/sr)
idel2 = (2767.000/sr)
idel3 = (3217.000/sr)
idel4 = (3557.000/sr)
idel5 = (3907.000/sr)
idel6 = (4127.000/sr)
idel7 = (2143.000/sr)
idel8 = (1933.000/sr)
; k1-k8 are used to add random pitch modulation to the
; delay lines. Helps eliminate metallic overtones
; in the reverb sound.
ak1 randi .001, 3.1, .06
ak2 randi .0011, 3.5, .9
ak3 randi .0017, 1.11, .7
ak4 randi .0006, 3.973, .3
ak5 randi .001, 2.341, .63
ak6 randi .0011, 1.897, .7
ak7 randi .0017, 0.891, .9
ak8 randi .0006, 3.221, .44
; apj is used to calculate "resultant junction pressure" for
; the scattering junction of 8 lossless waveguides
; of equal characteristic impedance. If you wish to
; add more delay lines, simply add them to the following
; equation, and replace the .25 by 2/N, where N is the
; number of delay lines.
apj = .25 * (afilt1 + afilt2 + afilt3 + afilt4 + afilt5 + afilt6 + afilt7 + afilt8)
adum1 delayr 1
adel1 deltapi idel1 + ak1 * kDelayModulation
 delayw asignal + apj - afilt1
adum2 delayr 1
adel2 deltapi idel2 + ak2 * kDelayModulation
 delayw asignal + apj - afilt2
adum3 delayr 1
adel3 deltapi idel3 + ak3 * kDelayModulation
 delayw asignal + apj - afilt3
adum4 delayr 1
adel4 deltapi idel4 + ak4 * kDelayModulation
 delayw asignal + apj - afilt4
adum5 delayr 1
adel5 deltapi idel5 + ak5 * kDelayModulation
 delayw asignal + apj - afilt5
adum6 delayr 1
adel6 deltapi idel6 + ak6 * kDelayModulation
 delayw asignal + apj - afilt6
adum7 delayr 1
adel7 deltapi idel7 + ak7 * kDelayModulation
 delayw asignal + apj - afilt7
adum8 delayr 1
adel8 deltapi idel8 + ak8 * kDelayModulation
 delayw asignal + apj - afilt8
; 1st order lowpass filters in feedback
; loops of delay lines.
afilt1 tone adel1 * kReverbFeedback, itone
afilt2 tone adel2 * kReverbFeedback, itone
afilt3 tone adel3 * kReverbFeedback, itone
afilt4 tone adel4 * kReverbFeedback, itone
afilt5 tone adel5 * kReverbFeedback, itone
afilt6 tone adel6 * kReverbFeedback, itone
afilt7 tone adel7 * kReverbFeedback, itone
afilt8 tone adel8 * kReverbFeedback, itone
; The outputs of the delay lines are summed
; and sent to the stereo outputs. This could
; easily be modified for a 4 or 8-channel
; sound system.
aout1 = (afilt1 + afilt3 + afilt5 + afilt7)
aout2 = (afilt2 + afilt4 + afilt6 + afilt8)
aoutput = aout1 + aout2
aoutwet = aoutput * kReverbWet
aoutdry = aoutput * (1 - kReverbWet)
aoutput = aoutwet + aoutdry
xout aoutput
endop

gk_LocalReverbByDistance_Wet init 0.2
; This is a fraction of the speaker rig radius.
gk_LocalReverbByDistance_FrontWall init 0.9
gk_LocalReverbByDistance_ReverbDecay init 0.6
gk_LocalReverbByDistance_CutoffHz init sr
gk_LocalReverbByDistance_RandomDelayModulation init 1.0
opcode LocalReverbByDistance, aa, ak
; Re-implemented from Dodge and Jerse.
asignal, kdistanceMeters xin
kdry = 1.0 - gk_LocalReverbByDistance_Wet
knormalizedDistance = kdistanceMeters / gk_Spatialize_SpeakerRigRadius
klocalAttenuation = 1.0 / knormalizedDistance
kglobalAttenuation = 1.0 / sqrt(knormalizedDistance)
alocalReverbSend = asignal * klocalAttenuation
aglobalReverbSend = asignal * kglobalAttenuation
iechoMeters = 2.0 * i(gk_Spatialize_SpeakerRigRadius) * i(gk_LocalReverbByDistance_FrontWall)
isecondsPerMeter = 1.0 / i(gk_DopplerByDistance_Mach)
imillisecondsPerMeter = isecondsPerMeter * 1000.0
iglobalReverbSendDelayMilliseconds = i(gk_Spatialize_SpeakerRigRadius) * i(gk_LocalReverbByDistance_FrontWall) * imillisecondsPerMeter
; print iglobalReverbSendDelayMilliseconds
aglobalReverbSendDelayed delay aglobalReverbSend, iglobalReverbSendDelayMilliseconds
alocalReverbLeft, alocalReverbRight reverbsc	alocalReverbSend, alocalReverbSend, gk_LocalReverbByDistance_ReverbDecay, gk_LocalReverbByDistance_CutoffHz, sr, i(gk_LocalReverbByDistance_RandomDelayModulation), 1
alocalReverbWet = ((alocalReverbLeft + alocalReverbRight) / 2.0) * gk_LocalReverbByDistance_Wet
alocalReverbDry = kdry * asignal
alocalReverberatedSignal = alocalReverbDry + alocalReverbWet
if gk_Spatialize_Verbose != 0 then
printks "LocalReverbByDistance asignal: %9.4f klocalAttentuaton: %9.4f iglobalReverbSendDelayMilliseconds: %9.4f kglobalAttenuation: %9.4f alocalReverberatedSignal: %9.4f aglobalReverbSend: %9.4f\n", 0.5, asignal, klocalAttenuation, iglobalReverbSendDelayMilliseconds, kglobalAttenuation, alocalReverberatedSignal, aglobalReverbSendDelayed
endif
xout alocalReverberatedSignal, aglobalReverbSendDelayed
endop

; Switch on/off diffuse reflections [0=off, 1=on] and adjust gain of reflection (e.g.: 1= normal gain, 2= twice as loud, 0.5 = half as loud).
gk_EarlyReflection_diffref init 0 * 0
; Switch on/off specular reflections [0=off, 1=on] and adjust gain of reflection (e.g.: 1= normal gain, 2= twice as loud, 0.5 = half as loud).
gk_EarlyReflection_specref init 0 * 0
; Position of FrontWall at the x-axis [units] for calculation of early reflections.
gk_EarlyReflection_FrontWall init 1.6
; Position of SideWall at the y-axis [units] for calculation of early reflections.
gk_EarlyReflection_SideWall init 1.3
; Height of the Ceiling measured from the zero-point of the coordinate-system [units] for calculation of early reflections.
gk_EarlyReflection_Ceiling init 1.1
; Damping factor of the reflecting surface (gain of reverb).
gk_EarlyReflection_damp init 0.1
; Absorbtion characteristics of the wall in respect to high frequencies: frequencies above ihighdamp get filtered out.
gk_EarlyReflection_highdamp init 15000
; Low frequency boost for sources near a wall.
gk_EarlyReflection_lfboost init 1
opcode DiffuseEarlyReflection, a[], akkki
asignal, kx, ky, kz, iwhichwall xin
if iwhichwall == 1 then
 krefx = gk_EarlyReflection_FrontWall
else
 krefx = kx
endif
if iwhichwall == 2 then
 krefx = -gk_EarlyReflection_FrontWall
else
 krefx = kx
endif
if iwhichwall == 3 then
 kfefy = gk_EarlyReflection_SideWall
else
 krefy = ky
endif
if iwhichwall == 4 then
 krefy = -gk_EarlyReflection_SideWall
else
 krefy = ky
endif
if iwhichwall == 5 then
 krefz = gk_EarlyReflection_Ceiling
else
 krefz = kz
endif
if iwhichwall == 6 then
 krefz = -gk_EarlyReflection_Ceiling
else
 krefz = kz
endif
kA, kE, kD CartesianToPolar kx, ky, kz
kAref, kEref, kDref CartesianToPolar krefx, krefy, krefz
kDdiff = sqrt((kx - krefx)^2 + (ky-krefy)^2 + (kz - krefz)^2)
kDist = kDdiff + kDref
; Convert to meters.
kDmtr = kDist * gk_Spatialize_SpeakerRigRadius
; Delay time in milliseconds.
kdel = kDmtr / 0.345
; Reflection behind the source
kAdist = abs(kA - kAref)
kEdist = abs(kE - kEref)
; Reduce the angle kAdist to values between 0 and 2 pi.
kAdist = (kAdist > 6.2831 ? kAdist - 6.2831 : kAdist)
kmute = kAdist + kEdist
; Mute the reflection if it gets behind the source.
kmute = (kmute < 1.5707 ? sin(kmute) : 1)
; Attenuate the early reflection by distance.
k_gain = 1 / kDist * gk_EarlyReflection_damp * kmute
; Cut high frequencies by distance.
kDdiff = ( kDdiff < 0.05 ? 0.05 : kDdiff)
klfboost = (sqrt(1 / kDdiff ) + kD) * gk_EarlyReflection_lfboost
afilt tone asignal, (sqrt(1 / kDist)) * sr
; Boost low frequencies near the wall.
afilt pareq afilt, 174, klfboost, 0.7071, 1
afilt balance afilt, asignal
adel interp kdel
asigref vdelay3 afilt, adel, 200 ; milliseconds
asigref = asigref * k_gain
; Convert radians to degrees.
kAref = kAref * 57.2958
kEref = kEref * 57.2958
absignal[] init 16
absignal bformenc1 asigref, kAref, kEref
xout absignal
endop

opcode DiffuseEarlyReflections, a[], akkk
asignal, kx, ky, kz xin
; Filter high frequencies to represent absorbtion by the wall.
asignal tone asignal, gk_EarlyReflection_highdamp
absignal[] init 16
abreflectedSignal[] init 16
; Bounce the signal off each of the walls.
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 1
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 2
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 3
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 4
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 5
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal DiffuseEarlyReflection asignal, kx, ky, kz, 6
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
xout absignal
endop

opcode SpecularEarlyReflection, a[], akkkik
asignal, kx, ky, kz, iwhichwall, kmydiff xin
ksum = abs(iwhichwall) + abs(kmydiff)
krefx = (kx / ksum) * abs(iwhichwall)
krefy = (ky / ksum) * abs(iwhichwall)
krefz = (kz / ksum) * abs(iwhichwall)
krefx = (iwhichwall = 1 ? gk_EarlyReflection_FrontWall : (kx / ksum) * abs(iwhichwall))
krefx = (iwhichwall = 2 ? -gk_EarlyReflection_FrontWall : (kx / ksum) * abs(iwhichwall))
krefy = (ky / ksum) * abs(iwhichwall)
krefz = (kz / ksum) * abs(iwhichwall)
if iwhichwall == 1 then
 krefx = gk_EarlyReflection_FrontWall
else
 krefx = kx
endif
if iwhichwall == 2 then
 krefx = -gk_EarlyReflection_FrontWall
else
 krefx = kx
endif
if iwhichwall == 3 then
 kfefy = gk_EarlyReflection_SideWall
else
 krefy = ky
endif
if iwhichwall == 4 then
 krefy = -gk_EarlyReflection_SideWall
else
 krefy = ky
endif
if iwhichwall == 5 then
 krefz = gk_EarlyReflection_Ceiling
else
 krefz = kz
endif
if iwhichwall == 6 then
 krefz = -gk_EarlyReflection_Ceiling
else
 krefz = kz
endif
; Prevent zero to prevent division by zero error (NaN) later.
krefx = (krefx < 0.001 && krefx > -0.001 ? 0.001 : krefx)
krefy = (krefy < 0.001 && krefy > -0.001 ? 0.001 : krefy)
krefz = (krefz < 0.001 && krefz > -0.001 ? 0.001 : krefz)
kA, kE, kD CartesianToPolar kx, ky, kz
kAref, kEref, kDref CartesianToPolar krefx, krefy, krefz
kDdiff = sqrt((kx - krefx)^2 + (ky-krefy)^2 + (kz - krefz)^2)
kDist = kDdiff + kDref
; Convert to meters.
kDmtr = kDist * gk_Spatialize_SpeakerRigRadius
; Delay time in milliseconds.
kdel = kDmtr / 0.345
; Reflection behind the source
kAdist = abs(kA - kAref)
kEdist = abs(kE - kEref)
; Reduce the angle kAdist to values between 0 and 2 pi.
kAdist = (kAdist > 6.2831 ? kAdist - 6.2831 : kAdist)
kmute = kAdist + kEdist
; Mute the reflection if it gets behind the source.
kmute = (kmute < 1.5707 ? sin(kmute) : 1)
; Attenuate the early reflection by distance.
k_gain = 1 / kDist * gk_EarlyReflection_damp * kmute
; Cut high frequencies by distance.
kDdiff = ( kDdiff < 0.05 ? 0.05 : kDdiff)
klfboost = (sqrt(1 / kDdiff ) + kD) * gk_EarlyReflection_lfboost
afilt tone asignal, (sqrt(1 / kDist)) * sr
; Boost low frequencies near the wall.
afilt pareq afilt, 174, klfboost, 0.7071, 1
afilt balance afilt, asignal
adel interp kdel
asigref vdelay3 afilt, adel, 200
asigref = asigref * k_gain
; Convert radians to degrees.
kAref = kAref * 57.2958
kEref = kEref * 57.2958
absignal[] init 16
absignal bformenc1 asigref, kAref, kEref
xout absignal
endop

opcode SpecularEarlyReflections, a[], akkk
asignal, kx, ky, kz xin
kiwall1 = gk_EarlyReflection_FrontWall
kiwall2 = -gk_EarlyReflection_FrontWall
kiwall3 = gk_EarlyReflection_SideWall
kiwall4 = -gk_EarlyReflection_SideWall
kiwall5 = gk_EarlyReflection_Ceiling
kiwall6 = -gk_EarlyReflection_Ceiling
kdiff1 = kiwall1 - kx ; distance of reflection to the FrontWall
kdiff2 = kiwall2 - kx ; distance of reflection to the backwall
kdiff3 = kiwall3 - ky ; distance of reflection to the left SideWall
kdiff4 = kiwall4 - ky ; distance of reflection to the right SideWall
kdiff5 = kiwall5 - kz ; distance of reflection to the Ceiling
kdiff6 = kiwall6 - kz ; distance of reflection to the floor
; Filter high frequencies to represent absorption by the walls.
afilteredSignal tone asignal, gk_EarlyReflection_highdamp
absignal[] init 16
abreflectedSignal[] init 16
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 1, kdiff1
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 2, kdiff2
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 3, kdiff3
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 4, kdiff4
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 5, kdiff5
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
abreflectedSignal SpecularEarlyReflection afilteredSignal, kx, ky, kz, 6, kdiff6
absignal[ 0] = absignal[ 0] + abreflectedSignal[ 0]
absignal[ 1] = absignal[ 1] + abreflectedSignal[ 1]
absignal[ 2] = absignal[ 2] + abreflectedSignal[ 2]
absignal[ 3] = absignal[ 3] + abreflectedSignal[ 3]
absignal[ 4] = absignal[ 4] + abreflectedSignal[ 4]
absignal[ 5] = absignal[ 5] + abreflectedSignal[ 5]
absignal[ 6] = absignal[ 6] + abreflectedSignal[ 6]
absignal[ 7] = absignal[ 7] + abreflectedSignal[ 7]
absignal[ 8] = absignal[ 8] + abreflectedSignal[ 8]
absignal[ 9] = absignal[ 9] + abreflectedSignal[ 9]
absignal[10] = absignal[10] + abreflectedSignal[10]
absignal[11] = absignal[11] + abreflectedSignal[11]
absignal[12] = absignal[12] + abreflectedSignal[12]
absignal[13] = absignal[13] + abreflectedSignal[13]
absignal[14] = absignal[14] + abreflectedSignal[14]
absignal[15] = absignal[15] + abreflectedSignal[15]
xout absignal
endop

opcode Spatialize, a[]a, akkk
asignal, kx, ky, kz xin
kazimuth, kelevation, kdistance CartesianToPolarDegrees kx, ky, kz
adoppleredSignal DopplerByDistance asignal, kdistance
afilteredSignal LowpassByDistance adoppleredSignal, kdistance
abspatializedSignal[] init 16
asend init 0
; Use only minimal distance cues for plain stereo.
if gk_BformatDecoder_SpeakerRig == 0 then
 abspatializedSignal bformenc1 afilteredSignal, kazimuth, kelevation
 asend = afilteredSignal
elseif gk_BformatDecoder_SpeakerRig == 1 then
 adistanceCuedSignal, aglobalReverbSend LocalReverbByDistance afilteredSignal, kdistance
 abspatializedSignal bformenc1 adistanceCuedSignal, kazimuth, kelevation
 asend = aglobalReverbSend
else
 adistanceCuedSignal, aglobalReverbSend LocalReverbByDistance afilteredSignal, kdistance
 abspatializedSignal bformenc1 adistanceCuedSignal, kazimuth, kelevation
 abdiffuseEarlyReflectionsSignal[] init 16
 abdiffuseEarlyReflectionsSignal DiffuseEarlyReflections adistanceCuedSignal, kx, ky, kz
 abspatializedSignal[ 0] = abspatializedSignal[ 0] + abdiffuseEarlyReflectionsSignal[ 0]
 abspatializedSignal[ 1] = abspatializedSignal[ 1] + abdiffuseEarlyReflectionsSignal[ 1]
 abspatializedSignal[ 2] = abspatializedSignal[ 2] + abdiffuseEarlyReflectionsSignal[ 2]
 abspatializedSignal[ 3] = abspatializedSignal[ 3] + abdiffuseEarlyReflectionsSignal[ 3]
 abspatializedSignal[ 4] = abspatializedSignal[ 4] + abdiffuseEarlyReflectionsSignal[ 4]
 abspatializedSignal[ 5] = abspatializedSignal[ 5] + abdiffuseEarlyReflectionsSignal[ 5]
 abspatializedSignal[ 6] = abspatializedSignal[ 6] + abdiffuseEarlyReflectionsSignal[ 6]
 abspatializedSignal[ 7] = abspatializedSignal[ 7] + abdiffuseEarlyReflectionsSignal[ 7]
 abspatializedSignal[ 8] = abspatializedSignal[ 8] + abdiffuseEarlyReflectionsSignal[ 8]
 abspatializedSignal[ 9] = abspatializedSignal[ 9] + abdiffuseEarlyReflectionsSignal[ 9]
 abspatializedSignal[10] = abspatializedSignal[10] + abdiffuseEarlyReflectionsSignal[10]
 abspatializedSignal[11] = abspatializedSignal[11] + abdiffuseEarlyReflectionsSignal[11]
 abspatializedSignal[12] = abspatializedSignal[12] + abdiffuseEarlyReflectionsSignal[12]
 abspatializedSignal[13] = abspatializedSignal[13] + abdiffuseEarlyReflectionsSignal[13]
 abspatializedSignal[14] = abspatializedSignal[14] + abdiffuseEarlyReflectionsSignal[14]
 abspatializedSignal[15] = abspatializedSignal[15] + abdiffuseEarlyReflectionsSignal[15]
 abspecularEarlyReflectionsSignal[] init 16
 abspecularEarlyReflectionsSignal SpecularEarlyReflections afilteredSignal, kx, ky, kz
 abspatializedSignal[ 0] = abspatializedSignal[ 0] + abspecularEarlyReflectionsSignal[ 0]
 abspatializedSignal[ 1] = abspatializedSignal[ 1] + abspecularEarlyReflectionsSignal[ 1]
 abspatializedSignal[ 2] = abspatializedSignal[ 2] + abspecularEarlyReflectionsSignal[ 2]
 abspatializedSignal[ 3] = abspatializedSignal[ 3] + abspecularEarlyReflectionsSignal[ 3]
 abspatializedSignal[ 4] = abspatializedSignal[ 4] + abspecularEarlyReflectionsSignal[ 4]
 abspatializedSignal[ 5] = abspatializedSignal[ 5] + abspecularEarlyReflectionsSignal[ 5]
 abspatializedSignal[ 6] = abspatializedSignal[ 6] + abspecularEarlyReflectionsSignal[ 6]
 abspatializedSignal[ 7] = abspatializedSignal[ 7] + abspecularEarlyReflectionsSignal[ 7]
 abspatializedSignal[ 8] = abspatializedSignal[ 8] + abspecularEarlyReflectionsSignal[ 8]
 abspatializedSignal[ 9] = abspatializedSignal[ 9] + abspecularEarlyReflectionsSignal[ 9]
 abspatializedSignal[10] = abspatializedSignal[10] + abspecularEarlyReflectionsSignal[10]
 abspatializedSignal[11] = abspatializedSignal[11] + abspecularEarlyReflectionsSignal[11]
 abspatializedSignal[12] = abspatializedSignal[12] + abspecularEarlyReflectionsSignal[12]
 abspatializedSignal[13] = abspatializedSignal[13] + abspecularEarlyReflectionsSignal[13]
 abspatializedSignal[14] = abspatializedSignal[14] + abspecularEarlyReflectionsSignal[14]
 abspatializedSignal[15] = abspatializedSignal[15] + abspecularEarlyReflectionsSignal[15]
 asend = aglobalReverbSend
endif
xout abspatializedSignal, asend
endop

gk_SpatialReverb_ReverbDecay init 0.6
gk_SpatialReverb_CutoffHz init sr
gk_SpatialReverb_RandomDelayModulation init 1.0

instr SpatialReverb2
; 12 delay line FDN reverb, with feedback matrix based upon
; physical modeling scattering junction of 12 lossless waveguides
; of equal characteristic impedance. Based on Julius O. Smith III,
; "A New Approach to Digital Reverberation using Closed Waveguide
; Networks," Proceedings of the International Computer Music
; Conference 1985, p. 47-53 (also available as a seperate
; publication from CCRMA), as well as some more recent papers by
; Smith and others.
;
; Coded by Sean Costello, October 1999/ modified by Jan Jacob Hofmann August 2005
; Note: arevsig is the global input to the reverb.

; Set ksmps to 1 because feedback lines are used.
setksmps 1
arevsig inleta "in"
itone init i(gk_SpatialReverb_CutoffHz)
afilt1 init 0
afilt2 init 0
afilt3 init 0
afilt4 init 0
afilt5 init 0
afilt6 init 0
afilt7 init 0
afilt8 init 0
afilt9 init 0
afilt10 init 0
afilt11 init 0
afilt12 init 0
; Delay times chosen to be prime numbers.
; Works with sr=44100/ sr=48000 ONLY. If you wish to
; use a different delay time, find some new
; prime numbers that will give roughly the
; same delay times for the new sampling rate.
; Or adjust to taste.
if sr == 41000 then
idel1 = (1237.000/sr)
idel2 = (1381.000/sr)
idel3 = (1609.000/sr)
idel4 = (1777.000/sr)
idel5 = (1951.000/sr)
idel6 = (2063.000/sr)
idel7 = (1069.000/sr)
idel8 = ( 967.000/sr)
idel9 = (1889.000/sr)
idel10 = (1693.000/sr)
idel11 = (1453.000/sr)
idel12 = (1291.000/sr)
elseif sr == 48000 then
idel1 = (1361.000/sr)
idel2 = (1499.000/sr)
idel3 = (1753.000/sr)
idel4 = (1933.000/sr)
idel5 = (2129.000/sr)
idel6 = (2243.000/sr)
idel7 = (1163.000/sr)
idel8 = (1051.000/sr)
idel9 = (2053.000/sr)
idel10 = (1693.000/sr)
idel11 = (1847.000/sr)
idel12 = (1409.000/sr)
endif
; k1-k8 are used to add random pitch modulation to the
; delay lines. Helps eliminate metallic overtones
; in the reverb sound.
k1 randi .001, 3.1, .06
k2 randi .0011, 3.5, .9
k3 randi .0017, 1.11, .7
k4 randi .0006, 3.973, .3
k5 randi .001, 2.341, .63
k6 randi .0011, 1.897, .17
k7 randi .0017, 0.891, .19
k8 randi .0006, 3.221, .44
k9 randi .001, 1.891, .88
k10 randi .0011, 2.317, .95
k11 randi .0017, 1.091, .36
k12 randi .0006, 2.821, .41
; apj is used to calculate "resultant junction pressure" for
; the scattering junction of e.g. 8 lossless waveguides
; of equal characteristic impedance. If you wish to
; add more delay lines, simply add them to the following
; equation, and replace the .25 by 2/N, where N is the
; number of delay lines.
apj = .16666666667 * (afilt1 + afilt2 + afilt3 + afilt4 + afilt5 + afilt6 +afilt7 + afilt8 + afilt9 + afilt10 +afilt11 + afilt12)
adum1 delayr 1
adel1 deltapi idel1 + k1 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt1
adum2 delayr 1
adel2 deltapi idel2 + k2 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt2
adum3 delayr 1
adel3 deltapi idel3 + k3 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt3
adum4 delayr 1
adel4 deltapi idel4 + k4 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt4
adum5 delayr 1
adel5 deltapi idel5 + k5 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt5
adum6 delayr 1
adel6 deltapi idel6 + k6 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt6
adum7 delayr 1
adel7 deltapi idel7 + k7 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt7
adum8 delayr 1
adel8 deltapi idel8 + k8 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt8
adum9 delayr 1
adel9 deltapi idel9 + k9 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt9
adum10 delayr 1
adel10 deltapi idel10 + k10 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt10
adum11 delayr 1
adel11 deltapi idel11 + k11 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt11
adum12 delayr 1
adel12 deltapi idel12 + k12 * gk_SpatialReverb_RandomDelayModulation
 delayw arevsig + apj - afilt12
; 1st order lowpass filters in feedback
; loops of delay lines.
afilt1 tone adel1 * gk_SpatialReverb_ReverbDecay, itone
afilt2 tone adel2 * gk_SpatialReverb_ReverbDecay, itone
afilt3 tone adel3 * gk_SpatialReverb_ReverbDecay, itone
afilt4 tone adel4 * gk_SpatialReverb_ReverbDecay, itone
afilt5 tone adel5 * gk_SpatialReverb_ReverbDecay, itone
afilt6 tone adel6 * gk_SpatialReverb_ReverbDecay, itone
afilt7 tone adel7 * gk_SpatialReverb_ReverbDecay, itone
afilt8 tone adel8 * gk_SpatialReverb_ReverbDecay, itone
afilt9 tone adel9 * gk_SpatialReverb_ReverbDecay, itone
afilt10 tone adel10 * gk_SpatialReverb_ReverbDecay, itone
afilt11 tone adel11 * gk_SpatialReverb_ReverbDecay, itone
afilt12 tone adel12 * gk_SpatialReverb_ReverbDecay, itone
; iA1-iA12 are the angles pointing to the 12 corners of an icosahedron.
; iE1-iE12 are the elevations pointing to the 12 corners of an icosahedron.
iA1 = 0 ; angle reverberant point 1
iA2 = 0.6238 ; angle reverberant point 2
iA3 = 1.2566 ; angle reverberant point 3
iA4 = 1.8849 ; angle reverberant point 4
iA5 = 2.5132 ; angle reverberant point 5
iA6 = 3.1415 ; angle reverberant point 6
iA7 = 3.7699 ; angle reverberant point 7
iA8 = 4.3982 ; angle reverberant point 8
iA9 = 5.0265 ; angle reverberant point 9
iA10 = 5.6548 ; angle reverberant point 10
iA11 = 0 ; angle reverberant point 11
iA12 = 0 ; angle reverberant point 12
iE1 = 0.463646 ; height reverberant point 1 ( 26.565?)
iE2 = -0.463646 ; height reverberant point 2 ( -26.565?)
iE3 = 0.463646 ; height reverberant point 3 ( 26.565?)
iE4 = -0.463646 ; height reverberant point 4 ( -26.565?)
iE5 = 0.463646 ; height reverberant point 5 ( 26.565?)
iE6 = -0.463646 ; height reverberant point 6 ( -26.565?)
iE7 = 0.463646 ; height reverberant point 7 ( 26.565?)
iE8 = -0.463646 ; height reverberant point 8 ( -26.565?)
iE9 = 0.463646 ; height reverberant point 9 ( 26.565?)
iE10 = -0.463646 ; height reverberant point 10 ( -26.565?)
iE11 = 1.570796 ; height reverberant point 11 ( 90?)
iE12 = -1.570796 ; height reverberant point 12 ( -90?)
aboutput[] init 16
abreverberated[] init 16
aboutput       bformenc1 afilt1, iA1, iE1
abreverberated bformenc1 afilt2, iA2, iE2
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt3, iA3, iE3
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt4, iA4, iE4
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt5, iA5, iE5
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt6, iA6, iE6
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt7, iA7, iE7
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt8, iA8, iE8
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
abreverberated bformenc1 afilt9, iA9, iE9
aboutput[ 0] = aboutput[ 0] + abreverberated[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated[ 9]
aboutput[10] = aboutput[10] + abreverberated[10]
aboutput[11] = aboutput[11] + abreverberated[11]
aboutput[12] = aboutput[12] + abreverberated[12]
aboutput[13] = aboutput[13] + abreverberated[13]
aboutput[14] = aboutput[14] + abreverberated[14]
aboutput[15] = aboutput[15] + abreverberated[15]
outletv "outbformat", aboutput
if gk_Spatialize_Verbose != 0 then
kelapsed timeinsts
printks "SpatialReverb i %5.2f t %5.2f [%5.2f] d %5.2f c %9.2f in %5.2f A[0] %5.2f\n", 1.0, p1, p2, kelapsed, p3, gk_SpatialReverb_CutoffHz, downsamp(arevsig), downsamp(aboutput[0])
endif
endin

gk_SpatialReverb_Gain init 0.2
instr SpatialReverb
ainput inleta "in"
asignal = ainput / 32.0 * gk_SpatialReverb_Gain
;kcutoff = 22000 / gk_SpatialReverb_CutoffHz
kcutoff = gk_SpatialReverb_CutoffHz
aleft1, aright1 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt1 = aleft1 + aright1
aleft2, aright2 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt2 = aleft2 + aright2
aleft3, aright3 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt3 = aleft3 + aright3
aleft4, aright4 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt4 = aleft4 + aright4
aleft5, aright5 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt5 = aleft5 + aright5
aleft6, aright6 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt6 = aleft6 + aright6
aleft7, aright7 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt7 = aleft7 + aright7
aleft8, aright8 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt8 = aleft8 + aright8
aleft9, aright9 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt9 = aleft9 + aright9
aleft10, aright10 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt10 = aleft10 + aright10
aleft11, aright11 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt11 = aleft11 + aright11
aleft12, aright12 reverbsc asignal, asignal, gk_SpatialReverb_ReverbDecay, kcutoff, sr
afilt12 = aleft12 + aright12
afiltc1 tone afilt1, gk_SpatialReverb_CutoffHz
afiltc2 tone afilt2, gk_SpatialReverb_CutoffHz
afiltc3 tone afilt3, gk_SpatialReverb_CutoffHz
afiltc4 tone afilt4, gk_SpatialReverb_CutoffHz
afiltc5 tone afilt5, gk_SpatialReverb_CutoffHz
afiltc6 tone afilt6, gk_SpatialReverb_CutoffHz
afiltc7 tone afilt7, gk_SpatialReverb_CutoffHz
afiltc8 tone afilt8, gk_SpatialReverb_CutoffHz
afiltc9 tone afilt9, gk_SpatialReverb_CutoffHz
afiltc10 tone afilt10, gk_SpatialReverb_CutoffHz
afiltc11 tone afilt11, gk_SpatialReverb_CutoffHz
afiltc12 tone afilt12, gk_SpatialReverb_CutoffHz
; iA1-iA12 are the angles pointing to the 12 corners of an icosahedron.
; iE1-iE12 are the elevations pointing to the 12 corners of an icosahedron.
iA1 = 0 ; angle reverberant point 1
iA2 = 0.6238 ; angle reverberant point 2
iA3 = 1.2566 ; angle reverberant point 3
iA4 = 1.8849 ; angle reverberant point 4
iA5 = 2.5132 ; angle reverberant point 5
iA6 = 3.1415 ; angle reverberant point 6
iA7 = 3.7699 ; angle reverberant point 7
iA8 = 4.3982 ; angle reverberant point 8
iA9 = 5.0265 ; angle reverberant point 9
iA10 = 5.6548 ; angle reverberant point 10
iA11 = 0 ; angle reverberant point 11
iA12 = 0 ; angle reverberant point 12
iE1 = 0.463646 ; height reverberant point 1 ( 26.565?)
iE2 = -0.463646 ; height reverberant point 2 ( -26.565?)
iE3 = 0.463646 ; height reverberant point 3 ( 26.565?)
iE4 = -0.463646 ; height reverberant point 4 ( -26.565?)
iE5 = 0.463646 ; height reverberant point 5 ( 26.565?)
iE6 = -0.463646 ; height reverberant point 6 ( -26.565?)
iE7 = 0.463646 ; height reverberant point 7 ( 26.565?)
iE8 = -0.463646 ; height reverberant point 8 ( -26.565?)
iE9 = 0.463646 ; height reverberant point 9 ( 26.565?)
iE10 = -0.463646 ; height reverberant point 10 ( -26.565?)
iE11 = 1.570796 ; height reverberant point 11 ( 90?)
iE12 = -1.570796 ; height reverberant point 12 ( -90?)
aboutput[] init 16
abreverberated1[] init 16
abreverberated2[] init 16
abreverberated3[] init 16
abreverberated4[] init 16
abreverberated5[] init 16
abreverberated6[] init 16
abreverberated7[] init 16
abreverberated8[] init 16
abreverberated9[] init 16
abreverberated10[] init 16
abreverberated11[] init 16
abreverberated12[] init 16
aboutput[ 0] = 0
aboutput[ 1] = 0
aboutput[ 2] = 0
aboutput[ 3] = 0
aboutput[ 4] = 0
aboutput[ 5] = 0
aboutput[ 6] = 0
aboutput[ 7] = 0
aboutput[ 8] = 0
aboutput[ 9] = 0
aboutput[10] = 0
aboutput[11] = 0
aboutput[12] = 0
aboutput[13] = 0
aboutput[14] = 0
aboutput[15] = 0
abreverberated1 bformenc1 afiltc1, iA1, iE1
aboutput[ 0] = aboutput[ 0] + abreverberated1[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated1[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated1[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated1[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated1[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated1[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated1[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated1[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated1[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated1[ 9]
aboutput[10] = aboutput[10] + abreverberated1[10]
aboutput[11] = aboutput[11] + abreverberated1[11]
aboutput[12] = aboutput[12] + abreverberated1[12]
aboutput[13] = aboutput[13] + abreverberated1[13]
aboutput[14] = aboutput[14] + abreverberated1[14]
aboutput[15] = aboutput[15] + abreverberated1[15]
abreverberated2 bformenc1 afiltc2, iA2, iE2
aboutput[ 0] = aboutput[ 0] + abreverberated2[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated2[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated2[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated2[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated2[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated2[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated2[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated2[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated2[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated2[ 9]
aboutput[10] = aboutput[10] + abreverberated2[10]
aboutput[11] = aboutput[11] + abreverberated2[11]
aboutput[12] = aboutput[12] + abreverberated2[12]
aboutput[13] = aboutput[13] + abreverberated2[13]
aboutput[14] = aboutput[14] + abreverberated2[14]
aboutput[15] = aboutput[15] + abreverberated2[15]
abreverberated2 bformenc1 afiltc3, iA3, iE3
aboutput[ 0] = aboutput[ 0] + abreverberated3[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated3[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated3[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated3[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated3[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated3[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated3[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated3[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated3[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated3[ 9]
aboutput[10] = aboutput[10] + abreverberated3[10]
aboutput[11] = aboutput[11] + abreverberated3[11]
aboutput[12] = aboutput[12] + abreverberated3[12]
aboutput[13] = aboutput[13] + abreverberated3[13]
aboutput[14] = aboutput[14] + abreverberated3[14]
aboutput[15] = aboutput[15] + abreverberated3[15]
abreverberated4 bformenc1 afiltc4, iA4, iE4
aboutput[ 0] = aboutput[ 0] + abreverberated4[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated4[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated4[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated4[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated4[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated4[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated4[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated4[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated4[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated4[ 9]
aboutput[10] = aboutput[10] + abreverberated4[10]
aboutput[11] = aboutput[11] + abreverberated4[11]
aboutput[12] = aboutput[12] + abreverberated4[12]
aboutput[13] = aboutput[13] + abreverberated4[13]
aboutput[14] = aboutput[14] + abreverberated4[14]
aboutput[15] = aboutput[15] + abreverberated4[15]
abreverberated5 bformenc1 afiltc5, iA5, iE5
aboutput[ 0] = aboutput[ 0] + abreverberated5[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated5[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated5[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated5[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated5[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated5[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated5[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated5[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated5[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated5[ 9]
aboutput[10] = aboutput[10] + abreverberated5[10]
aboutput[11] = aboutput[11] + abreverberated5[11]
aboutput[12] = aboutput[12] + abreverberated5[12]
aboutput[13] = aboutput[13] + abreverberated5[13]
aboutput[14] = aboutput[14] + abreverberated5[14]
aboutput[15] = aboutput[15] + abreverberated5[15]
abreverberated6 bformenc1 afiltc6, iA6, iE6
aboutput[ 0] = aboutput[ 0] + abreverberated6[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated6[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated6[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated6[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated6[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated6[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated6[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated6[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated6[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated6[ 9]
aboutput[10] = aboutput[10] + abreverberated6[10]
aboutput[11] = aboutput[11] + abreverberated6[11]
aboutput[12] = aboutput[12] + abreverberated6[12]
aboutput[13] = aboutput[13] + abreverberated6[13]
aboutput[14] = aboutput[14] + abreverberated6[14]
aboutput[15] = aboutput[15] + abreverberated6[15]
abreverberated7 bformenc1 afiltc7, iA7, iE7
aboutput[ 0] = aboutput[ 0] + abreverberated7[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated7[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated7[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated7[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated7[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated7[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated7[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated7[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated7[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated7[ 9]
aboutput[10] = aboutput[10] + abreverberated7[10]
aboutput[11] = aboutput[11] + abreverberated7[11]
aboutput[12] = aboutput[12] + abreverberated7[12]
aboutput[13] = aboutput[13] + abreverberated7[13]
aboutput[14] = aboutput[14] + abreverberated7[14]
aboutput[15] = aboutput[15] + abreverberated7[15]
abreverberated8 bformenc1 afiltc8, iA8, iE8
aboutput[ 0] = aboutput[ 0] + abreverberated8[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated8[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated8[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated8[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated8[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated8[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated8[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated8[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated8[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated8[ 9]
aboutput[10] = aboutput[10] + abreverberated8[10]
aboutput[11] = aboutput[11] + abreverberated8[11]
aboutput[12] = aboutput[12] + abreverberated8[12]
aboutput[13] = aboutput[13] + abreverberated8[13]
aboutput[14] = aboutput[14] + abreverberated8[14]
aboutput[15] = aboutput[15] + abreverberated8[15]
abreverberated9 bformenc1 afiltc9, iA9, iE9
aboutput[ 0] = aboutput[ 0] + abreverberated9[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated9[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated9[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated9[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated9[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated9[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated9[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated9[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated9[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated9[ 9]
aboutput[10] = aboutput[10] + abreverberated9[10]
aboutput[11] = aboutput[11] + abreverberated9[11]
aboutput[12] = aboutput[12] + abreverberated9[12]
aboutput[13] = aboutput[13] + abreverberated9[13]
aboutput[14] = aboutput[14] + abreverberated9[14]
aboutput[15] = aboutput[15] + abreverberated9[15]
abreverberated10 bformenc1 afiltc10, iA10, iE10
aboutput[ 0] = aboutput[ 0] + abreverberated10[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated10[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated10[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated10[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated10[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated10[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated10[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated10[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated10[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated10[ 9]
aboutput[10] = aboutput[10] + abreverberated10[10]
aboutput[11] = aboutput[11] + abreverberated10[11]
aboutput[12] = aboutput[12] + abreverberated10[12]
aboutput[13] = aboutput[13] + abreverberated10[13]
aboutput[14] = aboutput[14] + abreverberated10[14]
aboutput[15] = aboutput[15] + abreverberated10[15]
abreverberated11 bformenc1 afiltc11, iA11, iE11
aboutput[ 0] = aboutput[ 0] + abreverberated11[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated11[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated11[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated11[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated11[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated11[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated11[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated11[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated11[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated11[ 9]
aboutput[10] = aboutput[10] + abreverberated11[10]
aboutput[11] = aboutput[11] + abreverberated11[11]
aboutput[12] = aboutput[12] + abreverberated11[12]
aboutput[13] = aboutput[13] + abreverberated11[13]
aboutput[14] = aboutput[14] + abreverberated11[14]
aboutput[15] = aboutput[15] + abreverberated11[15]
abreverberated12 bformenc1 afiltc12, iA12, iE12
aboutput[ 0] = aboutput[ 0] + abreverberated12[ 0]
aboutput[ 1] = aboutput[ 1] + abreverberated12[ 1]
aboutput[ 2] = aboutput[ 2] + abreverberated12[ 2]
aboutput[ 3] = aboutput[ 3] + abreverberated12[ 3]
aboutput[ 4] = aboutput[ 4] + abreverberated12[ 4]
aboutput[ 5] = aboutput[ 5] + abreverberated12[ 5]
aboutput[ 6] = aboutput[ 6] + abreverberated12[ 6]
aboutput[ 7] = aboutput[ 7] + abreverberated12[ 7]
aboutput[ 8] = aboutput[ 8] + abreverberated12[ 8]
aboutput[ 9] = aboutput[ 9] + abreverberated12[ 9]
aboutput[10] = aboutput[10] + abreverberated12[10]
aboutput[11] = aboutput[11] + abreverberated12[11]
aboutput[12] = aboutput[12] + abreverberated12[12]
aboutput[13] = aboutput[13] + abreverberated12[13]
aboutput[14] = aboutput[14] + abreverberated12[14]
aboutput[15] = aboutput[15] + abreverberated12[15]
outletv "outbformat", aboutput
if gk_Spatialize_Verbose != 0 then
aoutput sum aboutput[0], aboutput[1], aboutput[2], aboutput[3], aboutput[4], aboutput[5], aboutput[6], aboutput[7], aboutput[8], aboutput[9], aboutput[10], aboutput[11], aboutput[12], aboutput[13], aboutput[14], aboutput[15]
kelapsed timeinsts
printks "SpatialReverb i %5.2f t %5.2f [%5.2f] d %5.2f c %9.2f in %5.2f A %5.2f\n", 1.0, p1, p2, kelapsed, p3, kcutoff, asignal, aoutput
endif
endin

gk_Bformat2DecodeBinaural_krelcoef init 1
opcode Bformat2DecodeBinaural, a[], a[]i
absignal[], isr xin
krelcoef = gk_Bformat2DecodeBinaural_krelcoef
aw = absignal[ 0]
ax = absignal[ 1]
ay = absignal[ 2]
az = absignal[ 3]
ar = absignal[ 4]
as = absignal[ 5]
at = absignal[ 6]
au = absignal[ 7]
av = absignal[ 8]
; Decode 2nd order ambisonic as if it is a 12 channel dodecahedron loudspeaker rig.
; This configuration produces an 'in-phase' response and each speaker will have only a single maximum given a moving virtual sound source.
; w x y z r s t u v
; Speaker 1 <0.0000,0.0000,1.0000> centre top
achnl_co_1 sum aw * 0.1179, az * 0.1316, ar * 0.0491
; Speaker 2 <0.0000,0.0000,-1.0000> centre bottom
achnl_co_2 sum aw * 0.1179, az * -0.1316, ar * 0.0491
; Speaker 3 <0.7236,0.5257,0.4472>
achnl_co_3 sum aw * 0.1179, ax * 0.0952, ay * 0.0692, az * 0.0589, ar * -0.0098, as * 0.0238, at * 0.0173, au * 0.0091, av * 0.0280
; Speaker 4 <-0.7236,-0.5257,-0.4472>
achnl_co_4 sum aw * 0.1179, ax * -0.0952, ay * -0.0692, az * -0.0589, ar * -0.0098, as * 0.0238, at * 0.0173, au * 0.0091, av * 0.0280
; Speaker 5 <0.7236,-0.5257,0.4472>
achnl_co_5 sum aw * 0.1179, ax * 0.0952, ay * -0.0692, az * 0.0589, ar * -0.0098, as * 0.0238, at * -0.0173, au * 0.0091, av * -0.0280
; Speaker 6 <-0.7236,0.5257,-0.4472>
achnl_co_6 sum aw * 0.1179, ax * -0.0952, ay * 0.0692, az * -0.0589, ar * -0.0098, as * 0.0238, at * -0.0173, au * 0.0091, av * -0.0280
; Speaker 7 <-0.2764,0.8507,0.4472>
achnl_co_7 sum aw * 0.1179, ax * -0.0364, ay * 0.1119, az * 0.0589, ar * -0.0098, as * -0.0091, at * 0.0280, au * -0.0238, av * -0.0173
; Speaker 8 <0.2764,-0.8507,-0.4472>
achnl_co_8 sum aw * 0.1179, ax * 0.0364, ay * -0.1119, az * -0.0589, ar * -0.0098, as * -0.0091, at * 0.0280, au * -0.0238, av * -0.0173
; Speaker 9 <-0.2764,-0.8507,0.4472>
achnl_co_9 sum aw * 0.1179, ax * -0.0364, ay * -0.1119, az * 0.0589, ar * -0.0098, as * -0.0091, at * -0.0280, au * -0.0238, av * 0.0173
; Speaker 10 <0.2764,0.8507,-0.4472>
achnl_co_10 sum aw * 0.1179, ax * 0.0364, ay * 0.1119, az * -0.0589, ar * -0.0098, as * -0.0091, at * -0.0280, au * -0.0238, av * 0.0173
; Speaker 11 <-0.8944,0.0000,0.4472>
achnl_co_11 sum aw * 0.1179, ax * -0.1177, az * 0.0589, ar * -0.0098, as * -0.0295, au * 0.0295
; Speaker 12 <0.8944,0.0000,-0.4472>
achnl_co_12 sum aw * 0.1179, ax * 0.1177, az * -0.0589, ar * -0.0098, as * -0.0295, au * 0.0295
; Rig Decode Matrix to Reproduce Spherical Harmonics (Second Order)
; This rig configuration produces a strict idealised response that satisfies the Ambisonic matching equations. Generally this type of configuration produces a relatively small stable listening area.
; w x y z r s t u v
; Speaker 1 <0.0000,0.0000,1.0000> centre top
achnl_sh_1 sum aw * 0.1179, az * 0.2500, ar * 0.4167
; Speaker 2 <0.0000,0.0000,-1.0000> centre bottom
achnl_sh_2 sum aw * 0.1179, az * -0.2500, ar * 0.4167
; Speaker 3 <0.7236,0.5257,0.4472>
achnl_sh_3 sum aw * 0.1179, ax * 0.1809, ay * 0.1314, az * 0.1118, ar * -0.0833, as * 0.2023, at * 0.1469, au * 0.0773, av * 0.2378
; Speaker 4 <-0.7236,-0.5257,-0.4472>
achnl_sh_4 sum aw * 0.1179, ax * -0.1809, ay * -0.1314, az * -0.1118, ar * -0.0833, as * 0.2023, at * 0.1469, au * 0.0773, av * 0.2378
; Speaker 5 <0.7236,-0.5257,0.4472>
achnl_sh_5 sum aw * 0.1179, ax * 0.1809, ay * -0.1314, az * 0.1118, ar * -0.0833, as * 0.2023, at * -0.1469, au * 0.0773, av * -0.2378
; Speaker 6 <-0.7236,0.5257,-0.4472>
achnl_sh_6 sum aw * 0.1179, ax * -0.1809, ay * 0.1314, az * -0.1118, ar * -0.0833, as * 0.2023, at * -0.1469, au * 0.0773, av * -0.2378
; Speaker 7 <-0.2764,0.8507,0.4472>
achnl_sh_7 sum aw * 0.1179, ax * -0.0691, ay * 0.2127, az * 0.1118, ar * -0.0833, as * -0.0773, at * 0.2378, au * -0.2023, av * -0.1469
; Speaker 8 <0.2764,-0.8507,-0.4472>
achnl_sh_8 sum aw * 0.1179, ax * 0.0691, ay * -0.2127, az * -0.1118, ar * -0.0833, as * -0.0773, at * 0.2378, au * -0.2023, av * -0.1469
; Speaker 9 <-0.2764,-0.8507,0.4472>
achnl_sh_9 sum aw * 0.1179, ax * -0.0691, ay * -0.2127, az * 0.1118, ar * -0.0833, as * -0.0773, at * -0.2378, au * -0.2023, av * 0.1469
; Speaker 10 <0.2764,0.8507,-0.4472>
achnl_sh_10 sum aw * 0.1179, ax * 0.0691, ay * 0.2127, az * -0.1118, ar * -0.0833, as * -0.0773, at * -0.2378, au * -0.2023, av * 0.1469
; Speaker 11 <-0.8944,0.0000,0.4472>
achnl_sh_11 sum aw * 0.1179, ax * -0.2236, az * 0.1118, ar * -0.0833, as * -0.2500, au * 0.2500
; Speaker 12 <0.8944,0.0000,-0.4472>
achnl_sh_12 sum aw * 0.1179, ax * 0.2236, az * -0.1118, ar * -0.0833, as * -0.2500, au * 0.2500
achnl_1 = achnl_co_1 * krelcoef + achnl_sh_1 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_2 = achnl_co_2 * krelcoef + achnl_sh_2 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_3 = achnl_co_3 * krelcoef + achnl_sh_3 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_4 = achnl_co_4 * krelcoef + achnl_sh_4 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_5 = achnl_co_5 * krelcoef + achnl_sh_5 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_6 = achnl_co_6 * krelcoef + achnl_sh_6 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_7 = achnl_co_7 * krelcoef + achnl_sh_7 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_8 = achnl_co_8 * krelcoef + achnl_sh_8 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_9 = achnl_co_9 * krelcoef + achnl_sh_9 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_10 = achnl_co_10 * krelcoef + achnl_sh_10 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_11 = achnl_co_11 * krelcoef + achnl_sh_11 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
achnl_12 = achnl_co_12 * krelcoef + achnl_sh_12 * (1 - krelcoef) ; ratio between controlled opposites and spherical harmonic coefficients
if isr == 44100 then
aleft_1, aright1 hrtfstat achnl_1, 1, 89.99, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_2, aright2 hrtfstat achnl_2, -1, -89.99, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_3, aright_3 hrtfstat achnl_3, -36, 26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_4, aright_4 hrtfstat achnl_4, 144, -26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_5, aright_5 hrtfstat achnl_5, 36, 26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_6, aright_6 hrtfstat achnl_6, -144, -26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_7, aright_7 hrtfstat achnl_7, -108, 26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_8, aright_8 hrtfstat achnl_8, 72, -26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_9, aright_9 hrtfstat achnl_9, 108, 26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_10, aright_10 hrtfstat achnl_10, -72, -26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_11, aright_11 hrtfstat achnl_11, 180, 26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
aleft_12, aright_12 hrtfstat achnl_12, 0, -26.565, "/hrtf-44100-left.dat", "/hrtf-44100-right.dat", 8.8, 44100
else
if isr == 48000 then
aleft_1, aright_1 hrtfstat achnl_1, 1, 89.99, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_2, aright_2 hrtfstat achnl_2, -1, -89.99, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_3, aright_3 hrtfstat achnl_3, -36, 26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_4, aright_4 hrtfstat achnl_4, 144, -26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_5, aright_5 hrtfstat achnl_5, 36, 26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_6, aright_6 hrtfstat achnl_6, -144, -26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_7, aright_7 hrtfstat achnl_7, -108, 26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_8, aright_8 hrtfstat achnl_8, 72, -26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_9, aright_9 hrtfstat achnl_9, 108, 26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_10, aright_10 hrtfstat achnl_10, -72, -26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_11, aright_11 hrtfstat achnl_11, 180, 26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
aleft_12, aright_12 hrtfstat achnl_12, 0, -26.565, "/hrtf-48000-left.dat", "/hrtf-48000-right.dat", 8.8, 48000
else
if isr == 96000 then
aleft_1, aright_1 hrtfstat achnl_1, 1, 89.99, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_2, aright_2 hrtfstat achnl_2, -1, -89.99, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_3, aright_3 hrtfstat achnl_3, -36, 26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_4, aright_4 hrtfstat achnl_4, 144, -26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_5, aright_5 hrtfstat achnl_5, 36, 26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_6, aright_6 hrtfstat achnl_6, -144, -26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_7, aright_7 hrtfstat achnl_7, -108, 26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_8, aright_8 hrtfstat achnl_8, 72, -26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_9, aright_9 hrtfstat achnl_9, 108, 26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_10, aright_10 hrtfstat achnl_10, -72, -26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_11, aright_11 hrtfstat achnl_11, 180, 26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
aleft_12, aright_12 hrtfstat achnl_12, 0, -26.565, "/hrtf-96000-left.dat", "/hrtf-96000-right.dat", 8.8, 96000
else
printks "Sampling rate = %f is not handled by Bformat2DecodeBinaural.", 1, sr
exitnow
endif
endif
endif
prints "Loaded HRTF data.\n"
; Inter-aural time delay (seconds)
aleft_1 delay aleft_1, 0.00028986
aleft_2 delay aleft_2, 0.00028986
aleft_3 delay aleft_3, 0.00020974
aleft_4 delay aleft_4, 0.00036997
aleft_5 delay aleft_5, 0.00036997
aleft_6 delay aleft_6, 0.00020974
aleft_7 delay aleft_7, 0.00008011
aleft_8 delay aleft_8, 0.00049960
aleft_9 delay aleft_9, 0.00049960
aleft_10 delay aleft_10, 0.00008011
aleft_11 delay aleft_11, 0.00028986
aleft_12 delay aleft_12, 0.00028986
aright_1 delay aright_1, 0.00028986
aright_2 delay aright_2, 0.00028986
aright_3 delay aright_3, 0.00036997
aright_4 delay aright_4, 0.00020974
aright_5 delay aright_5, 0.00020974
aright_6 delay aright_6, 0.00036997
aright_7 delay aright_7, 0.000499597
aright_8 delay aright_8, 0.00008011
aright_9 delay aright_9, 0.00008011
aright_10 delay aright_10, 0.000499597
aright_11 delay aright_11, 0.00028986
aright_12 delay aright_12, 0.00028986
asignal[] init 2
aleft sum aright_1, aright_2, aright_3, aright_4, aright_5, aright_6, aright_7, aright_8, aright_9, aright_10, aright_11, aright_12
aright sum aleft_1, aleft_2, aleft_3, aleft_4, aleft_5, aleft_6, aleft_7, aleft_8, aleft_9, aleft_10, aleft_11, aleft_12
asignal[0] dcblock aleft
asignal[1] dcblock aright
xout asignal
endop

gk_BformatDecoder_MasterLevel init 0.0
instr BformatDecoder
irig init i(gk_BformatDecoder_SpeakerRig)
kmasterlevel = pow(10, gk_BformatDecoder_MasterLevel / 20)
asignal[] init nchnls
absignal[] init 16
absignal[] inletv "inbformat"
if irig == 0 then
 asignal bformdec1 1, absignal
elseif irig == 1 then
 asignal Bformat2DecodeBinaural, absignal, sr
 asignal[0] = asignal[0] * kmasterlevel
 asignal[1] = asignal[1] * kmasterlevel
elseif irig == 2 then
 asignal bformdec1 2, absignal
 asignal[0] = asignal[0] * kmasterlevel
 asignal[1] = asignal[1] * kmasterlevel
 asignal[2] = asignal[2] * kmasterlevel
 asignal[3] = asignal[3] * kmasterlevel
elseif irig == 3 then
 asignal bformdec1 3, absignal
 asignal[0] = asignal[0] * kmasterlevel
 asignal[1] = asignal[1] * kmasterlevel
 asignal[2] = asignal[2] * kmasterlevel
 asignal[3] = asignal[3] * kmasterlevel
 asignal[4] = asignal[4] * kmasterlevel
else
 asignal bformdec1 irig, absignal
 asignal[0] = asignal[0] * kmasterlevel
 asignal[1] = asignal[1] * kmasterlevel
 asignal[2] = asignal[2] * kmasterlevel
 asignal[3] = asignal[3] * kmasterlevel
 asignal[4] = asignal[4] * kmasterlevel
 asignal[5] = asignal[5] * kmasterlevel
 asignal[6] = asignal[6] * kmasterlevel
 asignal[7] = asignal[7] * kmasterlevel
endif
out asignal
endin

gk_BformatDecoder_SpeakerRig init 1
gk_BformatDecoder_MasterLevel init 100

gk_Spatialize_SpeakerRigRadius init 5.0
gk_SpatialReverb_ReverbDecay init 0.98
gk_SpatialReverb_CutoffHz init sr
gk_SpatialReverb_RandomDelayModulation init 0.05
gk_SpatialReverb_Gain init 20
gk_LocalReverbByDistance_Wet init 0.95
; This is a fraction of the speaker rig radius.
gk_LocalReverbByDistance_FrontWall init 7
gk_LocalReverbByDistance_ReverbDecay init 0.96
gk_LocalReverbByDistance_CutoffHz init 20000
gk_LocalReverbByDistance_RandomDelayModulation init 0.05

gi_scene_radius = 60
gi_minimum_rate = 1/15
gi_maximum_rate = 1/60

connect "Blower",        "outbformat", "BformatDecoder", "inbformat"
connect "Blower",        "out", "SpatialReverb", "in"
connect "Bower",         "outbformat", "BformatDecoder", "inbformat"
connect "Bower",         "out", "SpatialReverb", "in"
connect "Buzzer",        "outbformat", "BformatDecoder", "inbformat"
connect "Buzzer",        "out", "SpatialReverb", "in"
connect "FMDroner",      "outbformat", "BformatDecoder", "inbformat"
connect "FMDroner",      "out", "SpatialReverb", "in"
connect "Phaser",        "outbformat", "BformatDecoder", "inbformat"
connect "Phaser",        "out", "SpatialReverb", "in"
connect "Shiner",        "outbformat", "BformatDecoder", "inbformat"
connect "Shiner",        "out", "SpatialReverb", "in"
connect "Sweeper",       "outbformat", "BformatDecoder", "inbformat"
connect "Sweeper",       "out", "SpatialReverb", "in"
connect "SpatialReverb", "outbformat", "BformatDecoder", "inbformat"

alwayson "SpatialReverb"
alwayson "BformatDecoder"   
;alwayson "Controls"

gk_FMDroner_partial1 init 1
gk_FMDroner_partial2 init 2
gk_FMDroner_partial3 init 1
gk_FMDroner_partial4 init .02
gk_FMDroner_partial5 init .1
gk_FMDroner_partial6 init 0
gk_FMDroner_partial7 init 0
gk_FMDroner_partial8 init 0
gk_FMDroner_partial9 init 0
gk_FMDroner_partial10 init 0
gk_FMDroner_index init 7
gk_FMDroner_decay init 12
gk_FMDroner_carrier init 1
gk_FMDroner_modulator init 1.414
gk_FMDroner_transeg_exponent init -18
gk_FMDroner_level init 4
gk_FMDroner_x init 6
gk_FMDroner_y init 0
gk_FMDroner_z init 0
gi_FMDroner_sine ftgen 0, 0, 65536, 10, 1
instr FMDroner
if p3 == -1 then
  p3 = 1000000
endif
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_velocity = p5
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_overall_amps = 80
i_normalization = ampdb(-i_overall_amps) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_FMDroner_level)
k1 = gk_FMDroner_partial1
k2 = gk_FMDroner_partial2
k3 = gk_FMDroner_partial3
k4 = gk_FMDroner_partial4
k5 = gk_FMDroner_partial5
k6 = gk_FMDroner_partial6
k7 = gk_FMDroner_partial7
k8 = gk_FMDroner_partial8
k9 = gk_FMDroner_partial9
k10 = gk_FMDroner_partial10
i_attack = .05
i_release = 5
i_sustain = p3 
xtratim i_attack + i_sustain + i_release
aenvelope transeg 0.0, i_attack / 2,   1.5, 1 / 2, 
                       i_attack / 2,  -1.5, 1, 
                       i_sustain,      0,   1, 
                       i_release / 2,  1.5, 1 / 2, 
                       i_release / 2, -1.5, 0
ihertz = cpsmidinn(i_midi_key)
kndx transeg i(gk_FMDroner_index), i(gk_FMDroner_decay), i(gk_FMDroner_transeg_exponent), 0
a_signal foscili .5, ihertz, gk_FMDroner_carrier, gk_FMDroner_modulator, kndx, gi_FMDroner_sine
a_damping linseg 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * a_damping
a_signal chebyshevpoly a_signal, 0, k1, -k2, -k3, k4, k5, k6, k7, k8, k9, k10
a_signal dcblock a_signal
a_signal = a_signal * i_amplitude * k_gain * a_damping
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
kelapsed timeinsts
printks "FMDroner       i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(a_signal)
;outs a_signal, a_signal
#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_send init 0
a_bsignal, a_spatial_reverb_send Spatialize a_signal, kx, ky, kz
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
endin

gk_Bower_midi_dynamic_range init 127
gk_Bower_attack init .02
gk_Bower_decay init .01
gk_Bower_release init 10
gk_Bower_level init -90
gk_Bower_pressure init 4.4
gi_Bower_sine ftgen 0,0,65536,10,1
instr Bower
if p3 == -1 then
  p3 = 1000000
endif
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Bower_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = -26
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Bower_level)
i_attack = i(gk_Bower_attack)
i_release = i(gk_Bower_release)
i_sustain = p3
xtratim i_attack + i_sustain + i_release
iamp = i_amplitude
aenvelope transeg 0.0, i_attack / 2.0, 1.5, iamp / 2.0, i_attack / 2.0, -1.5, iamp, i_sustain, 0.0, iamp, i_release / 2.0, 1.5, iamp / 2.0, i_release / 2.0, -1.5, 0
ihertz = cpsmidinn(i_midi_key)
kamp = aenvelope * k_gain
kfreq = ihertz
kpres = 0.25
krat rspline 0.006,0.988,1,4
kvibf = 4.5
kvibamp = 0
iminfreq = 20
a_signal wgbow kamp,kfreq,gk_Bower_pressure,krat,kvibf,kvibamp,gi_Bower_sine,iminfreq
a_damping linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * a_damping
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
kelapsed timeinsts
printks "Bower          i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(a_signal)
#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_send init 0
a_bsignal, a_spatial_reverb_send Spatialize a_signal, kx, ky, kz
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
endin

gk_Phaser_attack init .1
gk_Phaser_decay init 1
gk_Phaser_release init 10
gi_Phaser_sine ftgen 0,0,65536,10,1
gkratio1 init 1
gkratio2 init 1/3
gkindex1 init 1
gkindex2 init 0.0125
instr Phaser
insno = p1
istart = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p6
ipan = p7
iamp = ampdb(ivelocity) * 8
i_attack = i(gk_Phaser_attack)
i_release = i(gk_Phaser_release)
i_sustain = p3
xtratim i_attack + i_sustain + i_release
kenvelope transeg 0.0, i_attack / 2.0, 1.5, iamp / 2.0, i_attack / 2.0, -1.5, iamp, i_sustain, 0.0, iamp, i_release / 2.0, 1.5, iamp / 2.0, i_release / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
khertz = ihertz
ifunction1 = gi_Phaser_sine
ifunction2 = gi_Phaser_sine
a1,a2 crosspm gkratio1, gkratio2, gkindex1, gkindex2, khertz, ifunction1, ifunction2
a_signal = a1 + a2
a_damping linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * a_damping
absignal[] init 16
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
absignal, asend Spatialize a_signal, kx, ky, kz
outleta "out", asend
outletv "outbformat", absignal
kelapsed timeinsts
printks "Phaser         i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(a_signal)
endin

gk_Sweeper_midi_dynamic_range init 127
gk_Sweeper_attack init 2
gk_Sweeper_release init 10
gk_Sweeper_britel init 0
gk_Sweeper_briteh init 4.9
gk_Sweeper_britels init .2 / 3
gk_Sweeper_britehs init 2.5 / 2
gk_Sweeper_level init 40
gi_Sweeper_sine ftgen 0, 0, 65536, 10, 1
gi_Sweeper_octfn ftgen 0, 0, 65536, -19, 1, 0.5, 270, 0.5
instr Sweeper
//////////////////////////////////////////////
// Original by Iain McCurdy.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
if p3 == -1 then
  p3 = 1000000
endif
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Sweeper_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 58
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Sweeper_level)
i_attack = i(gk_Sweeper_attack)
i_release = i(gk_Sweeper_release)
i_sustain = p3 
xtratim i_attack + i_sustain + i_release
kenvelope transeg 0.0, i_attack / 2.0, 1.5, i_amplitude / 2.0, i_attack / 2.0, -1.5, i_amplitude, i_sustain, 0.0, i_amplitude, i_release / 2.0, 1.5, i_amplitude / 2.0, i_release / 2.0, -1.5, 0
ihertz = i_frequency
icps = ihertz
kamp expseg 0.001,0.02,0.2,p3-0.01,0.001
ktonemoddep jspline 0.01,0.05,0.2
ktonemodrte jspline 6,0.1,0.2
ktone poscil3 ktonemoddep, ktonemodrte, gi_Sweeper_sine
kbrite rspline gk_Sweeper_britel, gk_Sweeper_briteh, gk_Sweeper_britels, gk_Sweeper_britehs
ibasfreq init icps
ioctcnt init 3
iphs init 0
a1 hsboscil kenvelope, ktone, kbrite, ibasfreq, gi_Sweeper_sine, gi_Sweeper_octfn, ioctcnt, iphs
amod poscil3 0.25, ibasfreq*(1/3), gi_Sweeper_sine
arm = a1*amod
kmix expseg 0.001, 0.01, rnd(1), rnd(3)+0.3, 0.001
kmix=.25
a1 ntrpol a1, arm, kmix
;a1 pareq a1/10, 400, 15, .707
;a1 tone a1, 500
kpanrte jspline 5, 0.05, 0.1
kpandep jspline 0.9, 0.2, 0.4
kpan poscil3 kpandep, kpanrte, gi_Sweeper_sine
;a1,a2 pan2 a1, kpan
a1,a2 pan2 a1, k_space_left_to_right
a1 delay a1, rnd(0.1)
a2 delay a2, rnd(0.11)
kenv linsegr 1, 1, 0
kenv = kenvelope
aleft = a1*kenv*.02
aright = a2*kenv*.02
kgain = ampdb(gk_Sweeper_level)
aleft = aleft * k_gain
aright = aright * k_gain
a_damping linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = (aleft + aright) * a_damping
kelapsed timeinsts
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
printks "Sweeper        i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(a_signal)
#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_send init 0
a_bsignal, a_spatial_reverb_send Spatialize a_signal, kx, ky, kz
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
endin

gk_Buzzer_harmonics init 9
gk_Buzzer_attack init .05
gk_Buzzer_release init 10
gk_Buzzer_level init -86
gi_Buzzer_sine ftgen 0, 0, 65536, 10, 1
instr Buzzer
insno = p1
istart = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p6
ipan = p7
iamp = ampdb(ivelocity) * 4
i_attack = i(gk_Buzzer_attack)
i_release = i(gk_Buzzer_release)
i_sustain = p3
xtratim i_attack + i_sustain + i_release
aenvelope transeg 0.0, i_attack / 2.0, 1.5, iamp / 2.0, i_attack / 2.0, -1.5, iamp, i_sustain, 0.0, iamp, i_release / 2.0, 1.5, iamp / 2.0, i_release / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
asignal buzz aenvelope, ihertz, gk_Buzzer_harmonics, gi_Buzzer_sine
k_gain = ampdb(gk_Buzzer_level)
a_damping linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
asignal = asignal * k_gain * a_damping
;asignal vco2 kenvelope, ihertz, 12
;asignal poscil3 kenvelope, ihertz, giharmonics
;asignal distort asignal, gkDistortFactor * .4, giwaveshaping
aleft, aright pan2 asignal, ipan
a_signal = aleft + aright
a_damping linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * a_damping
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
kelapsed timeinsts
printks "Buzzer         i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(a_signal)
#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_send init 0
a_bsignal, a_spatial_reverb_send Spatialize a_signal, kx, ky, kz
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
endin

gk_Shiner_attack init 10
gk_Shiner_decay init 10
gk_Shiner_level init -100
instr Shiner
insno = p1
istart = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p6
ipan = p7
iamp = ampdb(ivelocity) * 4
i_attack = i(gk_Shiner_attack)
idecay = i(gk_Shiner_decay)
i_sustain = p3
xtratim i_attack + i_sustain + idecay
k_gain = ampdb(gk_Shiner_level)
kenvelope transeg 0.0, i_attack / 2.0, 1.5, iamp / 2.0, i_attack / 2.0, -1.5, iamp, i_sustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
;asignal gbuzz kenvelope, ihertz, 3, gkFirstHarmonic, gkDistortFactor, gisine
;asignal buzz kenvelope, ihertz, gkHarmonics, gisine
;asignal = asignal
asignal vco2 kenvelope * 4, ihertz, 12
;asignal poscil3 kenvelope, ihertz, giharmonics
;asignal distort asignal, gkDistortFactor * .4, giwaveshaping
aleft, aright pan2 asignal, ipan
adamping linseg 0, 0.03, 1, i_sustain, 1, 0.07, 0
aleft = adamping * aleft
aright = adamping * aright
asignal = aleft + aright
asignal = asignal * k_gain
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
kelapsed timeinsts
printks "Shiner         i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(asignal)
absignal[] init 16
absignal, aspatialreverbsend Spatialize asignal, kx, ky, kz
outletv "outbformat", absignal
outleta "out", aspatialreverbsend
endin

gk_Blower_midi_dynamic_range init 127
gk_Blower_grainDensity init 150
gk_Blower_grainDuration init 0.25
gk_Blower_grainAmplitudeRange init 10
gk_Blower_grainFrequencyRange init .033
gk_Blower_level init -50
;                f     #  time  size   1  filcod         skiptime   format   channel
gi_Blower_sample ftgen 0, 0, 65536, 10, 1, .3, .1, 0, .2, .02, 0, .1, .04
gi_Blower_wintab ftgen 0, 0, 65536, 10, 1, 0, .5, 0, .33, 0, .25, 0, .2, 0, .167
instr Blower
 //////////////////////////////////////////////
 // Original by Hans Mikelson.
 // Adapted by Michael Gogins.
 //////////////////////////////////////////////
if p3 == -1 then
  p3 = 1000000
endif
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Blower_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 134
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Blower_level)
; f1 0 65536 1 "hahaha.aif" 0 4 0
; f2 0 1024 7 0 224 1 800 0
; f3 0 8192 7 1 8192 -1
; f4 0 1024 7 0 512 1 512 0
; f5 0 65536 10 1 .3 .1 0 .2 .02 0 .1 .04
; f6 0 65536 10 1 0 .5 0 .33 0 .25 0 .2 0 .167
; a0 14 50
; p1 p2 p3 p4 p5 p6 p7 p8 p9 p10
; Start Dur Amp Freq GrTab WinTab FqcRng Dens Fade
; i1 0.0 6.5 700 9.00 5 4 .210 200 1.8
; i1 3.2 3.5 800 7.08 . 4 .042 100 0.8
; i1 5.1 5.2 600 7.10 . 4 .0320 100 0.9
; i1 7.2 6.6 900 8.03 . 4 .021 150 1.6
; i1 21.3 4.5 1000 9.00 . 4 .031 150 1.2
; i1 26.5 13.5 1100 6.09 . 4 .121 150 1.5
; i1 30.7 9.3 900 8.05 . 4 .014 150 2.5
; i1 34.2 8.8 700 10.02 . 4 .14 150 1.6
igrtab = gi_Blower_sample 
iHz = i_frequency
ihertz = iHz
ip4 = i_amplitude
ip5 = iHz
ip6 = igrtab
ip7 = gi_Blower_wintab
ip8 = 0.033
ip8 = .002
ip9 = 150
ip9 = 100
ip10 = 1.6
ip10 = 3
idur = p3
iamp = i_amplitude ; p4
ifqc = iHz ; cpspch(p5)
igrtab = ip6
iwintab = ip7
ifrng = ip8
idens = ip9
ifade = ip10
igdur = 0.2
i_attack = 0.5
idecay = 0.5
i_sustain = p3 + i_attack + idecay
kenvelope transeg 0.0, i_attack / 2.0, 1.5, .5, i_attack / 2.0, -1.5, 1, i_sustain, 0.0, 1, idecay / 2.0, 1.5, .5, idecay / 2.0, -1.5, 0
; kamp linseg 0, ifade, 1, idur - 2 * ifade, 1, ifade, 0
kamp = kenvelope
; Amp Fqc Dense AmpOff PitchOff GrDur GrTable WinTable MaxGrDur
aoutl grain ip4, ifqc, gk_Blower_grainDensity, gk_Blower_grainAmplitudeRange, gk_Blower_grainFrequencyRange, gk_Blower_grainDuration, igrtab, gi_Blower_wintab, 5
aoutr grain ip4, ifqc, gk_Blower_grainDensity, gk_Blower_grainAmplitudeRange, gk_Blower_grainFrequencyRange, gk_Blower_grainDuration, igrtab, gi_Blower_wintab, 5
asignal = aoutl + aoutr
asignal = asignal * k_gain;
absignal[] init 16
kx jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
ky jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kz jspline gi_scene_radius * 2, gi_minimum_rate, gi_maximum_rate
kx = kx - gi_scene_radius
ky = ky - gi_scene_radius
kz = kz - gi_scene_radius
kelapsed timeinsts
printks "Blower         i %7.2f t %7.2f [%7.2f] d %7.2f k %7.2f f %7.2f v %7.2f kx %7.2f ky %7.2f kz %7.2f A %9.2f\n", 1.0, p1, p2, kelapsed, p3, p4, ihertz, p5, kx, ky, kz, rms(asignal)
absignal, asend Spatialize asignal, kx, ky, kz
outleta "out", asend
outletv "outbformat", absignal
endin

instr Controls
gk_Droner_1 invalue "gk_Droner_1"
gk_Droner_2 invalue "gk_Droner_2"
gk_Droner_3 invalue "gk_Droner_3"
gk_Droner_4 invalue "gk_Droner_4"
gk_Droner_5 invalue "gk_Droner_5"
gk_Droner_x invalue "gk_Droner_x"
gk_Droner_y invalue "gk_Droner_y"
gk_Droner_z invalue "gk_Droner_z"
gk_LocalReverbByDistance_Wet invalue "gk_LocalReverbByDistance_Wet"
gk_LocalReverbByDistance_ReverbDecay invalue "gk_LocalReverbByDistance_ReverbDecay"
gk_LocalReverbByDistance_CutoffHz invalue "gk_LocalReverbByDistance_CutoffHz"
gk_SpatialReverb_ReverbDecay invalue "gk_SpatialReverb_ReverbDecay"
gk_SpatialReverb_CutoffHz invalue "gk_SpatialReverb_CutoffHz"
gk_SpatialReverb_Gain invalue "gk_SpatialReverb_Gain"
gk_BformatDecoder_MasterLevel invalue "gk_BformatDecoder_MasterLevel"
endin

prealloc "FMDroner",  8
prealloc "Bower",     8
prealloc "Blower",    8
prealloc "Buzzer",    8
prealloc "Shiner",    8
prealloc "Sweeper",   8

</CsInstruments>

<CsScore>

; p4 is just intonation in MIDI key numbers (numerator can be 0):
; [ ((numerator / denominator) * 12) + (octave * 12) + 24 ] 

t 0  30
;t 0 120

i "FMDroner"    0  60 [ (( 0 /  1) * 12) + (0 * 12) + 24 ] 63
i "FMDroner"    0  60 [ (( 4 /  5) * 12) + (1 * 12) + 24 ] 60
i "FMDroner"    0  30 [ (( 3 /  2) * 12) + (2 * 12) + 24 ] 60
i "FMDroner"    0  60 [ ((15 /  8) * 12) + (2 * 12) + 24 ] 57

i "Bower"      30  30 [ (( 5 /  8) * 12) + (2 * 12) + 24 ] 72

i "Sweeper"    60  60 [ (( 2 /  3) * 12) + (0 * 12) + 24 ] 56
i "Sweeper"    60  60 [ ((32 / 45) * 12) + (0 * 12) + 24 ] 54
i "Sweeper"    60  30 [ ((15 /  8) * 12) + (0 * 12) + 24 ] 51

i "Buzzer"     90  30 [ (( 3 /  4) * 12) + (1 * 12) + 24 ] 60

i "Buzzer"    120  60 [ (( 0 /  1) * 12) + (0 * 12) + 24 ] 63
i "FMDroner"  120  60 [ (( 4 /  5) * 12) + (1 * 12) + 24 ] 60
i "Bower"     120  30 [ ((15 /  8) * 12) + (2 * 12) + 24 ] 60
i "FMDroner"  150  30 [ (( 0 /  1) * 12) + (2 * 12) + 24 ] 60

</CsScore>
</CsoundSynthesizer>

    </textarea>
    
    
        <script>
            var clubber = null;
            function csoundMessage(text) {
                var Log_cell = document.getElementById('console');
                Log_cell.value += text;
                Log_cell.scrollTop = Log_cell.scrollHeight;
             }
            function updateTimeCell() {
                var score_time_cell = document.getElementById('Time_cell');
                if (typeof csound === 'undefined') {
                    return;
                }
                if (csound === null) {
                    return;
                }
                var score_time = csound.GetScoreTime(); 
                if (typeof score_time !== 'undefined') {
                    score_time_cell.innerHTML = score_time.toFixed(4);
                }
                clubber.update(score_time * 1000)
                //console.log(clubber.notes); // This is the array containing the audio energy per midi note.
                setTimeout(updateTimeCell, 500);
            };
            var parameters = {
                gk_Bower_pressure: 0.25,
                gk_Bower_level: 0.5,
                gk_Blower_grainDensity: .150,
                gk_Blower_grainDuration: .2,
                gk_Blower_grainAmplitudeRange: .1,
                gk_Blower_grainFrequencyRange: .033,
                gk_Blower_level: 0.5,
                gk_Buzzer_Harmonics: 15,
                gk_Buzzer_level: 0.5,
                gk_Droner_partial1: 0.1,
                gk_Droner_partial2: 0.1,
                gk_Droner_partial3: 0.1,
                gk_Droner_partial4: 0.1,
                gk_Droner_partial5: 0.1,
                gk_Droner_level: 0.5,
                gk_Harpsichord_level: 0.5,
                gk_Harpsichord_pick: .75,
                gk_Harpsichord_reflection: .5,
                gk_Harpsichord_pluck: .75,
                gk_Phaser_ratio1: 1,
                gk_Phaser_ratio2: .3333334,
                gk_Phaser_index1: 1,
                gk_Phaser_index2: .0125,
                gk_Phaser_level: 0.5,
                gk_Shiner_level: 0.5,
                gk_Sweeper_britel: 0,
                gk_Sweeper_briteh: 2.9,
                gk_Sweeper_britels: .2 / 3,
                gk_Sweeper_britehs: 2.5 / 2,
                gk_Sweeper_level: 0.5,
                gk_Xing_level: 0.5,
                gk_YiString_reverb_send: 0.5,
                gk_YiString_chorus_send: 0.5,
                gk_YiString_level: 0.5,
                gk_SolinaChorus_chorus_lfo1_hz: 18,
                gk_SolinaChorus_chorus_lfo1_amp: .6,
                gk_SolinaChorus_chorus_lfo2_hz: 6,
                gk_SolinaChorus_chorus_lfo2_amp: .2,
                gk_Reverb_feedback: .975,
                gk_Reverb2_Feedback: .7,
                gk_MasterOutput_level: .4,
                gk_FM_Clang_preset: 1,
                gk_FM_Clang_level: 0,
                Play: function() {
                    try {
                        csound = get_csound(csoundMessage);
                        if (csound === null) {
                            return;
                        }
                        gui.revert();
                        let csd = document.getElementById('csd').value;
                        csound.Stop();
                        csound.SetOption("-odac")
                        csound.SetOption("--ksmps=128")
                        csound.SetOption("--nchnls=2")
                        csound.SetOption("--nchnls_i=1")
                        csound.SetOption("--sample-rate=48000")
                        csound.CompileCsdText(csd);
                        csound.Start();
                        csound.Perform();
                        //let options = ['-odac', '--ksmps=128', '--nchnls=2', '--nchnls_i=1', '--sample-rate=48000', '-m35', '-d']
                        //csound.PerformCsd(options, csd);
                        setTimeout(updateTimeCell, 0);
                        clubber = new Clubber({
                            size: 2048, // Samples for the fourier transform. The produced linear frequency bins will be 1/2 that.
                            mute: false, // whether the audio source should be connected to web audio context destination.
                            context: csound.context
                        });
                        clubber.listen(csound); 
                        console.log(clubber.notes); // This is the array containing the audio energy per midi note.
                    } catch (e) {
                        alert(e);
                    }
                },
                Stop: function() {
                    csound.Stop();
                },
                Close: function() {
                    try {
                        csound.Stop();
                        window.close();
                    } catch (e) {
                        console.log(e);
                    }
                },
                FM9: function() {
                    chord = FM9.clone();
                    csound.Message('FM9:\n' + chord.information());
                },
                Bb7: function() {
                    chord = Bb7.clone();
                    csound.Message('Bb7:\n' + chord.information());
                },
                K: function() {
                    chord = chord.K();
                    csound.Message('K():\n' + chord.information());
                },
                Q2: function() {
                    chord = chord.Q(2, modality);
                    csound.Message('Q(2, modality):\n' + chord.information());
                },
                Q3: function() {
                    chord = chord.Q(3, modality);
                    csound.Message('Q(3, modality):\n' + chord.information());
                },
                Q5: function() {
                    chord = chord.Q(5, modality);
                    csound.Message('Q(5, modality):\n' + chord.information());
                },
                J2_2: function() {
                    var chords = chord.J(2);
                    if (chords.length > 1) {
                        chord = chords[1];
                        csound.Message('J(2,2):\n' + chord.information());
                    }
                },
                J2_3: function() {
                    var chords = chord.J(2);
                    if (chords.length > 2) {
                        chord = chords[2];
                        csound.Message('J(2,3):\n' + chord.information());
                    }
                },
                J3_1: function() {
                   var chords = chord.J(3);
                    if (chords.length > 0) {
                        chord = chords[0];
                        csound.Message('J(3,1):\n' + chord.information());
                    }
                },
                T5: function() {
                    chord = chord.T(5);
                    csound.Message('D():\n' + chord.information());
                },
            };        
            window.onload = function() {
                gui = new dat.GUI({width: 300});
                gui.remember(parameters);
                gui.add(parameters, 'Play').name('Play [Ctrl-P]');
                gui.add(parameters, 'Stop').name('Stop [Ctrl-S]');
                gui.add(parameters, 'Close').name('Close').name('Exit [Ctrl-X]');
                var Master = gui.addFolder('Master effects');
                add_slider(Master, 'gk_Reverb_feedback', 0, 1);
                add_slider(Master, 'gk_Reverb2_Feedback', 0, 1);
                add_slider(Master, 'gk_MasterOutput_level', -80, 80);
                var intruments = gui.addFolder('Instruments');
                var fmclang = intruments.addFolder('FM Clang');
                add_slider(fmclang, 'gk_FM_Clang_preset', 1, 13);
                add_slider(fmclang, 'gk_FM_Clang_level', -80, 80);
                var Blower = intruments.addFolder('Blower');
                add_slider(Blower, 'gk_Blower_grainDensity', 0, 400);
                add_slider(Blower, 'gk_Blower_grainDuration', 0, .5);
                add_slider(Blower, 'gk_Blower_grainAmplitudeRange', 0, 400);
                add_slider(Blower, 'gk_Blower_grainFrequencyRange', 0, 100);
                add_slider(Blower, 'gk_Blower_level', -80, 80);
                var Bower = intruments.addFolder('Bower');
                add_slider(Bower, 'gk_Bower_pressure', 0, 1);
                add_slider(Bower, 'gk_Bower_level', -80, 80);
                var Buzzer = intruments.addFolder('Buzzer');
                add_slider(Buzzer, 'gk_Buzzer_Harmonics', 0, 20);
                add_slider(Buzzer, 'gk_Buzzer_level', -80, 80);
                var Droner = intruments.addFolder('Droner');
                add_slider(Droner, 'gk_Droner_partial1', 0, 1);
                add_slider(Droner, 'gk_Droner_partial2', 0, 1);
                add_slider(Droner, 'gk_Droner_partial3', 0, 1);
                add_slider(Droner, 'gk_Droner_partial4', 0, 1);
                add_slider(Droner, 'gk_Droner_partial5', 0, 1);
                add_slider(Droner, 'gk_Droner_level', -80, 80);
                var Harpsichord = intruments.addFolder('Harpsichord');
                add_slider(Harpsichord, 'gk_Harpsichord_level', -80, 80);
                var Phaser = intruments.addFolder('Phaser');
                add_slider(Phaser, 'gk_Phaser_ratio1', 0, 2);
                add_slider(Phaser, 'gk_Phaser_ratio2', 0, 2);
                add_slider(Phaser, 'gk_Phaser_index1', 0, 1);
                add_slider(Phaser, 'gk_Phaser_index2', 0, 1);
                add_slider(Phaser, 'gk_Phaser_level', -80, 80);
                var Xing = intruments.addFolder('Xing');
                add_slider(Xing, 'gk_Xing_level', -80, 80);
                var Shiner = intruments.addFolder('Shiner');
                add_slider(Shiner, 'gk_Shiner_level', -80, 80);
                var Sweeper = intruments.addFolder('Sweeper');
                add_slider(Sweeper, 'gk_Sweeper_britel', 0, 4);
                add_slider(Sweeper, 'gk_Sweeper_briteh', 0, 4);
                add_slider(Sweeper, 'gk_Sweeper_britels', 0, 4);
                add_slider(Sweeper, 'gk_Sweeper_britehs', 0, 4);
                add_slider(Sweeper, 'gk_Sweeper_level', -80, 80);
                var Chords = gui.addFolder('Chords and transformations')
                Chords.add(parameters, 'Bb7');
                Chords.add(parameters, 'FM9');
                Chords.add(parameters, 'K').name('K() [Ctrl-K]');
                Chords.add(parameters, 'Q2').name('Q(2)');
                Chords.add(parameters, 'Q3').name('Q(3) [Ctrl-Q]');
                Chords.add(parameters, 'Q5').name('Q(5)');
                Chords.add(parameters, 'J2_2').name('J(2,2)');
                Chords.add(parameters, 'J2_3').name('J(2,3)');
                Chords.add(parameters, 'J3_1').name('J(3,1)');
                Chords.add(parameters, 'T5').name('D() [Ctrl-D]');
                gui.revert();
            }
            function gk_update(name, value) {
                if (csound !== null) {
                    var numberValue = parseFloat(value);
                    csound.SetControlChannel(name, numberValue);
                    csound.Message(name + ': ' + numberValue + '\n');
                }
            }
            function add_slider(gui_folder, token, minimum, maximum) {
                var on_parameter_change = function(value) {
                    if (token.startsWith('gk_')) {
                        gk_update(token, value);
                    } 
                };
                var slider = gui_folder.add(parameters, token, minimum, maximum);
                slider.onChange(on_parameter_change);
                return slider;
            };
            function logMessage(message) {
                console.log(message);
                var messages_textarea = document.getElementById("console");
                var existing = messages_textarea.value;
                messages_textarea.value = existing + message.data;
                messages_textarea.scrollTop = messages_textarea.scrollHeight;
            }
            // Used to find out what actually happens when a key is pressed.
            function printKey(e) {
              e = e || event
              //if (document.forms.keyform[e.type + 'Ignore'].checked) return
              var evt = e.type
              while (evt.length < 10) evt += ' ';
              var data = evt +
                ' keyCode=' + e.keyCode +
                ' which=' + e.which +
                ' charCode=' + e.charCode +
                ' char=' + String.fromCharCode(e.keyCode || e.charCode) +
                (e.shiftKey ? ' +shift' : '') +
                (e.ctrlKey ? ' +ctrl' : '') +
                (e.altKey ? ' +alt' : '') +
                (e.metaKey ? ' +meta' : '') + '\n';

              var message = {data: data};
              logMessage(message);
            }
            // The 'keydown' event is used for key bindings.
            $(document).on("keydown", function (e) {
                //printKey(e);
                var e_char = String.fromCharCode(e.keyCode || e.charCode);
                if (e.ctrlKey === true) {
                    if        (e_char === 'H') {
                        $("#statistics").toggle();
                        gui.toggle();
                    } else if (e_char === 'K') {
                        parameters.K();
                    } else if (e_char === 'Q') {
                        parameters.Q3();
                    } else if (e_char === 'D') {
                        parameters.T5();
                    } else if (e_char === 'T') {
                        chord = chord.T(2);
                    } else if (e_char === 'P') {
                        parameters.Play();
                    } else if (e_char === 'S') {
                        parameters.Stop();
                    } else if (e_char === 'X') {
                        parameters.Close();
                    }
                } else if (e.altKey === true) {
                    var sign = -1;
                    if (e.shiftKey === true) {
                        sign = 1;
                    }
                    if        (e_char === 'A') {
                        parameters.A += a_slider.__impliedStep * sign;
                        a_slider.updateDisplay();
                    } else if (e_char === 'B') {
                        parameters.B += b_slider.__impliedStep * sign;
                        b_slider.updateDisplay();
                    } else if (e_char === 'C') {
                        parameters.C += c_slider.__impliedStep * sign;
                        c_slider.updateDisplay();
                    } else if (e_char === 'D') {
                        parameters.D += d_slider.__impliedStep * sign;
                        d_slider.updateDisplay();
                    } else if (e_char === 'E') {
                        parameters.E += e_slider.__impliedStep * sign;
                        e_slider.updateDisplay();
                    }
                }
             });

        </script>
    </body>
</html>