<html>
    <!--

    TO DO:

    1. Global variables for all Csound control channels (done, had to wait for perform before calling). 
    2. Verify that clang_compile works in csound.node (done).
    3. Verify that clang_invoke works in csound.node.
    4. Score generator in C++.
    5. Remove all "Silencio" code (except score display?).
    6. Better instrument (copied patches).
    7. Better reverb.

    -->
    <head>
        <style>
            ::-webkit-scrollbar
            {
            width:10px;
            }
            ::-webkit-scrollbar-track-piece
            {
            background-color:transparent;
            }
            ::-webkit-scrollbar-corner
            {
            background-color:transparent;
            }
            .dg {
            font-family: Monaco, sans-serif;
            font-size:8pt;
            }
        </style>
        <script src='silencio/js/csound_loader.js'></script>
        <!-- <script src='silencio/js/canvas_wrapper.js'></script> -->
        <script src='silencio/js/sprintf.js'></script>
        <!-- <script src='silencio/js/numeric.js'></script> -->
        <script src="silencio/js/three.js"></script>
        <script src='silencio/js/tinycolor.js'></script>
        <script src='silencio/js/Silencio.js'></script>
<script src="silencio/js/TrackballControls.js"></script>
        <script src='silencio/js/ChordSpace.js'></script>
        <script type="text/javascript" src="silencio/js/dat.gui.js"></script>
    </head>
    <body style="background:black;">
                <canvas id="canvas" style="block;height:100vh;width:100vw">
        </canvas>
        <textarea id="console" style="position:absolute;left:1vw;top:1vw;width:50vw;height:98vh;color:SkyBlue;background-color:transparent;border:none;text-align:left;font-size:8.25px;overflow:auto;cursor:none;"></textarea>
        <script>
            var page = window.location.pathname.split("/").pop();
            console.log("Current file: " + page);
            var title = page;
            
            try {
            var fs = require("fs");
            var soundfile_name = sprintf("%s.wav", title);
            } catch(e) {
            console.log(e);
            }
            window.onerror = function (message, url, line) {
            csound.message(message + '\n' + url + '\n' + line + '\n');
            console.trace();
            }
            
            var generate = function() {
            csound.message("generate()...\n");
            try {
            window.lsys = new ChordSpace.LSys();
            lsys.axiom = "- [ g f f I I I I a ] g a";
            lsys.addRule('g', 'Ja b a3 c aa F F c2 a2 t,/,1.025 b2 K c2 g b2 t,*,1.025 T,5 F Jb F F c g a b g');
            lsys.addRule('a', 'F b F a2 b a2 [ b3 F F f F [ c F F F F ] ] F F F Jb c2 a2 c F c F F F b2 Ja a2');
            lsys.addRule('aa', '[ b3 F F F c3 f F F F F ] F b F a2 b I I I F F [ c2 F F F F F F ] F c2 a2 c F c F F b2 a2');
            lsys.addRule('xaa', '[ b3 F F F c3 f F F F F ] F b F a2 b I I F F [ c2 F F F F F F ] F c2 a2 c F c F F b2 a2');
            lsys.addRule('xa2', 'I F b F b a3 i i b2 f F F f c2 a3 c F c2 F b2 a3 i i c');
            lsys.addRule('a3', 'F b2 b F a I v F F c F F F F F c2 aa V f c2 F F b2 a');
            lsys.addRule('xa3', 'F b2 b F a I v F F c F F F F F c2 aa i i V f c2 F F b2 a');
            lsys.addRule('Ja', 'J,2,0');
            lsys.addRule('Jb', 'J,2,2'); 
            ///lsys.addRule('b', '+ f f f f f - -'); 
            ///lsys.addRule('c', '- f f f f f +');
            lsys.addRule('b', '+ f f f f F f - -'); 
            lsys.addRule('c', '- f f F f f f +');
            lsys.addRule('b2', '+ f f f f -'); 
            ///lsys.addRule('c2', '- - f f f f + +');
            lsys.addRule('c2', '- - f f f f + +');
            lsys.addRule('b3', '- - f f f + +'); 
            ///lsys.addRule('b3', '- - f f f f + +'); 
            var chord = ChordSpace.chordForName('CM9'); 
            var t = new ChordSpace.Turtle(4.5, Math.PI/2, chord, chord);
            lsys.generate(4);
            lsys.write_score(t);
            csound.message("Finding size of score...\n");
            lsys.score.findScales();
            csound.message("Rescaling score...\n");
            lsys.score.setScale(3, 1, 8.125);
            //lsys.score.setScale(3, 3, 0);
            lsys.score.setScale(4, 24, 72);
            ///lsys.score.setScale(5, 60, 8);
            ///lsys.score.setScale(5, 60, 9);
            lsys.score.setScale(5, 60, 11);
            lsys.score.setScale(7, 0, 1);
            lsys.score.temper(12);
            csound.message("Conforming to chords...\n");
            lsys.conformToChords();
            lsys.score.setDuration(12*60);
            csound.message("Tieing overlapping notes...\n");
            lsys.score.tieOverlaps(true);
            lsys.score.sort();
            // Fix up score before rendering.
            var i;
            var n = lsys.score.data.length;
            var cutoff = 7 * 60 + 35;
            var note;
            for (i = n - 1; i >= 0; --i) {
            note = lsys.score.data[i];
            // Extend the notes at the end.
            if ((note.time + note.duration) >= cutoff) {
             note.duration = (note.duration + 2.5);
            }
            if (note.duration < .5) {
             note.duration = .5;
            }
            }
            // Pianoteq misbehaves if we start right at time 0.
            for (var i = 0; i < lsys.score.data.length; i++) {
            var event = lsys.score.data[i];
            event.time = event.time + 2;
            }
            if (false) {
            // Also if keys overlap.
            for (var i = 0; i < lsys.score.data.length; i++) {
             var event = lsys.score.data[i];
             csound.message(event.toIStatement() + ' e: ' + event.end);
             var channel = Math.floor(event.channel);
             var key = event.key;
             for (var j = i + 1; j < lsys.score.data.length; j++) {
             var overlap = lsys.score.data[j];
             var overlap_channel = Math.floor(overlap.channel);
             var overlap_key = overlap.key;
             if (key === overlap_key && channel === overlap_channel && channel === 2) {
              if (event.end > overlap.time) {
              var the_end = Math.max(event.end, overlap.end);
              csound.message('Correcting overlap for:');
              csound.message(' ' + event.toIStatement() + ' e: ' + event.end);
              csound.message(' ' + overlap.toIStatement() + ' e: ' + overlap.end);
              event.end = the_end;
              overlap.end = the_end;
              csound.message('to:');
              csound.message(' ' + event.toIStatement() + ' e: ' + event.end);
              csound.message(' ' + overlap.toIStatement() + ' e: ' + overlap.end + '\n');
              }
             }
             }
            }
            }
            // Reassign Pianoteq to FMWaterBell,
            // randomize pans
            for (var i = 0; i < lsys.score.data.length; i++) {
            var event = lsys.score.data[i];
            event.channel = Math.round(event.channel);
            let random_variable = Math.random();
            random_variable *= .6;
            random_variable += .2;
            event.pan = event.pan + random_variable
            if (event.channel >= 9 && event.channel < 10) {
             event.channel = 1;
             csound.message('Reassigned...\n');
            }
            } 
            // Shorten duration preserving corrections...
            lsys.score.setDuration(9*60);
            // Bring in final notes.
            let size = lsys.score.data.length;
            lsys.score.data[size - 1].time = (lsys.score.data[size - 1].time - 12.);
            lsys.score.data[size - 2].time = (lsys.score.data[size - 2].time - 12.);
            if (true) {
            let start_shortening = 4*60+40;
            let old_end_shortening = 4*60+57;
            let old_duration = old_end_shortening - start_shortening;
            let new_end_shortening = old_end_shortening - 18;
            let new_duration = new_end_shortening - start_shortening;
            let shrinkage = new_duration / old_duration;
            for (var i = 0; i < lsys.score.data.length; i++) {
             var event = lsys.score.data[i];
             // Try transposing without changing interval structure.
             event.key += 1;
             if (event.time >= old_end_shortening) {
             let old_time = event.time;
             let old_end = event.end;
             event.time = event.time - start_shortening;
             if (old_time < old_end_shortening) {
              event.time = event.time * shrinkage;
              if (old_end < old_end_shortening) {
              event.duration = event.duration * shrinkage;
              } 
             }
             event.time = event.time + start_shortening;
             }
            }
            }
            if (false) {
            let start_shortening = 4*60+40;
            ///let old_end_shortening = 4*60+48;
            let old_end_shortening = 290;;
            let old_duration = old_end_shortening - start_shortening;
            let new_end_shortening = 270;
            let new_duration = new_end_shortening - start_shortening;
            let shrinkage = new_duration / old_duration;
            for (var i = 0; i < lsys.score.data.length; i++) {
             var event = lsys.score.data[i];
             // Try transposing without changing interval structure.
             event.key += 1;
             if (event.time >= old_end_shortening) {
             let old_time = event.time;
             let old_end = event.end;
             event.time = event.time - start_shortening;
             if (old_time < old_end_shortening) {
              event.time = event.time * shrinkage;
              if (old_end < old_end_shortening) {
              event.duration = event.duration * shrinkage;
              } 
             }
             event.time = event.time + start_shortening;
             }
            }
            }
                     
            csound.message("Plotting score...\n");
            lsys.score.draw3D(document.getElementById("canvas"));
            csound.message('Generated ' + lsys.score.data.length + ' notes.\n');
            } catch(err) {
            csound.message(err.name + ': ' + err.message + ' ' + err.line + '\n');
            }
            };
            
            // Message level for standard (terminal) output. Takes the sum of any of the following values:
            // 1 = note amplitude messages
            // 2 = samples out of range message
            // 4 = warning messages
            // 128 = print benchmark information
            // And exactly one of these to select note amplitude format:
            // 0 = raw amplitudes, no colours
            // 32 = dB, no colors
            // 64 = dB, out of range highlighted with red
            // 96 = dB, all colors
            // 256 = raw, out of range highlighted with red
            // 512 = raw, all colours 
            var render = function(soundfile, post_process) {
            var csd = document.getElementById('csd').value;
            var csound_score = lsys.score.toCsoundScore();
            csound_score = csound_score.concat("\n</CsScore>");
            csd = csd.replace("</CsScore>", csound_score);
            csound.message("Playing...");
            csound.setOption(sprintf('-m%d', 2 + 128 + 32));
            csound.setOption('--nodisplays');
            csound.setOption('--keep-sorted-score');
            csound.setOption('-R');
            csound.setOption('-W');
            csound.setOption('-f');
            csound.setOption('-o' + soundfile_name);
            //csound.setOption('-odac');
            try {
               csound.setMetadata("artist", "Michael Gogins");
               csound.setMetadata("copyright", "Copyright 2021 by Michael Gogins");
               csound.setMetadata("performer", "Mike Gogins");
               csound.setMetadata("title", title);
               csound.setMetadata("album", "Silence");
               csound.setMetadata("track", "1");
               csound.setMetadata("tracknumber", "1");
               csound.setMetadata("date", "2021");
               csound.setMetadata("publisher", "Irreducible Productions ASCAP");
               csound.setMetadata("comment", "Lindenmayer system in chord space.");
               csound.setMetadata("license", "CC BY-NC-SA");
               csound.setMetadata("genre", "Electroacoustic");
            } catch (e) {
               csound.message(e);
            }
            if (soundfile === true) {
               csound.setOutput(title + ".wav", "wav", "float");
            } else {
               csound.setOutput("dac", "wav", "float");
            }
            if (typeof fs != 'undefined') {
               fs.writeFileSync(title + "-generated.csd", csd);
            }
            csound.compileCsdText(csd);
            csound.message("Rendering...");
            csound.start();
            if (post_process == true) {
               try {
                   csound.performAndPostProcess();
               } catch (x) {
                   csound.message(x);
               }
            } else {
               csound.perform();
            }
            updateScoreTime();
            }
            
            var render_audio = function() {
            render(false, false);
            }
            
            var render_soundfile = function() {
            render(true, false);
            }
            
            var render_soundfile_and_postprocess = function() {
            render(true, true);
            }
            
            var stop = function() {
            Silencio.saveDatGuiJson(gui);
            csound.stop();
            }
            
            var updateScoreTime = function() {
            var score_time = csound.getScoreTime();
            setTimeout(updateScoreTime, 200);
            lsys.score.progress3D(score_time);
            };
            
            var parameters = {
            gk_FMWaterBell_level: 15,
            gi_FMWaterBell_attack: 0.002,
            gi_FMWaterBell_release: 0.01,
            gi_FMWaterBell_exponent: 15,
            gi_FMWaterBell_sustain: 20,
            gi_FMWaterBell_sustain_level: .1,
            gk_FMWaterBell_index: .5,
            gk_FMWaterBell_crossfade: .5,
            gk_FMWaterBell_vibrato_depth: 0.05,
            gk_FMWaterBell_vibrato_rate: 6,
            gk_Bower_level: 0.5,
            gk_Bower_pressure: 0.25,
            gk_Blower_grainDensity: .150,
            gk_Blower_grainDuration: .2,
            gk_Blower_grainAmplitudeRange: .1,
            gk_Blower_grainFrequencyRange: .033,
            gk_Blower_level: 0.5,
            gk_Buzzer_harmonics: 15,
            gk_Buzzer_level: 0.5,
            gk_Droner_partial1: 0.1,
            gk_Droner_partial2: 0.1,
            gk_Droner_partial3: 0.1,
            gk_Droner_partial4: 0.1,
            gk_Droner_partial5: 0.1,
            gk_Droner_level: 30,
            gk_Phaser_ratio1: 1,
            gk_Phaser_ratio2: .3333334,
            gk_Phaser_index1: 1,
            gk_Phaser_index2: .0125,
            gk_Phaser_level: 0.5,
            gk_PianoteqOut_level: 0.5,
            gk_Shiner_level: 0.5,
            gk_Sweeper_britel: 0,
            gk_Sweeper_briteh: 2.9,
            gk_Sweeper_britels: .2 / 3,
            gk_Sweeper_britehs: 2.5 / 2,
            gk_Sweeper_level: 0.5,
            gk_ZakianFlute_level: 0,
            gk_MVerb_feedback: .975,
            gk_ReverbSC_feedback: .8,
            gk_MasterOutput_level: .4,
            gk_overlap: 0.05,
            generate: window.generate,
            render_audio: window.render_audio,
            render_soundfile: window.render_soundfile,
            render_soundfile_and_postprocess: window.render_soundfile_and_postprocess,
            stop: window.stop,
            };

var handleMessage = function(message) {
    console.log(message);
    var messages_textarea = document.getElementById("console");
    var existing = messages_textarea.value;
    messages_textarea.value = existing + message;
    messages_textarea.scrollTop = messages_textarea.scrollHeight;
}
            
            var default_json = {
            "preset": "Default",
            "remembered": {
            "Default": {
            "0": {
            "gk_overlap": 5.504950495049505,
            "gk_MVerb_feedback": 0.975,
            "gk_ReverbSC_feedback": 0.85,
            "gk_MasterOutput_level": -10,
            "gi_FMWaterBell_attack": 0.002936276551436901,
            "gi_FMWaterBell_release": 0.022698875468554768,
            "gi_FMWaterBell_exponent": 12.544773011245312,
            "gi_FMWaterBell_sustain": 5.385256143273636,
            "gi_FMWaterBell_sustain_level": 0.08267388588088297,
            "gk_FMWaterBell_crossfade": 0.48250728862973763,
            "gk_FMWaterBell_index": 1.1401499375260309,
            "gk_FMWaterBell_vibrato_depth": 0.2897954989209742,
            "gk_FMWaterBell_vibrato_rate": 4.762100503545371,
            "gk_FMWaterBell_level": 35., 
            "gk_Phaser_ratio1": 1,
            "gk_Phaser_ratio2": 5./3.,
            "gk_Phaser_index1": 1,
            "gk_Phaser_index2": 2,
            "gk_Phaser_level": 14,
            "gk_Bower_pressure": 3.050919377652051,
            "gk_Bower_level": -12.677504515770458,
            "gk_Droner_partial1": 0.11032374600527997,
            "gk_Droner_partial2": 0.4927052938724468,
            "gk_Droner_partial3": 0.11921634014172572,
            "gk_Droner_partial4": 0.06586077532305128,
            "gk_Droner_partial5": 0.6616645824649159,
            "gk_Droner_level": 10.,
            "gk_Sweeper_britel": 0.2773844231570179,
            "gk_Sweeper_briteh": 3.382178217821782,
            "gk_Sweeper_britels": 0.19575671852899576,
            "gk_Sweeper_britehs": 0.8837340876944837,
            "gk_Sweeper_level": 10,
            "gk_Buzzer_harmonics": 2.608203677510608,
            "gk_Buzzer_level": 27.56,
            "gk_Shiner_level": 16,
            "gk_Blower_grainDensity": 79.99177885109444,
            "gk_Blower_grainDuration": 0.2,
            "gk_Blower_grainAmplitudeRange": 87.88408180043162,
            "gk_Blower_grainFrequencyRange": 30.596081700708627,
            "gk_Blower_level": 4,
            "gk_ZakianFlute_level": 0,
            "gk_PianoteqOut_level": 14.5
            }
            }
            },
            "closed": false,
            "folders": {
            "Master": {
            "preset": "Default",
            "closed": true,
            "folders": {}
            },
            "FMWaterBell": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Phaser": {
            "preset": "Default",
            "closed": true,
            "folders": {}
            },
            "Bower": {
            "preset": "Default",
            "closed": true,
            "folders": {}
            },
            "Droner": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Sweeper": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Buzzer": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Shiner": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Blower": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            },
            "Pianoteq": {
            "preset": "Default",
            "closed": false,
            "folders": {}
            }
            }
            };
            
        window.onload = async function () {
            await get_csound(handleMessage);
            try {
            var temporary_json = Silencio.restoreDatGuiJson(default_json);
            //default_json = temporary_json;
            gui = new dat.GUI({load: default_json, width: 300});
            csound.message("Restored Csound instrument parameters.\n");
            } catch(e) {
            csound.message("Failed to restore Csound instrument parameters.\n");
            gui = new dat.GUI({width: 400});
            }
            gui.remember(parameters);
            gui.add(parameters, 'generate').name('Generate [Ctrl-G]');
            gui.add(parameters, 'render_audio').name('Render audio [Ctrl-A]');
            gui.add(parameters, 'render_soundfile').name('Render soundfile');
            gui.add(parameters, 'render_soundfile_and_postprocess').name('Render/post [Ctrl-P]');
            gui.add(parameters, 'stop').name('Stop [Ctrl-S]');
            var Master = gui.addFolder('Master');
            add_slider(Master, 'gk_overlap', 0, 20);
            add_slider(Master, 'gk_MVerb_feedback', 0, 1);
            add_slider(Master, 'gk_ReverbSC_feedback', 0, 1);
            add_slider(Master, 'gk_MasterOutput_level', -40, 40);
            var FMWaterBell = gui.addFolder('FMWaterBell');
            add_slider(FMWaterBell, 'gi_FMWaterBell_attack', 0, .1);
            add_slider(FMWaterBell, 'gi_FMWaterBell_release', 0, .1);
            add_slider(FMWaterBell, 'gi_FMWaterBell_exponent', -30, 30);
            add_slider(FMWaterBell, 'gi_FMWaterBell_sustain', 0, 20);
            add_slider(FMWaterBell, 'gi_FMWaterBell_sustain_level', 0, 1);
            add_slider(FMWaterBell, 'gk_FMWaterBell_crossfade', 0, 1);
            add_slider(FMWaterBell, 'gk_FMWaterBell_index', 0, 15);
            add_slider(FMWaterBell, 'gk_FMWaterBell_vibrato_depth', 0, 10);
            add_slider(FMWaterBell, 'gk_FMWaterBell_vibrato_rate', 0, 10);
            add_slider(FMWaterBell, 'gk_FMWaterBell_level',-40, 40);
            var Phaser = gui.addFolder('Phaser');
            add_slider(Phaser, 'gk_Phaser_ratio1', 0, 5);
            add_slider(Phaser, 'gk_Phaser_ratio2', 0, 5);
            add_slider(Phaser, 'gk_Phaser_index1', 0, 15);
            add_slider(Phaser, 'gk_Phaser_index2', 0, 15);
            add_slider(Phaser, 'gk_Phaser_level', -40, 40);
            var Bower = gui.addFolder('Bower');
            add_slider(Bower, 'gk_Bower_pressure', 0, 5);
            add_slider(Bower, 'gk_Bower_level', -40, 40);
            var Droner = gui.addFolder('Droner');
            add_slider(Droner, 'gk_Droner_partial1', 0, 1);
            add_slider(Droner, 'gk_Droner_partial2', 0, 1);
            add_slider(Droner, 'gk_Droner_partial3', 0, 1);
            add_slider(Droner, 'gk_Droner_partial4', 0, 1);
            add_slider(Droner, 'gk_Droner_partial5', 0, 1);
            add_slider(Droner, 'gk_Droner_level', -40, 40);
            var Sweeper = gui.addFolder('Sweeper');
            add_slider(Sweeper, 'gk_Sweeper_britel', 0, 4);
            add_slider(Sweeper, 'gk_Sweeper_briteh', 0, 4);
            add_slider(Sweeper, 'gk_Sweeper_britels', 0, 4);
            add_slider(Sweeper, 'gk_Sweeper_britehs', 0, 4);
            add_slider(Sweeper, 'gk_Sweeper_level', -40, 40);
            var Buzzer = gui.addFolder('Buzzer');
            add_slider(Buzzer, 'gk_Buzzer_harmonics', 0, 20);
            add_slider(Buzzer, 'gk_Buzzer_level', -40, 40);
            var Shiner = gui.addFolder('Shiner');
            add_slider(Shiner, 'gk_Shiner_level', -40, 40);
            var Blower = gui.addFolder('Blower');
            add_slider(Blower, 'gk_Blower_grainDensity', 0, 400);
            add_slider(Blower, 'gk_Blower_grainDuration', 0, .5);
            add_slider(Blower, 'gk_Blower_grainAmplitudeRange', 0, 400);
            add_slider(Blower, 'gk_Blower_grainFrequencyRange', 0, 100);
            add_slider(Blower, 'gk_Blower_level', -40, 40);
            var Flute = gui.addFolder('Zakian Flute');
            add_slider(Flute, 'gk_ZakianFlute_level', -40, 40);
            var Pianoteq = gui.addFolder('Pianoteq');
            add_slider(Pianoteq, 'gk_PianoteqOut_level', -40, 40);
            gui.revert(); 
            document.addEventListener("keydown", function (e) {
            var e_char = String.fromCharCode(e.keyCode || e.charCode);
            if (e.ctrlKey === true) {
             if (e_char === 'H') {
             var console = document.getElementById("console");
             if (console.style.display === "none") {
              console.style.display = "block";
             } else {
              console.style.display = "none";
             }
             gui.closed = true;
             gui.closed = false;
             } else if (e_char === 'G') {
             generate();
             } else if (e_char === 'P') {
             parameters.play();
             } else if (e_char === 'S') {
             parameters.stop();
             }
            }
            });
            };
            
            var gk_update = function(name, value) {
                var numberValue = parseFloat(value);
                if (csound.IsPlaying()) {
                    csound.setControlChannel(name, numberValue);
                }
            }
            
            var add_slider = function(gui_folder, token, minimum, maximum, name) {
                var on_parameter_change = function(value) {
                    gk_update(token, value);
                };
                gui_folder.add(parameters, token, minimum, maximum).onChange(on_parameter_change);
            };
            
            window.addEventListener("unload", function(event) { 
                parameters.stop();
                nw_window.close();
            });

        </script>
        <textarea class="code" id="csd" hidden rows=24 cols=80>
<CsoundSynthesizer>
<CsOptions>
-dm195
</CsOptions>
<CsInstruments>
; Change to 96000 with 1 ksmps for final rendering.
sr = 96000
ksmps = 100
nchnls = 2
0dbfs = 2

; Ensure the same random stream for each rendering.
; rand, randh, randi, rnd(x) and birnd(x) are not affected by seed.

;seed 81814
;seed 818145
seed 88818145

gS_source_code = {{

    #include <csound/csdl.h>

    extern "C" void entry_point(CSOUND *csound) {
        csound->Message(csound, "Hello, World\\n");
    };

}}

;;gi_result clang_compile "entry_point", gS_source_code, "-I/usr/local/include/csound", "/usr/lib/gcc/x86_64-linux-gnu/9/libstdc++.so"

connect "Blower", "outleft", "ReverbSC", "inleft"
connect "Blower", "outright", "ReverbSC", "inright"
connect "Bower", "outleft", "ReverbSC", "inleft"
connect "Bower", "outright", "ReverbSC", "inright"
connect "Buzzer", "outleft", "ReverbSC", "inleft"
connect "Buzzer", "outright", "ReverbSC", "inright"
connect "Droner", "outleft", "ReverbSC", "inleft"
connect "Droner", "outright", "ReverbSC", "inright"
connect "FMWaterBell", "outleft", "ReverbSC", "inleft"
connect "FMWaterBell", "outright", "ReverbSC", "inright"
connect "Phaser", "outleft", "ReverbSC", "inleft"
connect "Phaser", "outright", "ReverbSC", "inright"
connect "PianoNotePianoteq", "outleft", "MasterOutput", "inleft"
connect "PianoNotePianoteq", "outright", "MasterOutput", "inright"
connect "Sweeper", "outleft", "ReverbSC", "inleft"
connect "Sweeper", "outright", "ReverbSC", "inright"
connect "Shiner", "outleft", "ReverbSC", "inleft"
connect "Shiner", "outright", "ReverbSC", "inright"
connect "ZakianFlute", "outleft", "ReverbSC", "inleft"
connect "ZakianFlute", "outright", "ReverbSC", "inright"
;;connect "ReverbSC", "outleft", "MVerb", "inleft"
;;connect "ReverbSC", "outright", "MVerb", "inright"
;;connect "MVerb", "outleft", "MasterOutput", "inleft"
;;connect "MVerb", "outright", "MasterOutput", "inright"
connect "ReverbSC", "outleft", "MasterOutput", "inleft"
connect "ReverbSC", "outright", "MasterOutput", "inright"

alwayson "Controls"
alwayson "PianoteqOut"
//alwayson "MVerb"
alwayson "ReverbSC"
alwayson "MasterOutput"

gk_overlap init 4.5

prealloc 1, 50
prealloc 2, 50
prealloc 3, 50
prealloc 4, 50
prealloc 5, 50
prealloc 6, 50
prealloc 7, 50
prealloc 8, 20
prealloc 9, 20

//////////////////////////////////////////////
// Original by Steven Yi.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
gk_FMWaterBell_level chnexport "gk_FMWaterBell_level", 3 ; 0
gi_FMWaterBell_attack chnexport "gi_FMWaterBell_attack", 3 ; 0.002
gi_FMWaterBell_release chnexport "gi_FMWaterBell_release", 3 ; 0.01
gi_FMWaterBell_sustain chnexport "gi_FMWaterBell_sustain", 3 ; 20
gi_FMWaterBell_sustain_level chnexport "gi_FMWaterBell_sustain_level", 3 ; .1
gk_FMWaterBell_index chnexport "gk_FMWaterBell_index", 3 ; .5
gk_FMWaterBell_crossfade chnexport "gk_FMWaterBell_crossfade", 3 ; .5
gk_FMWaterBell_vibrato_depth chnexport "gk_FMWaterBell_vibrato_depth", 3 ; 0.05
gk_FMWaterBell_vibrato_rate chnexport "gk_FMWaterBell_vibrato_rate", 3 ; 6
gk_FMWaterBell_midi_dynamic_range chnexport "gk_FMWaterBell_midi_dynamic_range", 3 ; 20

gk_FMWaterBell_level init 0
gi_FMWaterBell_attack init 0.002
gi_FMWaterBell_release init 0.01
gi_FMWaterBell_sustain init 20
gi_FMWaterBell_sustain_level init .1
gk_FMWaterBell_index init .5
gk_FMWaterBell_crossfade init .5
gk_FMWaterBell_vibrato_depth init 0.05
gk_FMWaterBell_vibrato_rate init 6
gk_FMWaterBell_midi_dynamic_range init 20

gi_FMWaterBell_cosine ftgen 0, 0, 65537, 11, 1

instr FMWaterBell
i_instrument = p1
i_time = p2
i_duration = p3
; One of the envelopes in this instrument should be releasing, and use this:
i_sustain = 1000
xtratim gi_FMWaterBell_attack + gi_FMWaterBell_release
i_midi_key = p4
i_midi_dynamic_range = i(gk_FMWaterBell_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.6 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 75
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization * 1.6
k_gain = ampdb(gk_FMWaterBell_level)
a_signal fmbell	1, i_frequency, gk_FMWaterBell_index, gk_FMWaterBell_crossfade, gk_FMWaterBell_vibrato_depth, gk_FMWaterBell_vibrato_rate, gi_FMWaterBell_cosine, gi_FMWaterBell_cosine, gi_FMWaterBell_cosine, gi_FMWaterBell_cosine, gi_FMWaterBell_cosine ;, gi_FMWaterBell_sustain
;a_envelope linsegr 0, gi_FMWaterBell_attack, 1, i_sustain, gi_FMWaterBell_sustain_level, gi_FMWaterBell_release, 0
a_envelope linsegr 0, gi_FMWaterBell_attack, 1, i_sustain, 1, gi_FMWaterBell_release, 0
; ares transegr ia, idur, itype, ib [, idur2] [, itype] [, ic] ...
; a_envelope transegr 0, gi_FMWaterBell_attack, 12, 1, i_sustain, 12, gi_FMWaterBell_sustain_level, gi_FMWaterBell_release, 12, 0
a_signal = a_signal * i_amplitude * a_envelope * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_Phaser_attack chnexport "gk_Phaser_attack", 3 ;  .125
gk_Phaser_release chnexport "gk_Phaser_release", 3 ;  .125
gk_Phaser_ratio1 chnexport "gk_Phaser_ratio1", 3 ;  1
gk_Phaser_ratio2 chnexport "gk_Phaser_ratio2", 3 ;  1/5
gk_Phaser_index1 chnexport "gk_Phaser_index1", 3 ;  1.01
gk_Phaser_index2 chnexport "gk_Phaser_index2", 3 ;  .103
gk_Phaser_level chnexport "gk_Phaser_level", 3 ;  0.5
gk_Phaser_midi_dynamic_range chnexport "gk_Phaser_midi_dynamic_range", 3 ;  20

gk_Phaser_attack init .125
gk_Phaser_release init .125
gk_Phaser_ratio1 init 1
gk_Phaser_ratio2 init 1/5
gk_Phaser_index1 init 1.01
gk_Phaser_index2 init .103
gk_Phaser_level init 0.5
gk_Phaser_midi_dynamic_range init 20

gi_Phaser_sine ftgen 0,0,65537,10,1

instr Phaser
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Phaser_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 81
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Phaser_level)
i_attack = i(gk_Phaser_attack)
i_release = i(gk_Phaser_release)
i_sustain = 1000
xtratim i_attack + i_release
a_envelope transegr 0.0, i_attack / 2.0, 1.5, i_amplitude / 2.0, i_attack / 2.0, -1.5, i_amplitude, i_sustain, 0.0, i_amplitude, i_release / 2.0, 1.5, i_amplitude / 2.0, i_release / 2.0, -1.5, 0
a1,a2 crosspm gk_Phaser_ratio1, gk_Phaser_ratio2, gk_Phaser_index1, gk_Phaser_index2, i_frequency, gi_Phaser_sine, gi_Phaser_sine
a_signal = (a1 + a2) * k_gain * a_envelope

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
;printks "Phaser         i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(aleft)), dbamp(rms(aright))
endin

gk_Droner_partial1 chnexport "gk_Droner_partial1", 3
gk_Droner_partial2 chnexport "gk_Droner_partial2", 3
gk_Droner_partial3 chnexport "gk_Droner_partial3", 3
gk_Droner_partial4 chnexport "gk_Droner_partial4", 3
gk_Droner_partial5 chnexport "gk_Droner_partial5", 3
gk_Droner_partial6 chnexport "gk_Droner_partial6", 3
gk_Droner_partial7 chnexport "gk_Droner_partial7", 3
gk_Droner_partial8 chnexport "gk_Droner_partial8", 3
gk_Droner_partial9 chnexport "gk_Droner_partial9", 3
gk_Droner_partial10 chnexport "gk_Droner_partial10", 3
gk_Droner_level chnexport "gk_Droner_level", 3
gi_Droner_waveform chnexport "gi_Droner_waveform", 3

gk_Droner_partial1 init .5
gk_Droner_partial2 init .05
gk_Droner_partial3 init .1
gk_Droner_partial4 init .2
gk_Droner_partial5 init .1
gk_Droner_partial6 init 0
gk_Droner_partial7 init 0
gk_Droner_partial8 init 0
gk_Droner_partial9 init 0
gk_Droner_partial10 init 0
gk_Droner_level init 0
gi_Droner_waveform init 0

gi_Droner_sine ftgen 0, 0, 65537, 10, 1, 0, .02

instr Droner
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_velocity = p5
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_overall_amps = -20 + 98 + 4
i_normalization = ampdb(-i_overall_amps) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Droner_level)
k1 = gk_Droner_partial1
k2 = gk_Droner_partial2
k3 = gk_Droner_partial3
k4 = gk_Droner_partial4
k5 = gk_Droner_partial5
k6 = gk_Droner_partial6
k7 = gk_Droner_partial7
k8 = gk_Droner_partial8
k9 = gk_Droner_partial9
k10 = gk_Droner_partial10
iwaveform = gi_Droner_waveform
iattack = .5
idecay = .5
xtratim iattack + idecay
isustain = p3
aenvelope transegr 0.0, iattack / 2.0, 1.5, 1 / 2.0, iattack / 2.0, -1.5, 1, isustain, 0.0, 1, idecay / 2.0, 1.5, 1 / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(i_midi_key)
if iwaveform == 0 goto i_waveform_0
if iwaveform == 1 goto i_waveform_1
if iwaveform == 2 goto i_waveform_2
i_waveform_0:
asignal poscil3 1, ihertz, gi_Droner_sine
goto i_waveform_endif
i_waveform_1:
asignal vco2 1, ihertz, 8 ; integrated saw
goto i_waveform_endif
i_waveform_2:
asignal vco2 1, ihertz, 12 ; triangle
i_waveform_endif:
asignal chebyshevpoly asignal, 0, k1, k2, k3, k4, k5, k6, k7, k8, k9, k10
adeclicking linsegr 0, .004, 1, p3 - .014, 1, .1, 0
a_signal = asignal * adeclicking
a_signal = a_signal * i_amplitude * k_gain * 1.4

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_Sweeper_midi_dynamic_range chnexport "gk_Sweeper_midi_dynamic_range", 3 ;  127
gk_Sweeper_attack chnexport "gk_Sweeper_attack", 3 ;  .125
gk_Sweeper_release chnexport "gk_Sweeper_release", 3 ;  .25
gk_Sweeper_britel chnexport "gk_Sweeper_britel", 3 ;  0.1
gk_Sweeper_briteh chnexport "gk_Sweeper_briteh", 3 ;  2.9
gk_Sweeper_britels chnexport "gk_Sweeper_britels", 3 ;  2
gk_Sweeper_britehs chnexport "gk_Sweeper_britehs", 3 ;  1
gk_Sweeper_level chnexport "gk_Sweeper_level", 3 ;  0

gk_Sweeper_midi_dynamic_range init 20
gk_Sweeper_attack init .125
gk_Sweeper_release init .25
gk_Sweeper_britel init 0.1
gk_Sweeper_briteh init 2.9
gk_Sweeper_britels init 2
gk_Sweeper_britehs init 1
gk_Sweeper_level init 0

gi_Sweeper_sine ftgen 0, 0, 65537, 10, 1
gi_Sweeper_octfn ftgen 0, 0, 65537, -19, 1, 0.5, 270, 0.5

instr Sweeper
//////////////////////////////////////////////
// Original by Iain McCurdy.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Sweeper_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 71.5
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Sweeper_level)

iattack = i(gk_Sweeper_attack)
irelease = i(gk_Sweeper_release)
isustain = p3
xtratim iattack + irelease
kenvelope transegr 0.0, iattack / 2.0, 1.5, i_amplitude / 2.0, iattack / 2.0, -1.5, i_amplitude, isustain, 0.0, i_amplitude, irelease / 2.0, 1.5, i_amplitude / 2.0, irelease / 2.0, -1.5, 0
ihertz = i_frequency
icps = ihertz
kamp expseg 0.001,0.02,0.2,p3-0.01,0.001
ktonemoddep jspline 0.01,0.05,0.2
ktonemodrte jspline 6,0.1,0.2
ktone poscil3 ktonemoddep, ktonemodrte, gi_Sweeper_sine
kbrite rspline gk_Sweeper_britel, gk_Sweeper_briteh, gk_Sweeper_britels, gk_Sweeper_britehs
ibasfreq init icps
ioctcnt init 3
iphs init 0
a1 hsboscil kenvelope, ktone, kbrite, ibasfreq, gi_Sweeper_sine, gi_Sweeper_octfn, ioctcnt, iphs
amod poscil3 0.25, ibasfreq*(1/3), gi_Sweeper_sine
arm = a1*amod
kmix expseg 0.001, 0.01, rnd(1), rnd(3)+0.3, 0.001
kmix=.25
a1 ntrpol a1, arm, kmix
kpanrte jspline 5, 0.05, 0.1
kpandep jspline 0.9, 0.2, 0.4
kpan poscil3 kpandep, kpanrte, gi_Sweeper_sine
;a1,a2 pan2 a1, kpan
a1,a2 pan2 a1, k_space_left_to_right
aleft delay a1, rnd(0.1)
aright delay a2, rnd(0.11)
a_signal = (aleft + aright) * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_Buzzer_attack chnexport "gk_Buzzer_attack", 3
gk_Buzzer_release chnexport "gk_Buzzer_release", 3
gk_Buzzer_harmonics chnexport "gk_Buzzer_harmonics", 3
gk_Buzzer_level chnexport "gk_Buzzer_level", 3
gk_Buzzer_midi_dynamic_range chnexport "gk_Buzzer_midi_dynamic_range", 3

gk_Buzzer_attack init .125
gk_Buzzer_release init .25
gk_Buzzer_harmonics init 8
gk_Buzzer_level init 0
gk_Buzzer_midi_dynamic_range init 20

gi_Buzzer_sine ftgen 0, 0, 65537, 10, 1

instr Buzzer
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Buzzer_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 75
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Buzzer_level)
i_attack = i(gk_Buzzer_attack)
i_release = i(gk_Buzzer_release)
i_sustain = p3
xtratim i_attack + i_release
a_envelope transegr 0.0, i_attack / 2.0, 1.5, i_amplitude / 2.0, i_attack / 2.0, -1.5, i_amplitude, i_sustain, 0.0, i_amplitude, i_release / 2.0, 1.5, i_amplitude / 2.0, i_release / 2.0, -1.5, 0
a_signal buzz a_envelope, i_frequency, gk_Buzzer_harmonics, gi_Buzzer_sine
a_signal = a_signal * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
;printks "Buzzer         i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(a_out_left)), dbamp(rms(a_out_right))
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_Shiner_midi_dynamic_range chnexport "gk_Shiner_midi_dynamic_range", 3 ;  127
gk_Shiner_attack chnexport "gk_Shiner_attack", 3 ;  .0125
gk_Shiner_release chnexport "gk_Shiner_release", 3 ;  .0125
gk_Shiner_level chnexport "gk_Shiner_level", 3 ;  0.5

gk_Shiner_midi_dynamic_range init 20
gk_Shiner_attack init .0125
gk_Shiner_release init .0125
gk_Shiner_level init 0.5

instr Shiner
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Shiner_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 80
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Shiner_level)

iattack = i(gk_Shiner_attack)
idecay = i(gk_Shiner_release)
isustain = p3 - i(gk_Shiner_attack)
xtratim iattack + idecay
kenvelope transeg 0.0, iattack / 2.0, 1.5, i_amplitude / 2.0, iattack / 2.0, -1.5, i_amplitude, isustain, 0.0, i_amplitude, idecay / 2.0, 1.5, i_amplitude / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(i_midi_key)
gk_Harmonics = 1 * 20
asignal vco2 kenvelope * 4, ihertz, 12
kgain = ampdb(gk_Shiner_level) * .5
adamping linseg 0, 0.03, 1, p3 - 0.1, 1, 0.07, 0
a_signal = asignal * kgain * adamping

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, gk_PianoOutPianoteq_front_to_back, gk_PianoOutPianoteq_left_to_right, gk_PianoOutPianoteq_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_Blower_grainDensity chnexport "gk_Blower_grainDensity", 3
gk_Blower_grainDuration chnexport "gk_Blower_grainDuration", 3
gk_Blower_grainAmplitudeRange chnexport "gk_Blower_grainFrequencyRange", 3
gk_Blower_grainFrequencyRange chnexport "XXX", 3
gk_Blower_level chnexport "gk_Blower_level", 3
gk_Blower_midi_dynamic_range chnexport "gk_Blower_midi_dynamic_range", 3

gk_Blower_grainDensity init 40
gk_Blower_grainDuration init 0.2
gk_Blower_grainAmplitudeRange init 100
gk_Blower_grainFrequencyRange init 3
gk_Blower_level init 0
gk_Blower_midi_dynamic_range init 20

gi_Blower_grtab ftgen 0, 0, 65537, 10, 1, .3, .1, 0, .2, .02, 0, .1, .04
gi_Blower_wintab ftgen 0, 0, 65537, 10, 1, 0, .5, 0, .33, 0, .25, 0, .2, 0, .167

instr Blower
//////////////////////////////////////////////
// Original by Hans Mikelson.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Blower_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 123
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Blower_level)
iHz = i_frequency
ihertz = iHz
ip4 = i_amplitude
ip5 = iHz
ip6 = gi_Blower_grtab
ip7 = gi_Blower_wintab
ip8 = 0.033
ip8 = .002
ip9 = 150
ip9 = 100
ip10 = 1.6
ip10 = 3
idur = p3
iamp = i_amplitude ; p4
ifqc = iHz ; cpspch(p5)
igrtab = ip6
iwintab = ip7
ifrng = ip8
idens = ip9
ifade = ip10
igdur = 0.2
iattack = 0.5
i_sustain = p3
idecay = 1.5
xtratim iattack + idecay
kenvelope transegr 0.0, iattack / 2.0, 1.5, .5, iattack / 2.0, -1.5, 1, i_sustain, 0.0, 1, idecay / 2.0, 1.5, .5, idecay / 2.0, -1.5, 0
; kamp linseg 0, ifade, 1, idur - 2 * ifade, 1, ifade, 0
kamp = kenvelope
; Amp Fqc Dense AmpOff PitchOff GrDur GrTable WinTable MaxGrDur
aoutl grain ip4, ifqc, gk_Blower_grainDensity, gk_Blower_grainAmplitudeRange, gk_Blower_grainFrequencyRange, gk_Blower_grainDuration, igrtab, iwintab, 5
aoutr grain ip4, ifqc, gk_Blower_grainDensity, gk_Blower_grainAmplitudeRange, gk_Blower_grainFrequencyRange, gk_Blower_grainDuration, igrtab, iwintab, 5
a_signal = aoutl + aoutr
i_attack = .002
i_release = 0.01
xtratim i_attack + i_release
a_declicking linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * i_amplitude * a_declicking * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
;printks "Blower         i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(a_out_left)), dbamp(rms(a_out_right))
endin

gk_ZakianFlute_midi_dynamic_range chnexport "gk_ZakianFlute_midi_dynamic_range", 3 ;  20
gk_ZakianFlute_level chnexport "gk_ZakianFlute_level", 3 ;  0
gk_ZakianFlute_pan chnexport "gk_ZakianFlute_pan", 3 ;  .5
gi_ZakianFLute_seed chnexport "gi_ZakianFLute_seed", 3 ;  .5

gk_ZakianFlute_midi_dynamic_range init 20
gk_ZakianFlute_level init 0
gk_ZakianFlute_pan init .5
gi_ZakianFLute_seed init .5

gi_ZakianFLute_f2  ftgen 0, 0, 16, -2, 40, 40, 80, 160, 320, 640, 1280, 2560, 5120, 10240, 10240
gi_ZakianFlute_f26 ftgen 0, 0, 65537, -10, 2000, 489, 74, 219, 125, 9, 33, 5, 5
gi_ZakianFlute_f27 ftgen 0, 0, 65537, -10, 2729, 1926, 346, 662, 537, 110, 61, 29, 7
gi_ZakianFlute_f28 ftgen 0, 0, 65537, -10, 2558, 2012, 390, 361, 534, 139, 53, 22, 10, 13, 10
gi_ZakianFlute_f29 ftgen 0, 0, 65537, -10, 12318, 8844, 1841, 1636, 256, 150, 60, 46, 11
gi_ZakianFlute_f30 ftgen 0, 0, 65537, -10, 1229, 16, 34, 57, 32
gi_ZakianFlute_f31 ftgen 0, 0, 65537, -10, 163, 31, 1, 50, 31
gi_ZakianFlute_f32 ftgen 0, 0, 65537, -10, 4128, 883, 354, 79, 59, 23
gi_ZakianFlute_f33 ftgen 0, 0, 65537, -10, 1924, 930, 251, 50, 25, 14
gi_ZakianFlute_f34 ftgen 0, 0, 65537, -10, 94, 6, 22, 8
gi_ZakianFlute_f35 ftgen 0, 0, 65537, -10, 2661, 87, 33, 18
gi_ZakianFlute_f36 ftgen 0, 0, 65537, -10, 174, 12
gi_ZakianFlute_f37 ftgen 0, 0, 65537, -10, 314, 13
gi_ZakianFlute_wtsin ftgen 0, 0, 65537, 10, 1

instr ZakianFlute
; Author: Lee Zakian
; Adapted by: Michael Gogins
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_velocity = p5
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_overall_amps = 65.2
i_normalization = ampdb(-i_overall_amps) / 2
i_midi_dynamic_range = i(gk_ZakianFlute_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_ZakianFlute_level)
iattack = .002
isustain = p3
irelease = .3
xtratim iattack + irelease
iHz = cpsmidinn(i_midi_key)
kHz = k(iHz)
aenvelope transeg 1.0, 20.0, -10.0, 0.05
ip3 = (p3 < 3.0 ? p3 : 3.0)
; parameters
; p4 overall amplitude scaling factor
ip4 init i_amplitude
; p5 pitch in Hertz (normal pitch range: C4-C7)
ip5 init iHz
; p6 percent vibrato depth, recommended values in range [-1., +1.]
ip6 init 0.5
; 0.0 -> no vibrato
; +1. -> 1% vibrato depth, where vibrato rate increases slightly
; -1. -> 1% vibrato depth, where vibrato rate decreases slightly
; p7 attack time in seconds
; recommended value: .12 for slurred notes, .06 for tongued notes
; (.03 for short notes)
ip7 init .08
; p8 decay time in seconds
; recommended value: .1 (.05 for short notes)
ip8 init .08
; p9 overall brightness / filter cutoff factor
; 1 -> least bright / minimum filter cutoff frequency (40 Hz)
; 9 -> brightest / maximum filter cutoff frequency (10,240Hz)
ip9 init 5
; initial variables
iampscale = ip4 ; overall amplitude scaling factor
ifreq = ip5 ; pitch in Hertz
ivibdepth = abs(ip6*ifreq/100.0) ; vibrato depth relative to fundamental frequency
iattack = ip7 * (1.1 - .2*gi_ZakianFLute_seed) ; attack time with up to +-10% random deviation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947) ; reset gi_ZakianFLute_seed
idecay = ip8 * (1.1 - .2*gi_ZakianFLute_seed) ; decay time with up to +-10% random deviation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
ifiltcut tablei ip9, gi_ZakianFLute_f2 ; lowpass filter cutoff frequency
iattack = (iattack < 6/kr ? 6/kr : iattack) ; minimal attack length
idecay = (idecay < 6/kr ? 6/kr : idecay) ; minimal decay length
isustain = p3 - iattack - idecay
p3 = (isustain < 5/kr ? iattack+idecay+5/kr : p3) ; minimal sustain length
isustain = (isustain < 5/kr ? 5/kr : isustain)
iatt = iattack/6
isus = isustain/4
idec = idecay/6
iphase = gi_ZakianFLute_seed ; use same phase for all wavetables
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
; vibrato block
; kvibdepth linseg .1, .8*p3, 1, .2*p3, .7
kvibdepth linseg .1, .8*ip3, 1, isustain, 1, .2*ip3, .7
kvibdepth = kvibdepth* ivibdepth ; vibrato depth
kvibdepthr randi .1*kvibdepth, 5, gi_ZakianFLute_seed ; up to 10% vibrato depth variation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kvibdepth = kvibdepth + kvibdepthr
ivibr1 = gi_ZakianFLute_seed ; vibrato rate
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
ivibr2 = gi_ZakianFLute_seed
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
if ip6 < 0 goto vibrato1
kvibrate linseg 2.5+ivibr1, p3, 4.5+ivibr2 ; if p6 positive vibrato gets faster
 goto vibrato2
vibrato1:
ivibr3 = gi_ZakianFLute_seed
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kvibrate linseg 3.5+ivibr1, .1, 4.5+ivibr2, p3-.1, 2.5+ivibr3 ; if p6 negative vibrato gets slower
vibrato2:
kvibrater randi .1*kvibrate, 5, gi_ZakianFLute_seed ; up to 10% vibrato rate variation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kvibrate = kvibrate + kvibrater
kvib oscili kvibdepth, kvibrate, gi_ZakianFlute_wtsin
ifdev1 = -.03 * gi_ZakianFLute_seed ; frequency deviation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
ifdev2 = .003 * gi_ZakianFLute_seed
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
ifdev3 = -.0015 * gi_ZakianFLute_seed
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
ifdev4 = .012 * gi_ZakianFLute_seed
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kfreqr linseg ifdev1, iattack, ifdev2, isustain, ifdev3, idecay, ifdev4
kfreq = kHz * (1 + kfreqr) + kvib
if ifreq < 427.28 goto range1 ; (cpspch(8.08) + cpspch(8.09))/2
if ifreq < 608.22 goto range2 ; (cpspch(9.02) + cpspch(9.03))/2
if ifreq < 1013.7 goto range3 ; (cpspch(9.11) + cpspch(10.00))/2
goto range4
; wavetable amplitude envelopes
range1: ; for low range tones
kamp1 linseg 0, iatt, 0.002, iatt, 0.045, iatt, 0.146, iatt, \
0.272, iatt, 0.072, iatt, 0.043, isus, 0.230, isus, 0.000, isus, \
0.118, isus, 0.923, idec, 1.191, idec, 0.794, idec, 0.418, idec, \
0.172, idec, 0.053, idec, 0
kamp2 linseg 0, iatt, 0.009, iatt, 0.022, iatt, -0.049, iatt, \
-0.120, iatt, 0.297, iatt, 1.890, isus, 1.543, isus, 0.000, isus, \
0.546, isus, 0.690, idec, -0.318, idec, -0.326, idec, -0.116, idec, \
-0.035, idec, -0.020, idec, 0
kamp3 linseg 0, iatt, 0.005, iatt, -0.026, iatt, 0.023, iatt, \
0.133, iatt, 0.060, iatt, -1.245, isus, -0.760, isus, 1.000, isus, \
0.360, isus, -0.526, idec, 0.165, idec, 0.184, idec, 0.060, idec, \
0.010, idec, 0.013, idec, 0
iwt1 = gi_ZakianFlute_f26 ; wavetable numbers
iwt2 = gi_ZakianFlute_f27
iwt3 = gi_ZakianFlute_f28
inorm = 3949
goto end
range2: ; for low mid-range tones
kamp1 linseg 0, iatt, 0.000, iatt, -0.005, iatt, 0.000, iatt, \
0.030, iatt, 0.198, iatt, 0.664, isus, 1.451, isus, 1.782, isus, \
1.316, isus, 0.817, idec, 0.284, idec, 0.171, idec, 0.082, idec, \
0.037, idec, 0.012, idec, 0
kamp2 linseg 0, iatt, 0.000, iatt, 0.320, iatt, 0.882, iatt, \
1.863, iatt, 4.175, iatt, 4.355, isus, -5.329, isus, -8.303, isus, \
-1.480, isus, -0.472, idec, 1.819, idec, -0.135, idec, -0.082, idec, \
-0.170, idec, -0.065, idec, 0
kamp3 linseg 0, iatt, 1.000, iatt, 0.520, iatt, -0.303, iatt, \
0.059, iatt, -4.103, iatt, -6.784, isus, 7.006, isus, 11, isus, \
12.495, isus, -0.562, idec, -4.946, idec, -0.587, idec, 0.440, idec, \
0.174, idec, -0.027, idec, 0
iwt1 = gi_ZakianFlute_f29
iwt2 = gi_ZakianFlute_f30
iwt3 = gi_ZakianFlute_f31
inorm = 27668.2
goto end
range3: ; for high mid-range tones
kamp1 linseg 0, iatt, 0.005, iatt, 0.000, iatt, -0.082, iatt, \
0.36, iatt, 0.581, iatt, 0.416, isus, 1.073, isus, 0.000, isus, \
0.356, isus, .86, idec, 0.532, idec, 0.162, idec, 0.076, idec, 0.064, \
idec, 0.031, idec, 0
kamp2 linseg 0, iatt, -0.005, iatt, 0.000, iatt, 0.205, iatt, \
-0.284, iatt, -0.208, iatt, 0.326, isus, -0.401, isus, 1.540, isus, \
0.589, isus, -0.486, idec, -0.016, idec, 0.141, idec, 0.105, idec, \
-0.003, idec, -0.023, idec, 0
kamp3 linseg 0, iatt, 0.722, iatt, 1.500, iatt, 3.697, iatt, \
0.080, iatt, -2.327, iatt, -0.684, isus, -2.638, isus, 0.000, isus, \
1.347, isus, 0.485, idec, -0.419, idec, -.700, idec, -0.278, idec, \
0.167, idec, -0.059, idec, 0
iwt1 = gi_ZakianFlute_f32
iwt2 = gi_ZakianFlute_f33
iwt3 = gi_ZakianFlute_f34
inorm = 3775
goto end
range4: ; for high range tones
kamp1 linseg 0, iatt, 0.000, iatt, 0.000, iatt, 0.211, iatt, \
0.526, iatt, 0.989, iatt, 1.216, isus, 1.727, isus, 1.881, isus, \
1.462, isus, 1.28, idec, 0.75, idec, 0.34, idec, 0.154, idec, 0.122, \
idec, 0.028, idec, 0
kamp2 linseg 0, iatt, 0.500, iatt, 0.000, iatt, 0.181, iatt, \
0.859, iatt, -0.205, iatt, -0.430, isus, -0.725, isus, -0.544, isus, \
-0.436, isus, -0.109, idec, -0.03, idec, -0.022, idec, -0.046, idec, \
-0.071, idec, -0.019, idec, 0
kamp3 linseg 0, iatt, 0.000, iatt, 1.000, iatt, 0.426, iatt, \
0.222, iatt, 0.175, iatt, -0.153, isus, 0.355, isus, 0.175, isus, \
0.16, isus, -0.246, idec, -0.045, idec, -0.072, idec, 0.057, idec, \
-0.024, idec, 0.002, idec, 0
iwt1 = gi_ZakianFlute_f35
iwt2 = gi_ZakianFlute_f36
iwt3 = gi_ZakianFlute_f37
inorm = 4909.05
goto end
end:
kampr1 randi .02*kamp1, 10, gi_ZakianFLute_seed ; up to 2% wavetable amplitude variation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kamp1 = kamp1 + kampr1
kampr2 randi .02*kamp2, 10, gi_ZakianFLute_seed ; up to 2% wavetable amplitude variation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kamp2 = kamp2 + kampr2
kampr3 randi .02*kamp3, 10, gi_ZakianFLute_seed ; up to 2% wavetable amplitude variation
gi_ZakianFLute_seed = frac(gi_ZakianFLute_seed*105.947)
kamp3 = kamp3 + kampr3
awt1 poscil kamp1, kfreq, iwt1, iphase ; wavetable lookup
awt2 poscil kamp2, kfreq, iwt2, iphase
awt3 poscil kamp3, kfreq, iwt3, iphase
asig = awt1 + awt2 + awt3
asig = asig*(iampscale/inorm)
kcut linseg 0, iattack, ifiltcut, isustain, ifiltcut, idecay, 0 ; lowpass filter for brightness control
afilt tone asig, kcut
a_signal balance afilt, asig
i_attack = .002
i_sustain = p3
i_release = 0.01
xtratim i_attack + i_sustain + i_release
a_declicking linsegr 0, i_attack, 1, i_sustain, 1, i_release, 0
a_signal = a_signal * i_amplitude * a_declicking * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_signal *= .7
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

;;; giPianoteq vstinit "/home/mkg/pianoteq_linux_v630/Pianoteq\ 6/amd64/Pianoteq\ 6.so", 1
giPianoteq vst3init "/Library/Audio/Plug-Ins/VST3/Pianoteq 8.vst3", "Pianoteq 8", 1
vst3info giPianoteq

instr PianoteqNote
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_PianoNotePianoteq_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.6 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_velocity = p5
i_homogeneity = p11
i_pitchclass = i_midikey % 12
i_hertz cpsmidinn i_midikey
i_amplitude = ampdb(i_midivelocity)
ichannel = 0
i_result vst3note giPianoteq, ichannel, i_midikey, i_midivelocity, i_duration
prints "PianoteqNote   i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", p1, p2, p3, p4, p5, p7, active(p1)

endin

gk_Bower_midi_dynamic_range chnexport "gk_Bower_midi_dynamic_range", 3
gk_Bower_attack chnexport "gk_Bower_attack", 3
gk_Bower_release chnexport "gk_Bower_release", 3
gk_Bower_level chnexport "gk_Bower_level", 3
gk_Bower_pressure chnexport "gk_Bower_pressure", 3

gk_Bower_midi_dynamic_range init 20
gk_Bower_attack init .125
gk_Bower_release init .125
gk_Bower_level init 0
gk_Bower_pressure init 0.25

gi_Bower_sine ftgen 0,0,65537,10,1

instr Bower
i_instrument = p1
i_time = p2
i_duration = p3
i_midi_key = p4
i_midi_dynamic_range = i(gk_Bower_midi_dynamic_range)
i_midi_velocity = p5 * i_midi_dynamic_range / 127 + (63.5 - i_midi_dynamic_range / 2)
k_space_front_to_back = p6
k_space_left_to_right = p7
k_space_bottom_to_top = p8
i_phase = p9
i_frequency = cpsmidinn(i_midi_key)
; Adjust the following value until "overall amps" at the end of performance is about -6 dB.
i_level_correction = 66
i_normalization = ampdb(-i_level_correction) / 2
i_amplitude = ampdb(i_midi_velocity) * i_normalization
k_gain = ampdb(gk_Bower_level)
iattack = i(gk_Bower_attack)
idecay = i(gk_Bower_release)
isustain = p3
iamp = i_amplitude
xtratim iattack + idecay
kenvelope transegr 0.0, iattack / 2.0, 1.5, iamp / 2.0, iattack / 2.0, -1.5, iamp, isustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(i_midi_key)
kamp = kenvelope
kfreq = ihertz
kpres = 0.25
krat rspline 0.006,0.988,1,4
kvibf = 4.5
kvibamp = 0
iminfreq = i(kfreq) / 2
aSig wgbow kamp,kfreq,gk_Bower_pressure,krat,kvibf,kvibamp,gi_Bower_sine,iminfreq
a_signal = aSig * kenvelope * k_gain

#ifdef USE_SPATIALIZATION
a_spatial_reverb_send init 0
a_bsignal[] init 16
a_bsignal, a_spatial_reverb_send Spatialize a_signal, k_space_front_to_back, k_space_left_to_right, k_space_bottom_to_top
outletv "outbformat", a_bsignal
outleta "out", a_spatial_reverb_send
#else
a_out_left, a_out_right pan2 a_signal, k_space_left_to_right
outleta "outleft", a_out_left
outleta "outright", a_out_right
#endif
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
;printks "Blower         i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(a_out_left)), dbamp(rms(a_out_right))
endin

;;gk_MVerb_feedback init .975
;;instr  MVerb
;;//////////////////////////////////////////////
;;// By Michael Gogins.
;;//////////////////////////////////////////////
;;ainleft  inleta  "inleft"
;;ainright  inleta  "inright"
;;aoutleft, aoutright MVerb  ainleft, ainright, "Huge Hall", "wet", .5, "FB", gk_MVerb_feedback, "random", 1, "rslow", 1.1, "rfast", 3.8, "rmax", .0005, "print", 1., "DFact", .75
;;; printks "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(aoutleft)), dbamp(rms(aoutright))
;;outleta  "outleft", aoutleft
;;outleta  "outright", aoutright
;;prints "R%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
;;endin

gk_ReverbSC_feedback init 0.85
gi_ReverbSC_delay_modulation init 0.35
gk_ReverbSC_frequency_cutoff init 15000
instr ReverbSC
ainleft inleta "inleft"
ainright inleta "inright"
; aoutL, aoutR reverbsc ainL, ainR, kfblvl, kfco[, israte[, ipitchm[, iskip]]]
aoutleft, aoutright reverbsc ainleft, ainright, gk_ReverbSC_feedback, gk_ReverbSC_frequency_cutoff, sr, gi_ReverbSC_delay_modulation
; printks "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d l%9.4f r%9.4f\n", 1, nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1), dbamp(rms(aoutleft)), dbamp(rms(aoutright))
outleta "outleft", aoutleft
outleta "outright", aoutright
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

gk_MasterOutput_level init .5
instr MasterOutput
aleft inleta "inleft"
aright inleta "inright"
kgain = ampdb(gk_MasterOutput_level)
outs aleft * kgain, aright * kgain
; fout "Poustinia-v6-7-1.wav", 16, aleft, aright
prints "%-24s i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
endin

instr Controls
k_active chnget "gk_Bower_pressure"
if k_active == 0 goto off_label
prints "Controls on i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
 gk_FMWaterBell_level chnget "gk_FMWaterBell_level"
 gi_FMWaterBell_attack chnget "gi_FMWaterBell_attack"
 gi_FMWaterBell_exponent chnget "gi_FMWaterBell_exponent"
 gi_FMWaterBell_release chnget "gi_FMWaterBell_release"
 gi_FMWaterBell_sustain chnget "gi_FMWaterBell_sustain"
 gi_FMWaterBell_sustain_level chnget "gi_FMWaterBell_sustain_level"
 gk_FMWaterBell_index chnget "gk_FMWaterBell_index"
 gk_FMWaterBell_crossfade chnget "gk_FMWaterBell_crossfade"
 gk_FMWaterBell_vibrato_depth chnget "gk_FMWaterBell_vibrato_depth"
 gk_FMWaterBell_vibrato_rate chnget "gk_FMWaterBell_vibrato_rate"

 gk_Bower_level chnget "gk_Bower_level"
 gk_Bower_pressure chnget "gk_Bower_pressure"
 
 gk_Blower_grainDensity chnget "gk_Blower_grainDensity" 
 gk_Blower_grainDuration chnget "gk_Blower_grainDuration" 
 gk_Blower_grainAmplitudeRange chnget "gk_Blower_grainAmplitudeRange"
 gk_Blower_grainFrequencyRange chnget "gk_Blower_grainFrequencyRange"
 gk_Blower_level chnget "gk_Blower_level" 
 
 gk_Buzzer_harmonics chnget "gk_Buzzer_harmonics" 
 gk_Buzzer_level chnget "gk_Buzzer_level" 
 
 gk_Droner_partial1 chnget "gk_Droner_partial1" 
 gk_Droner_partial2 chnget "gk_Droner_partial2" 
 gk_Droner_partial3 chnget "gk_Droner_partial3" 
 gk_Droner_partial4 chnget "gk_Droner_partial4" 
 gk_Droner_partial5 chnget "gk_Droner_partial5" 
 gk_Droner_level chnget "gk_Droner_level" 
 
 gk_Phaser_ratio1 chnget "gk_Phaser_ratio1" 
 gk_Phaser_ratio2 chnget "gk_Phaser_ratio2" 
 gk_Phaser_index1 chnget "gk_Phaser_index1" 
 gk_Phaser_index2 chnget "gk_Phaser_index2" 
 gk_Phaser_level chnget "gk_Phaser_level" 
 
 gk_PianoteqOut_level chnget "gk_PianoteqOut_level" 
 
gk_Shiner_level chnget "gk_Shiner_level" 
 
 gk_Sweeper_britel chnget "gk_Sweeper_britel"
 gk_Sweeper_briteh chnget "gk_Sweeper_briteh" 
 gk_Sweeper_britels chnget "gk_Sweeper_britels" 
 gk_Sweeper_britehs chnget "gk_Sweeper_britehs" 
 gk_Sweeper_level chnget "gk_Sweeper_level" 
 
 gk_ZakianFlute_level chnget "gk_ZakianFlute_level"

 gk_Reverb_feedback chnget "gk_MVerb_feedback" 
 gk_Reverb2_feedback chnget "gk_ReverbSC_feedback" 
 gk_MasterOutput_level chnget "gk_MasterOutput_level" 
 gk_overlap chnget "gk_overlap" 
 goto return_label
off_label:
prints "Controls off i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
return_label:
endin

instr exitnow
prints "exitnow i %9.4f t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f #%3d\n", nstrstr(p1), p1, p2, p3, p4, p5, p7, active(p1)
 exitnow
endin

</CsInstruments>
<CsScore>
i "exitnow" [9 * 60 + 5 ] .1
</CsScore>
</CsoundSynthesizer>
</textarea>
    </body>

</html>
