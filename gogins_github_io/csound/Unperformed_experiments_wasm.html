<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Unperformed experiments have no results</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
        <style>
            body {
                background-color: #000000;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            button, select, a, a:visited {
                padding: 8px 12px 8px 12px;
                border: none;
                border-radius: 5px;
                margin-right: 5px;
                color: #ffffff;
                background-color: #000000;
                opacity: 0.5;
                font-family: Monospace;
                font-size: 12px;
                font-weight: bold;
                cursor: pointer;
                text-decoration: none;
            }
            button:hover, select:hover, a:hover {
                opacity: 1;
                box-shadow: 0 0 4px #FFF;
            }
            option {
                color: #ffffff;
                background-color: #000000;
            }
            ::-webkit-scrollbar
            {
                width:10px;
            }
            ::-webkit-scrollbar-track-piece
            {
                background-color:transparent;
            }
            ::-webkit-scrollbar-corner
            {
                background-color:transparent;
            }
            .dg {
                font-family: Monaco, sans-serif;
                font-size:8pt;
            }
        </style>
        <script src='silencio/js/dat.gui.js'></script>
        <script src='silencio/js/jquery.js'></script>
        <script src='silencio/js/helpers.js'></script>
        <script src="silencio/js/codemirror.js"></script>
        <script src="silencio/js/glsl.js"></script>
        <script src="silencio/js/tinycolor.js"></script>
        <script src="silencio/js/Silencio.js"></script>
        <script src="silencio/js/ChordSpace.js"></script>
        <script src="silencio/js/sprintf.js"></script>
        <script type="text/javascript" src="csound.js"></script>
        <script>
            try {
                var nw_window = nwgui.Window.get();
                nw_window.on('close', function() {
                    console.log('Closing down...');
                this.close(true);
                //process.exit(0);
                });
            } catch (err) {
                console.log(err.message);
            }
            var handleMessage = function(message) {
                var messages_textarea = document.getElementById("console");
                var existing = messages_textarea.value;
                messages_textarea.value = existing + "\n" + message;
                messages_textarea.scrollTop = messages_textarea.scrollHeight;
            }
            var moduleDidLoad = function() {
                document.getElementById('console').value += 'moduleDidLoad was called; Csound functions may now be called.';
                console.warn = handleMessage;
            }
        </script>
    </head>
    <body>
        <table id = 'statistics' style="table-layout:fixed;position:absolute;left:1vw;color:#eee;top:1vw;font-family:Monaco, sans-serif;font-size:8pt;">
            <col width=400px>
            <col width=250px>
            <th style="color:gold;text-align:left">Unperformed experiments have no results, by Michael Gogins.
            </p></td><td style="color:gold;text-align:right;"</th>
            <!-- Copyright (C) 2017 by Michael Gogins -->
            <tr>
                <td>Time: </td><td id="Time_cell" style="color:LawnGreen;text-align:right;"></td>
            </tr>
            <tr>
                <td>X: </td><td id="X_cell" style="color:SkyBlue;text-align:right;"></td>
            </tr>
            <tr>
                <td>Y: </td><td id="Y_cell" style="color:SkyBlue;text-align:right;"></td>
            </tr>
             <tr>
                <td>Chord: </td><td id="Chord_cell" style="color:SkyBlue;text-align:right;"></td>
            </tr>
            <tr>
                <!-- or: http://stackoverflow.com/questions/35509360/how-to-make-the-content-of-the-following-table-cell-scrollable -->
                <td colspan=2><textarea id="console" style="width:100%;color:SkyBlue;background-color:transparent;border:none;text-align:left;font-size:10px;height:200px;overflow:auto;"></textarea></td>
            </tr>
        </table>
        <div id = 'webgl_cell' class='canvas' style="position:absolute;left:1vw;color:#eee;top:1vw;"/>
        <textarea class="code" id="orc" hidden rows=24 cols=80>
<CsoundSynthesizer>
<CsOptions>
</CsOptions>
<CsInstruments>
nchnls  = 2

opcode hertz2midinn, i, i
ihertz xin
print ihertz
; m = 12*log2(fm/440 Hz) + 69
ilog2 = log(2)
imidinn = 12 * (log(ihertz / 440) / ilog2) + 69
print imidinn
xout imidinn
endop

; Each Csound instrument uses global variables
; and function tables declared in the global area of the orchestra
; just above the instrument definition itself. A naming pattern is
; used to avoid name collisions and keep everything straight.

gaSendM,gaSendL,gaSendR init 0
gi_FM_Clang_sine ftgen 0,0,4096,10,1 ;A SINE WAVE. USED BY THE LFOs.
gi_FM_Clang_detuning ftgen 0,0,128,21,1,1 ; random array used for fixing unique detune values for each note
gi_FM_Clang_DryMap ftgen 0,0,4096,7,1,2048,1,2048,0 ; dry mixer control mapping
gi_FM_Clang_WetMap ftgen 0,0,4096,7,0,2048,1,2048,1 ; wet mixer control mapping
gaSendL,gaSendR init 0 ; initialise variable used for sending audio between instruments
gi_FM_Clang_Imp ftgen 0,0,4097,9,0.5,1,0 ; shape for the hammer inpulse
gi_FM_Clang_stereo ftgen 0,0,256,21,1,1 ; random array used for fixing unique stereo values for each note
gi_FM_Clang_detune ftgen 0,0,256,21,1,1 ; random array used for fixing unique detune values for each note
gi_FM_Clang_scale ftgen 0,0,128,-7,-1,128,1

instr FM_Clang_controls ; Read in widgets
iporttime = 0.05
gk_FM_Clang_mod chnget "mod"
gk_FM_Clang_mod port gk_FM_Clang_mod,iporttime
gk_FM_Clang_NdxVel chnget "NdxVel"
gk_FM_Clang_Dur chnget "Dur"
gk_FM_Clang_FiltFund chnget "FiltFund"
gk_FM_Clang_NdxCurve chnget "NdxCurve"
gk_FM_Clang_LPF chnget "LPF"
gk_FM_Clang_ModDep chnget "ModDep"
gk_FM_Clang_ModRte chnget "ModRte"
gk_FM_Clang_ModRteKyb chnget "ModRteKyb"
gk_FM_Clang_ModMix chnget "ModMix"
gk_FM_Clang_Sustain chnget "Sustain"
gk_FM_Clang_CarKyb chnget "CarKyb"
gk_FM_Clang_StWidth chnget "StWidth"
gk_FM_Clang_StWidth init 0.01
gk_FM_Clang_StMix chnget "StMix"
gk_FM_Clang_DryWet chnget "RvbDryWet"
gk_FM_Clang_Dry table gk_FM_Clang_DryWet,gi_FM_Clang_DryMap,1 ; map dry/wet control
gk_FM_Clang_Wet table gk_FM_Clang_DryWet,gi_FM_Clang_WetMap,1 ;
gk_FM_Clang_RvbSize chnget "RvbSize"
gk_FM_Clang_Detune chnget "Detune"
gk_FM_Clang_DtnMix chnget "DtnMix"
gk_FM_Clang_Amp chnget "Amp"
gk_FM_Clang_level chnget "gk_FM_Clang_level"
gk_FM_Clang_Amp port gk_FM_Clang_Amp,iporttime
gk_FM_Clang_AttTim chnget "AttTim"
gk_FM_Clang_AttVel chnget "AttVel"
gk_FM_Clang_NseAmp chnget "NseAmp"
gk_FM_Clang_NseBW chnget "NseBW"
gk_FM_Clang_NseFllw chnget "NseFllw"
endin

gi_Droner_overlap init .1
gk_Droner_distort_factor init 0.4
gk_Droner_first_harmonic init 0.4
gk_Droner_slider1 init .05
gk_Droner_slider2 init .1
gk_Droner_slider3 init .04
gk_Droner_slider4 init .2
gk_Droner_slider5 init .02
gk_Droner_level init 0
gi_Droner_sine ftgen 0, 0, 65536, 10, 1, 0, .02
instr Droner
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
k1 init .5
k2 init .05
k3 init .1
k4 init .2
k5 init .1
k6 init .05
k7 init .1
k8 init 0
k9 init 0
k10 init 0
k3 = gk_Droner_slider1
k4 = gk_Droner_slider2
k5 = gk_Droner_slider3
k6 = gk_Droner_slider4
k7 = gk_Droner_slider5
kwaveform init 0
iamp = ampdb(ivelocity)
iattack = gi_Droner_overlap
idecay = gi_Droner_overlap
isustain = p3
p3 = iattack + isustain + idecay
aenvelope transegr 0.0, iattack / 2.0, 1.5, iamp / 2.0, iattack / 2.0, -1.5, iamp, isustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
if kwaveform == 0 then
asignal poscil3 1, ihertz, gi_Droner_sine
endif
if kwaveform == 1 then
asignal vco2 1, ihertz, 8 ; integrated saw
endif
if kwaveform == 2 then
asignal vco2 1, ihertz, 12 ; triangle
endif
asignal chebyshevpoly asignal, 0, k1, k2, k3, k4, k5, k6, k7, k8, k9, k10
asignal = asignal * aenvelope * 10
aleft, aright pan2 asignal, ipan
adamping linseg 0, 0.03, 1, p3 - 0.1, 1, 0.07, 0
kgain = ampdb(gk_Droner_level)
aleft = adamping * aleft * kgain
aright = adamping * aright * kgain
; Each instrument sends its audio to a global audio output bus,
; where effects can be applied.
chnmix aleft, "out_left"
chnmix aright, "out_right"
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

opcode FM_Clang_veloc, i, iii
; *p->r = *p->ilo + csound->curip->m_veloc*(*p->ihi - *p->ilo) * dv127;
ivel, ilow, ihigh xin
xout ilow + ivel * (ihigh - ilow) * 0.007874
endop

instr FM_Clang ; Sound producing instrument. Triggered by MIDI notes or score notes.
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
icps = cpsmidinn(ikey)
inum = ikey
iamplitude = ampdb(ivelocity)
; icps cpsmidi
; inum notnum
iKybdScl table inum,gi_FM_Clang_scale ; Keyboard scaling value. Note '0' maps to a value of -1, note 64 maps to a value of zero and note 127 maps to a value of 1.
; Amplitude Envelope
idur = i(gk_FM_Clang_Dur)
iAmpCurve = -8
iRelTim = (i(gk_FM_Clang_Sustain)==1?idur:0.1)
;iAttVel veloc i(gk_FM_Clang_AttVel)*0.05,0
iAttVel FM_Clang_veloc ivelocity, i(gk_FM_Clang_AttVel)*0.05,0
iAttTim = iAttVel + i(gk_FM_Clang_AttTim)
if iAttTim==0 then
aAEnv transegr 1,idur,iAmpCurve,0, iRelTim,iAmpCurve,0
else
aAEnv transegr 0,iAttTim,iAmpCurve, 1,idur,iAmpCurve,0, iRelTim,iAmpCurve,0
endif
; Key velocity to amplitude
;iAVel veloc 0,0.1
iAVel FM_Clang_veloc ivelocity, 0, 0.1
; FM index
iNdx veloc 0,i(gk_FM_Clang_NdxVel) ; Key velocity to FM index
iNdx FM_Clang_veloc ivelocity, 0,i(gk_FM_Clang_NdxVel) ; Key velocity to FM index
kIEnv transeg iNdx*octave(-iKybdScl*4),idur,-i(gk_FM_Clang_NdxCurve),0 ; Index envelope. Amplitude influenced by 'Index' widget control and keyboard scaling (index reduced for higher notes, increased for lower notes)
; Carrier frequency keyboard scaling
icar = 1 * octave(iKybdScl*i(gk_FM_Clang_CarKyb))
; Carrier ratio modulation
iModRte table inum,gi_FM_Clang_scale
iModRte = octave(iModRte*i(gk_FM_Clang_ModRteKyb))
kDepEnv transeg 1,idur,-4,0
amod lfo gk_FM_Clang_ModDep*0.1*kDepEnv, gk_FM_Clang_ModRte * iModRte, 0
; Noise bandpass filter cutoff as it respond to the 'Carrier Follow' switch
kcf = gk_FM_Clang_NseFllw==1?icps*gk_FM_Clang_mod:icps
; Noise amplitude keyboard following
kNseAmp = octave(iKybdScl*-4)*gk_FM_Clang_NseAmp
; Main FM algorithm
if gk_FM_Clang_NseAmp>0 then ; If noise amplitude is greater than zero...
aNse gauss kNseAmp ; ... generate some gaussian noise
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW ; bandpass filter the noise
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW ; and again
else
aNse = 0 ; Otherwise no noise signal!
endif
idetune table inum,gi_FM_Clang_detune ; Read a detuning value from a random table
asig foscil iAVel, icps*cent(-gk_FM_Clang_Detune*idetune), icar +aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; FM pair
aModSig foscil iAVel, icps*cent(-gk_FM_Clang_Detune*idetune), icar+amod+aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; FM pair with modulation
asig = asig + (aModSig * gk_FM_Clang_ModMix) ; Mix the two FM pairs.
; Auxilliary FM algorithm (used for detuning)
if gk_FM_Clang_DtnMix>0&&gk_FM_Clang_Detune>0 then
if gk_FM_Clang_NseAmp>0 then
aNse gauss kNseAmp
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW
aNse butbp aNse,kcf,kcf*gk_FM_Clang_NseBW
else
aNse = 0
endif
idetune table inum+128,gi_FM_Clang_detune ; Read a detuning value from a random table
asig2 foscil iAVel, icps*cent(gk_FM_Clang_Detune*idetune), icar +aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine ; Detuning applied to fundemental
aModSig2 foscil iAVel, icps*cent(gk_FM_Clang_Detune*idetune), icar+amod+aNse, gk_FM_Clang_mod, kIEnv, gi_FM_Clang_sine
asig2 = asig2 + (aModSig2 * gk_FM_Clang_ModMix)
asig = asig + asig2*gk_FM_Clang_DtnMix
endif
; Filter Fundemental
if i(gk_FM_Clang_FiltFund)==1 then ; If filter fundemental switch is active
asig butbr asig,icps*icar,icps*icar*0.3 ; Filter out fundemental
asig butbr asig,icps*icar,icps*icar*0.3 ; and again to make sure it is all gone
endif
; Lowpass Filter
if i(gk_FM_Clang_LPF)<32 then ; If lowpass filter is less than maximum...
kCF limit icps*gk_FM_Clang_LPF,20,20000 ; ...create the cutoff value in CPS based on fundemental and LPF ratio control. Limit to prevent out of range values.
asig clfilt asig,kCF,0,2 ; Butterworth lowpass filter
endif
; Amplitude Envelope
kgain = ampdb(gk_FM_Clang_level)
asig = asig * aAEnv * gk_FM_Clang_Amp * kgain; Apply amplitude envelope
; Stereo Effect
iDlyTimL table inum,gi_FM_Clang_stereo ; Read a delay time value from a random table based on note played
iDlyTimR table inum+128,gi_FM_Clang_stereo ; Read a different delay time value from a random table based on note played
if gk_FM_Clang_StWidth>0&&gk_FM_Clang_StMix>0 then ; If 'width' is above zero and 'mix' is above zero...
aL vdelay asig, iDlyTimL*gk_FM_Clang_StWidth*1000, 0.2*1000 ; ...left channel delay
aR vdelay asig, iDlyTimR*gk_FM_Clang_StWidth*1000, 0.2*1000 ; right channel delay
aL ntrpol asig, aL, gk_FM_Clang_StMix ; Mix delayed and dry signal
aR ntrpol asig, aR, gk_FM_Clang_StMix ;
aleft = aL;*gk_FM_Clang_Dry
aright = aR;*gk_FM_Clang_Dry
gaSendL = gaSendL + aL ; Send to reverb
gaSendR = gaSendR + aR
else
aleft = asig;*gk_FM_Clang_Dry
aright = asig;*gk_FM_Clang_Dry
gaSendL = gaSendL + asig ; Send to reverb
gaSendR = gaSendR + asig
endif
aleft = aleft * ampdb(ivelocity)
aright = aleft * ampdb(ivelocity)
chnmix aleft, "out_left"
chnmix aright, "out_right"
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_Harpsichord_level init 0
gk_HarpsichordPan init .5
gi_Harptable ftgen 0, 0, 65536, 7, -1, 1024, 1, 1024, -1
instr Harpsichord
//////////////////////////////////////////////
// Original by James Kelley.
// Adapted by Michael Gogins.
//////////////////////////////////////////////
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
iattack = .005
isustain = p3
irelease = .3
p3 = iattack + isustain + irelease
iHz = cpsmidinn(ikey)
kHz = k(iHz)
iamplitude = ampdb(ivelocity)
aenvelope 	 transeg 1.0, 20.0, -10.0, 0.05
apluck 	 pluck 1, kHz, iHz, 0, 1
aharp 	 poscil 1, kHz, gi_Harptable
aharp2 	 balance apluck, aharp
asignal			 = (apluck + aharp2) * iamplitude * aenvelope * 10
adeclick linsegr 0, iattack, 1, isustain, 1, irelease, 0
kgain = ampdb(gk_Harpsichord_level)
asignal = asignal * adeclick * kgain
aoutleft, aoutright pan2 asignal, ipan
chnmix aoutleft, "out_left"
chnmix aoutright, "out_right"
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gi_Sweeper_overlap init .1
gk_Sweeper_britel init 0
gk_Sweeper_briteh init 2.9
gk_Sweeper_britels init .2 / 3
gk_Sweeper_britehs init 2.5 / 2
gk_Sweeper_level init 0
gi_Sweeper_sine ftgen 0, 0, 65536, 10, 1
gi_Sweeper_octfn ftgen 0, 0, 65536, -19, 1, 0.5, 270, 0.5
instr Sweeper
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
iamp = ampdb(ivelocity)
iattack = gi_Sweeper_overlap
idecay = gi_Sweeper_overlap
isustain = p3
p3 = iattack + isustain + idecay
aenvelope transegr 0.0, iattack / 2.0, 1.5, iamp / 2.0, iattack / 2.0, -1.5, iamp, isustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
icps = ihertz
kamp expseg 0.001,0.02,0.2,p3-0.01,0.001
ktonemoddep jspline 0.01,0.05,0.012
ktonemodrte jspline 6,0.1,0.2
ktone poscil3 ktonemoddep, ktonemodrte, gi_Sweeper_sine
kbrite rspline gk_Sweeper_britel, gk_Sweeper_briteh, gk_Sweeper_britels, gk_Sweeper_britehs
ibasfreq init icps
ioctcnt init 3
iphs init 0
a1 hsboscil 1, ktone, kbrite, ibasfreq, gi_Sweeper_sine, gi_Sweeper_octfn, ioctcnt, iphs
a1 = a1 * aenvelope
amod poscil3 0.25, ibasfreq*(1/3), gi_Sweeper_sine
arm = a1*amod
kmix expseg 0.001, 0.01, rnd(1), rnd(3)+0.3, 0.001
kmix=.25
a1 ntrpol a1, arm, kmix
;a1 pareq a1/10, 400, 15, .707
;a1 tone a1, 500
kpanrte jspline 5, 0.05, 0.1
kpandep jspline 0.9, 0.2, 0.4
kpan poscil3 kpandep, kpanrte, gi_Sweeper_sine
a1,a2 pan2 a1, kpan
a1 delay a1, rnd(0.1)
a2 delay a2, rnd(0.11)
aenv linsegr 1, 1, 0
aenv = aenvelope
aleft = a1*aenv*.02
aright = a2*aenv*.02
adamping linseg 0, 0.03, 1, p3 - 0.1, 1, 0.07, 0
kgain = ampdb(gk_Sweeper_level)
aleft = adamping * aleft * kgain
aright = adamping * aright * kgain
chnmix aleft, "out_left"
chnmix aright, "out_right"
; printks "gk_Sweeper_level: %f kgain: %f aleft: %f\n", 0.5, gk_Sweeper_level, kgain, k(aleft)
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gi_Buzzer_overlap init .1
gk_Buzzer_harmonics init 2
gk_Buzzer_level init 0
gk_Buzzer_distort_factor init 0.4
gk_Buzzer_first_harmonic init 0.4
gi_Buzzer_sine ftgen 0, 0, 65536, 10, 1
instr Buzzer
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
iamp = ampdb(ivelocity) * 4
iattack = gi_Buzzer_overlap
idecay = gi_Buzzer_overlap
isustain = p3
p3 = iattack + isustain + idecay
aenvelope transegr 0.0, iattack / 2.0, 1.5, iamp / 2.0, iattack / 2.0, -1.5, iamp, isustain, 0.0, iamp, idecay / 2.0, 1.5, iamp / 2.0, idecay / 2.0, -1.5, 0
ihertz = cpsmidinn(ikey)
asignal buzz aenvelope, ihertz, gk_Buzzer_harmonics, gi_Buzzer_sine
asignal = asignal * 3
aleft, aright pan2 asignal, ipan
adamping linseg 0, 0.03, 1, p3 - 0.1, 1, 0.07, 0
kgain = ampdb(gk_Buzzer_level)
aleft = adamping * aleft * kgain
aright = adamping * aright * kgain
chnmix aleft, "out_left"
chnmix aright, "out_right"
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

; All control channels come into this always-on instrument so that
; the channel need be read only once per kperiod for greater efficiency.

instr Controls
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
gk_Droner_slider1 chnget "gk_Droner_slider1"
gk_Droner_slider2 chnget "gk_Droner_slider2"
gk_Droner_slider3 chnget "gk_Droner_slider3"
gk_Droner_slider4 chnget "gk_Droner_slider4"
gk_Droner_slider5 chnget "gk_Droner_slider5"
gk_Droner_level chnget "gk_Droner_level"
gk_Buzzer_harmonics chnget "gk_Buzzer_harmonics"
gk_Buzzer_level chnget "gk_Buzzer_level"
gk_Sweeper_level chnget "gk_Sweeper_level"
gk_Harpsichord_level chnget "gk_Harpsichord_level"
gk_Reverb_Feedback chnget "gk_Reverb_Feedback"
gk_MasterOutput_level chnget "gk_MasterOutput_level"
prints "instr %4d t %12.4f d %12.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_FM_Clang_preset init 1
instr FM_Clang_preset
gk_FM_Clang_preset chnget "gk_FM_Clang_preset"
ktrig changed gk_FM_Clang_preset
#define SET_PRESET(N'Amp'AttTim'AttVel'Dur'Sustain'mod'NdxVel'NdxCurve'CarKyb'DtnMix'Detune'LPF'FiltFund'NseAmp'NseBW'NseFllw'ModMix'ModDep'ModRte'ModRteKyb'StMix'StWidth'RvbDryWet'RvbSize)
#
if i(gk_FM_Clang_preset)==$N then
printks2 "setting preset %d\n", $N
chnset $Amp ,"Amp"
chnset $AttTim ,"AttTim"
chnset $AttVel ,"AttVel"
chnset $Dur ,"Dur"
chnset $Sustain ,"Sustain"
chnset $mod ,"mod"
chnset $NdxVel ,"NdxVel"
chnset $NdxCurve ,"NdxCurve"
chnset $CarKyb ,"CarKyb"
chnset $DtnMix ,"DtnMix"
chnset $Detune ,"Detune"
chnset $LPF ,"LPF"
chnset $FiltFund ,"FiltFund"
chnset $NseAmp ,"NseAmp"
chnset $NseBW ,"NseBW"
chnset $NseFllw ,"NseFllw"
chnset $ModMix ,"ModMix"
chnset $ModDep ,"ModDep"
chnset $ModRte ,"ModRte"
chnset $ModRteKyb,"ModRteKyb"
chnset $StMix ,"StMix"
chnset $StWidth ,"StWidth"
chnset $RvbDryWet,"RvbDryWet"
chnset $RvbSize ,"RvbSize"
endif
#
if ktrig==1 then
reinit SEND_PRESET
endif
SEND_PRESET:
; N'Amp'AttTim'AttVel'Dur'Sustain'mod 'NdxVel'NdxCurve'CarKyb'DtnMix'Detune'LPF'FiltFund'NseAmp'NseBW'NseFllw'ModMix'ModDep'ModRte'ModRteKyb'StMix'StWidth'RvbDryWet'RvbSize)
$SET_PRESET(1'0.5'0 '0 '12 '1 '2.29'1 '16 '0 '1 '1.5 '16 '1 '1000 '0.001'0 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(2'0.8'0 '0 '1.7'1 '5.04'0.55 '100 '0 '0 '0 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.1 '0.55 )
$SET_PRESET(3'0.5'0.1 '0.5 '3.8'1 '1.00'2 '28 '0 '1 '15 '16 '0 '500 '0.0077'1 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(4'0.5'0 '0.006 '24 '1 '3.19'1 '15 '0 '0.47 '2.5 '16 '1 '0 '0.001'0 '1 '0.1 '0.33 '1.7 '0.5 '0.01 '0.3 '0.55 )
$SET_PRESET(5'0.8'0 '1 '6.6'0 '1.12'1 '13 '-2.68 '1 '25 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '1 '0.02 '0.172 '0.21 )
$SET_PRESET(6'3.25'0.1 '1 '1.28'0 '2.55'0.55 '35 '-2.3 '0 '1.5 '16 '1 '2000 '0.0025'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.68 '0.93 )
$SET_PRESET(7'4 '0.1 '1 '2.39'1 '2.55'0.55 '35 '-2.3 '0 '1.5 '16 '1 '16 '0.1262'0 '0 '0.1 '3 '0 '0 '0.01 '1.00 '0 )
$SET_PRESET(8'1 '0 '0 '14.25'1 '6.97'0.55 '35 '-2.3 '0.13 '1.5 '4.78'1 '16 '0.0326'0 '1 '0.1 '3 '0 '0 '0.01 '0.6 '0 )
$SET_PRESET(9'1.65'0 '0 '1.7'1 '1.20'0.55 '100 '0 '0 '0 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.1 '0.55 )
$SET_PRESET(10'2' 0 '0 '1 '1 '2.15'0.55 '100 '0 '0.21 '12 '3.8'0 '0 '0.001'0 '0 '0.1 '3 '0 '0.5 '0.01 '0.35 '0.37 )
$SET_PRESET(11'2 '0.1 '1 '3.44'1 '3.75'0.55 '100 '0 '0.21 '25 '16 '0 '0 '0.001'1 '0 '0.1 '3 '0 '0.5 '0.05 '0 '0.37 )
$SET_PRESET(12'2 '0.1 '1 '1.45'1 '2.66'1.00 '16 '0 '0.21 '25 '16 '0 '0 '0.001'1 '0 '0.1 '3 '0 '0.5 '0.05 '0.6 '0.37 )
$SET_PRESET(13'1.9'0 '0 '24 '1 '2.29'1.00 '23.25 '-4 '1 '1.5 '16 '1 '151 '0.0178'1 '1 '0.1 '3 '0 '0.5 '0.01 '0.3 '0.55 )
endin

; The global effects receive audio from the global audio output bus,
; and send it on to their own global output busses.

gk_Reverb_Feedback init 0.975
gk_Reverb_DelayModulation init 0.875
instr Reverb
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
ain_left chnget "out_left"
ain_right chnget "out_right"
azero init 0
aout_left init 0
aout_left, aright reverbsc ain_left, azero, gk_Reverb_Feedback, 15000.0
aleft init 0
azero init 0
aleft, aout_right reverbsc azero, ain_right, gk_Reverb_Feedback, 15000.0
chnmix aout_left, "reverb_out_left"
chnmix aout_right, "reverb_out_right"
prints "instr %4d t %9.4f d %9.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

gk_MasterOutput_level init 0
instr MasterOutput
; Consume unused pfields.
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
ain_left chnget "reverb_out_left"
ain_right chnget "reverb_out_right"
kgain = ampdb(gk_MasterOutput_level)
aout_left = ain_left * gk_MasterOutput_level * kgain * 0.0001
aout_right = ain_right * gk_MasterOutput_level * kgain * 0.0001
outs aout_left, aout_right
prints "instr %4d t %12.4f d %12.4f k %9.4f v %9.4f p %9.4f\n", p1, p2, p3, p4, p5, p7
endin

; This instrument clears the global output busses of audio for the next kperiod.

instr Clear
insno = p1
itime = p2
iduration = p3
ikey = p4
ivelocity = p5
iphase = p7
ipan = p6
idepth = p8
iheight = p9
ipcs = p10
ihomogeneity = p11
chnclear "out_left"
chnclear "out_right"
chnclear "reverb_out_left"
chnclear "reverb_out_right"
prints "instr %4d t %12.4f d %12.4f\n", p1, p2, p3
endin

; Finally the orchestra itself turns on the effects instruments and the
; other always-on instruments.

scoreline_i "i \"Controls\" 0 420"
scoreline_i "i \"FM_Clang_controls\" 0 420"
scoreline_i "i \"FM_Clang_preset\" 0 420"
scoreline_i "i \"Reverb\" 0 420"
scoreline_i "i \"MasterOutput\" 0 420"
scoreline_i "i \"Clear\" 0 420"
</CsInstruments>
<CsScore>
</CsScore>
</CsoundSynthesizer>
        </textarea>
        <script id="example" type="x-shader/x-fragment">
            precision mediump float;
            uniform float time;
            uniform float tempo;
            uniform float zoom;
            uniform float stride;
            uniform vec2 mouse;
            uniform vec2 resolution;
            vec3 pal(float t, vec3 a, vec3 b, vec3 c, vec3 d)
            {
                return a + b * cos(6.28318 * (c * t + d));
            }
            void main(){
                vec2 uv = gl_FragCoord.xy / resolution.xy;
                uv = uv * 2. - 1.;
                uv.x *= resolution.x / resolution.y;
                float e = time * tempo;
                float d = 128. * mouse.x / resolution.x + 8.5;
                vec2 g = uv * zoom;
                uv = d * (floor(g) + .5) / zoom;
                g = fract(g) * 2. - 1.;
                float f = dot(uv, uv) - e;
                vec4 c = vec4(
                    pal(f *.5 + e,
                        vec3(0.5, 0.5, 0.5),
                        vec3(0.5, 0.5, 0.5),
                        vec3(1.0, 1.0, 1.0),
                        vec3(0.0, 0.10, 0.20)), 1.);
                gl_FragColor = c * (1. - dot(g, g)) * .2 / abs((fract(f) - .5) * 8.);
            }
        </script>
        <script id="fragmentShader" type="x-shader/x-fragment">
            precision mediump float;
            uniform vec2 resolution;
            uniform sampler2D texture;
            void main(){
                vec2 uv = gl_FragCoord.xy / resolution.xy;
                gl_FragColor = texture2D(texture, uv);
            }

        </script>
        <script id="vertexShader" type="x-shader/x-vertex">
            precision mediump float;
            attribute vec3 position;
            void main(){
                gl_Position = vec4(position, 1.0);
            }
        </script>
        <script id="surfaceVertexShader" type="x-shader/x-vertex">
            precision mediump float;
            attribute vec3 position;
            attribute vec2 surfacePosAttrib;
            varying vec2 surfacePosition;
            void main(){
                surfacePosition = surfacePosAttrib;
                gl_Position = vec4(position, 1.0);
            }
        </script>
        <script>
            /* jshint bitwise: true, strict:false */
            "use strict";
            try {
                console.log('csound:', csound);
                var score = new Silencio.Score();
                var FM9 = ChordSpace.chordForName('FM9');
                var Bb7 = ChordSpace.chordForName('Bb7');
                var CM = ChordSpace.chordForName('CM');
                var chord = FM9.clone();
                var modality = chord.clone();
                initialize_helper();
                var compressor=initialize_compressor();
                if (!window.requestAnimationFrame){
                    window.requestAnimationFrame = (function(){
                    return window.webkitRequestAnimationFrame ||
                        window.mozRequestAnimationFrame ||
                        window.oRequestAnimationFrame ||
                        window.msRequestAnimationFrame ||
                        function (callback, element){
                            window.setTimeout(callback, 1000 / parameters.frames_per_second);
                        };
                })();
            }
            // Get older browsers safely through init code, so users can read the
            // message about how to download newer browsers.
            if (!Date.now){
                Date.now = function(){
                    return +new Date();
                };
            }
            var quality = 2, quality_levels = [0.5, 1, 2, 4, 8];
            var toolbar, compileButton, fullscreenButton, compileTimer, errorLines = [];
            var code, canvas, gl, vertex_buffer, currentProgram, vertexPosition, screenVertexPosition, panButton;
            var parameters = {
                instruments: 4,
                frames_per_second: 30,
                startTime: Date.now(),
                time: 0,
                tempo: 0.025,
                zoom: 64,
                stride: 40,
                mouseX: 0.5,
                mouseY: 0.5,
                screenWidth: 0,
                screenHeight: 0,
                duration: 4,
                gk_DelayedPlucked_level: 0.5,
                gk_Harpsichord_level: 0.5,
                gk_Harpsichord_pick: 0.75,
                gk_Harpsichord_reflection: 0.5,
                gk_Harpsichord_pluck: 0.75,
                gk_Plucked_level: 0,
                gk_STKPlucked_level: 0,
                gk_Rhodes_level: 0.0,
                gk_Reverb_Feedback: 0.975,
                gk_Reverb2_Feedback: 0.7,
                gk_MasterOutput_level: 0.4,
                gk_overlap: 0.05,
                gk_FM_Clang_level: 0,
                Play: function() {
                    if (typeof csound.is_playing === 'undefined') {
                        csound.is_playing = false;
                    }
                    if (csound.is_playing === false) {
                        csound.start();
                        csound.perform();
                        gui.revert();
                        csound.compileCsdText(document.getElementById('orc').value);
                        start_time_seconds = new Date().getTime() / 1000.0;
                        csound.is_playing = true;
                    } else {
                        csound.is_playing = false;
                        csound.stop();
                    }
                    start_time_seconds = new Date().getTime() / 1000.0;
                },
                Stop: function() {
                    csound.is_playing = false;
                    Silencio.saveDatGuiJson(gui);
                    csound.stop();
                },
                CM: function() {
                    chord = CM.clone();
                    modality = chord.clone();
                    csound.message('CM:\n' + chord.information());
                },
                FM9: function() {
                    chord = FM9.clone();
                    modality = chord.clone();
                    csound.message('FM9:\n' + chord.information());
                },
                Bb7: function() {
                    chord = Bb7.clone();
                    modality = chord.clone();
                    csound.message('Bb7:\n' + chord.information());
                },
                K: function() {
                    chord = chord.K();
                    csound.message('K():\n' + chord.information());
                },
                T1: function() {
                    chord = chord.T(1);
                    csound.message('T(1):\n' + chord.information());
                },
                T2: function() {
                    chord = chord.T(2);
                    csound.message('T(2):\n' + chord.information());
                },
                T3: function() {
                    chord = chord.T(3);
                    csound.message('T(3):\n' + chord.information());
                },
                T4: function() {
                    chord = chord.T(4);
                    csound.message('T(4):\n' + chord.information());
                },
                T5: function() {
                    chord = chord.T(5);
                    csound.message('T(5):\n' + chord.information());
                },
                T6: function() {
                    chord = chord.T(6);
                    csound.message('T(6):\n' + chord.information());
                },
                T7: function() {
                    chord = chord.T(7);
                    csound.message('T(7):\n' + chord.information());
                },
                T8: function() {
                    chord = chord.T(8);
                    csound.message('T(8):\n' + chord.information());
                },
                T9: function() {
                    chord = chord.T(9);
                    csound.message('T(9):\n' + chord.information());
                },
                T10: function() {
                    chord = chord.T(10);
                    csound.message('T(10):\n' + chord.information());
                },
                T11: function() {
                    chord = chord.T(11);
                    csound.message('T(11):\n' + chord.information());
                },
                J2_2: function() {
                    var chords = chord.J(2);
                    if (chords.length > 1) {
                        chord = chords[1];
                        csound.message('J(2,2):\n' + chord.information());
                    }
                },
                J2_3: function() {
                    var chords = chord.J(2);
                    if (chords.length > 2) {
                        chord = chords[2];
                        csound.message('J(2,3):\n' + chord.information());
                    }
                },
                J3_1: function() {
                   var chords = chord.J(3);
                    if (chords.length > 0) {
                        chord = chords[0];
                        csound.message('J(3,1):\n' + chord.information());
                    }
                },
                T5: function() {
                    chord = chord.T(5);
                    csound.message('D():\n' + chord.information());
                },
            };
            var surface = { centerX: 0, centerY: 0, width: 1, height: 1, isPanning: false, isZooming: false, lastX: 0, lastY: 0 },
            frontTarget, backTarget, screenProgram, getWebGL, resizer = {}, compileOnChangeCode = true;
            function csoundMessage(message) {
                var messages_textarea = document.getElementById("console");
                var existing = messages_textarea.value;
                messages_textarea.value = existing + message;
                messages_textarea.scrollTop = messages_textarea.scrollHeight;
            }
            var init = function(){
                canvas = document.createElement('canvas');
                canvas.style.display = 'block';
                document.body.appendChild(canvas);
                toolbar = document.createElement('div');
                toolbar.style.position = 'absolute';
                toolbar.style.top = '25px';
                toolbar.style.left = '25px';
                //document.body.appendChild(toolbar);
                var rightside = document.createElement('div');
                rightside.style.cssFloat = 'right';
                toolbar.appendChild(rightside);
                panButton = document.createElement('button');
                panButton.textContent = 'pan/zoom';
                panButton.style.cursor = 'move';
                panButton.style.display = 'none';
                panButton.title = "Pan: left-drag, Zoom: right-drag. Use 'hide code' for a large pan/zoom area.";
                rightside.appendChild(panButton);
                fullscreenButton = document.createElement('button');
                fullscreenButton.textContent = 'fullscreen';
                fullscreenButton.title = 'Press F11 to enter or leave fullscreen mode';
                fullscreenButton.addEventListener('click', function (event){
                    if (document.body.requestFullScreen){
                        document.body.requestFullScreen();
                    } else if (document.body.mozRequestFullScreen){
                        document.body.mozRequestFullScreen();
                    } else if (document.body.webkitRequestFullScreen){
                        document.body.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                }, false);
               rightside.appendChild(fullscreenButton);
               var button = document.createElement('a');
               button.textContent = 'gallery';
               button.href = '/';
               rightside.appendChild(button);
                var button = document.createElement('button');
                button.textContent = 'show fragment';
                button.addEventListener('click', function (event){
                    if (isCodeVisible()){
                        button.textContent = 'show fragment';
                        code.getWrapperElement().style.display = 'none';
                        compileButton.style.visibility = 'hidden';
                        set_save_button('hidden');
                        set_parent_button('hidden');
                        ///stopHideUI();
                    } else {
                        button.textContent = 'hide fragment';
                        code.getWrapperElement().style.display = '';
                        compileButton.style.visibility = 'visible';
                        set_save_button('visible');
                        set_parent_button('visible');
                    }
                }, false);
                toolbar.appendChild(button);
                var select = document.createElement('select');
                for (var i = 0; i < quality_levels.length; i ++){
                    var option = document.createElement('option');
                    option.textContent = quality_levels[i];
                    if (quality_levels[i] == quality)option.selected = true;
                    select.appendChild(option);
                }
                select.addEventListener('change', function (event){
                    quality = quality_levels[event.target.selectedIndex];
                    onWindowResize();
                }, false);
                toolbar.appendChild(select);
                compileButton = document.createElement('button');
                compileButton.textContent = 'compile';
                compileButton.addEventListener('click', function (event){
                    compile();
                }, false);
                toolbar.appendChild(compileButton);
                // from helper.js
                add_server_buttons();
                gl = canvas.getContext('experimental-webgl', { preserveDrawingBuffer: true });
                // enable dFdx, dFdy, fwidth
                gl.getExtension('OES_standard_derivatives');
                // Create vertex buffer (2 triangles)
                vertex_buffer = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([- 1.0, - 1.0, 1.0, - 1.0, - 1.0, 1.0, 1.0, - 1.0, 1.0, 1.0, - 1.0, 1.0]), gl.STATIC_DRAW);
                // Create surface buffer (coordinates at screen corners)
                surface.buffer = gl.createBuffer();
                code = CodeMirror(document.body, {
                    lineNumbers: true,
                    matchBrackets: true,
                    indentWithTabs: false,
                    tabSize: 4,
                    indentUnit: 4,
                    mode: "text/x-glsl",
                    onChange: function (){
                        if (compileOnChangeCode){
                            clearTimeout(compileTimer);
                            compileTimer = setTimeout(compile, 500);
                        }
                    }
                });
                code.getWrapperElement().style.display = '';
                resizer.offsetMouseX = 0;
                resizer.offsetMouseY = 0;
                resizer.isResizing = false;
                var size_ = 100;
                resizer.currentWidth = size_;
                resizer.currentHeight = size_;
                resizer.minWidth = size_;
                resizer.minHeight = size_;
                resizer.maxWidth = size_;
                resizer.maxHeight = size_;
                resizer.element = document.createElement('div');
                resizer.element.className = 'resizer';
                code.getWrapperElement().appendChild(resizer.element);
                resizer.element.addEventListener('mousedown', function (event){
                    if (event.button !== 2){
                        resizer.offsetMouseX = event.clientX - resizer.currentWidth;
                        resizer.offsetMouseY = event.clientY - resizer.currentHeight;
                        resizer.isResizing = true;
                        event.preventDefault();
                    }
                }, false);

                var surfaceMouseDown = function (event){
                    if (event.shiftKey){
                        resetSurface();
                    }
                    if (event.button === 0){
                        surface.isPanning = true;
                        document.body.style.cursor = 'move';
                    } else {
                        surface.isZooming = true;
                        document.body.style.cursor = 'se-resize';
                        panButton.style.cursor = 'se-resize';
                    }
                    surface.lastX = event.clientX;
                    surface.lastY = event.clientY;
                    event.preventDefault();
                };

                var noContextMenu = function (event){
                    event.preventDefault();
                };

                canvas.addEventListener('mousedown', surfaceMouseDown, false);
                panButton.addEventListener('mousedown', surfaceMouseDown, false);
                canvas.addEventListener('contextmenu', noContextMenu, false);
                panButton.addEventListener('contextmenu', noContextMenu, false);
                var clientXLast, clientYLast;

                document.addEventListener('mousemove', function (event){
                    var clientX = event.clientX;
                    var clientY = event.clientY;
                    if (clientXLast == clientX && clientYLast == clientY)
                        return;
                    clientXLast = clientX;
                    clientYLast = clientY;
                    ///stopHideUI();
                    var codeElement, dx, dy;
                    parameters.mouseX = clientX / window.innerWidth;
                    parameters.mouseY = 1 - clientY / window.innerHeight;
                    if (resizer.isResizing){
                        resizer.currentWidth = Math.max(Math.min(clientX - resizer.offsetMouseX, resizer.maxWidth), resizer.minWidth);
                        resizer.currentHeight = Math.max(Math.min(clientY - resizer.offsetMouseY, resizer.maxHeight), resizer.minWidth);
                        codeElement = code.getWrapperElement();
                        codeElement.style.width = resizer.currentWidth + 'px';
                        codeElement.style.height = resizer.currentHeight + 'px';
                        code.refresh();
                        event.preventDefault();
                    } else if (surface.isPanning){
                        dx = clientX - surface.lastX;
                        dy = clientY - surface.lastY;
                        surface.centerX -= dx * surface.width / window.innerWidth;
                        surface.centerY += dy * surface.height / window.innerHeight;
                        surface.lastX = clientX;
                        surface.lastY = clientY;
                        computeSurfaceCorners();
                        event.preventDefault();
                    } else if (surface.isZooming){
                        dx = clientX - surface.lastX;
                        dy = clientY - surface.lastY;
                        surface.height *= Math.pow(0.997, dx + dy);
                        surface.lastX = clientX;
                        surface.lastY = clientY;
                        computeSurfaceCorners();
                        event.preventDefault();
                    }
                }, false);
                function settleDown (event){
                    resizer.isResizing = surface.isPanning = surface.isZooming = false;
                    document.body.style.cursor = 'default';
                    panButton.style.cursor = 'move';
                }
                function mouseLeave(event){
                    settleDown(event);
                }
                document.addEventListener('mouseup', settleDown, false);
                document.addEventListener('mouseleave', mouseLeave, false);
                onWindowResize();
                window.addEventListener('resize', onWindowResize, false);
                load_url_code();
                compileScreenProgram();
            }

            init();
            animate();

            function computeSurfaceCorners(){
                if (gl) {
                    surface.width = surface.height * parameters.screenWidth / parameters.screenHeight;
                    var halfWidth = surface.width * 0.5, halfHeight = surface.height * 0.5;
                    gl.bindBuffer(gl.ARRAY_BUFFER, surface.buffer);
                    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
                        surface.centerX - halfWidth, surface.centerY - halfHeight,
                        surface.centerX + halfWidth, surface.centerY - halfHeight,
                        surface.centerX - halfWidth, surface.centerY + halfHeight,
                        surface.centerX + halfWidth, surface.centerY - halfHeight,
                        surface.centerX + halfWidth, surface.centerY + halfHeight,
                        surface.centerX - halfWidth, surface.centerY + halfHeight]), gl.STATIC_DRAW);
                }
            }

            function resetSurface(){
                surface.centerX = surface.centerY = 0;
                surface.height = 1;
                computeSurfaceCorners();
            }

            function compile(){
                var program = gl.createProgram();
                var fragment = code.getValue();
                var vertex = document.getElementById('surfaceVertexShader').textContent;
                var vs = createShader(vertex, gl.VERTEX_SHADER);
                var fs = createShader(fragment, gl.FRAGMENT_SHADER);
                if (vs === null || fs === null)return null;
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.deleteShader(vs);
                gl.deleteShader(fs);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)){
                    var error = gl.getProgramInfoLog(program);
                    compileButton.title = error;
                    console.error(error);
                    console.error('VALIDATE_STATUS: ' + gl.getProgramParameter(program, gl.VALIDATE_STATUS), 'ERROR: ' + gl.getError());
                    compileButton.style.color = '#ff0000';
                    compileButton.textContent = 'compiled with errors';
                    set_save_button('hidden');
                    return;
                }
                if (currentProgram){
                    gl.deleteProgram(currentProgram);
                    setURL(fragment);
                }
                currentProgram = program;
                compileButton.style.color = '#00ff00';
                compileButton.textContent = 'compiled successfully';
                set_save_button('visible');
                panButton.style.display = (fragment.indexOf('varying vec2 surfacePosition;')>= 0)? 'inline' : 'none';
                cacheUniformLocation(program, 'time');
                cacheUniformLocation(program, 'tempo');
                cacheUniformLocation(program, 'zoom');
                cacheUniformLocation(program, 'stride');
                cacheUniformLocation(program, 'mouse');
                cacheUniformLocation(program, 'resolution');
                cacheUniformLocation(program, 'backbuffer');
                cacheUniformLocation(program, 'surfaceSize');
                gl.useProgram(currentProgram);
                surface.positionAttribute = gl.getAttribLocation(currentProgram, "surfacePosAttrib");
                gl.enableVertexAttribArray(surface.positionAttribute);
                vertexPosition = gl.getAttribLocation(currentProgram, "position");
                gl.enableVertexAttribArray(vertexPosition);
            }

            function compileScreenProgram(){
                var program = gl.createProgram();
                var fragment = document.getElementById('fragmentShader').textContent;
                var vertex = document.getElementById('vertexShader').textContent;
                var vs = createShader(vertex, gl.VERTEX_SHADER);
                var fs = createShader(fragment, gl.FRAGMENT_SHADER);
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.deleteShader(vs);
                gl.deleteShader(fs);
                gl.linkProgram(program);
                if (!gl.getProgramParameter(program, gl.LINK_STATUS)){
                    console.error('VALIDATE_STATUS: ' + gl.getProgramParameter(program, gl.VALIDATE_STATUS), 'ERROR: ' + gl.getError());
                    return;
                }
                screenProgram = program;
                gl.useProgram(screenProgram);
                cacheUniformLocation(program, 'resolution');
                cacheUniformLocation(program, 'texture');
                cacheUniformLocation(program, 'time');
                cacheUniformLocation(program, 'tempo');
                cacheUniformLocation(program, 'zoom');
                cacheUniformLocation(program, 'stride');
                cacheUniformLocation(program, 'mouse');
                cacheUniformLocation(program, 'resolution');
                cacheUniformLocation(program, 'backbuffer');
                cacheUniformLocation(program, 'surfaceSize');
                screenVertexPosition = gl.getAttribLocation(screenProgram, "position");
                gl.enableVertexAttribArray(screenVertexPosition);
            }

            function cacheUniformLocation(program, label){
                if (program.uniformsCache === undefined){
                    program.uniformsCache = {};
                }
                program.uniformsCache[label] = gl.getUniformLocation(program, label);
            }

            function createTarget(width, height){
                var target = {};
                target.framebuffer = gl.createFramebuffer();
                target.renderbuffer = gl.createRenderbuffer();
                target.texture = gl.createTexture();
                gl.bindTexture(gl.TEXTURE_2D, target.texture);
                gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
                gl.bindFramebuffer(gl.FRAMEBUFFER, target.framebuffer);
                gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, target.texture, 0);
                gl.bindRenderbuffer(gl.RENDERBUFFER, target.renderbuffer);
                gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, width, height);
                gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, target.renderbuffer);
                gl.bindTexture(gl.TEXTURE_2D, null);
                gl.bindRenderbuffer(gl.RENDERBUFFER, null);
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                return target;
            }

            function createRenderTargets(){
                frontTarget = createTarget(parameters.screenWidth, parameters.screenHeight);
                backTarget = createTarget(parameters.screenWidth, parameters.screenHeight);
            }

            function htmlEncode(str){
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
            }

            function createShader(src, type){
                var shader = gl.createShader(type);
                var line, lineNum, lineError, index = 0, indexEnd;
                while (errorLines.length > 0){
                    line = errorLines.pop();
                    code.setLineClass(line, null);
                    code.clearMarker(line);
                }
                gl.shaderSource(shader, src);
                gl.compileShader(shader);
                compileButton.title = '';
                if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)){
                    var error = gl.getShaderInfoLog(shader);
                    // Remove trailing linefeed, for FireFox's benefit.
                    while ((error.length > 1)&& (error.charCodeAt(error.length - 1)< 32)){
                        error = error.substring(0, error.length - 1);
                    }
                    compileButton.title = error;
                    console.error(error);
                    compileButton.style.color = '#ff0000';
                    compileButton.textContent = 'compiled with errors';
                    set_save_button('hidden');
                    while (index >= 0){
                        index = error.indexOf("ERROR: 0:", index);
                        if (index < 0){ break; }
                        index += 9;
                        indexEnd = error.indexOf(':', index);
                        if (indexEnd > index){
                            lineNum = parseInt(error.substring(index, indexEnd));
                            if ((!isNaN(lineNum))&& (lineNum > 0)){
                                index = indexEnd + 1;
                                indexEnd = error.indexOf("ERROR: 0:", index);
                                lineError = htmlEncode((indexEnd > index)? error.substring(index, indexEnd): error.substring(index));
                                line = code.setMarker(lineNum - 1, '<abbr title="' + lineError + '">' + lineNum + '</abbr>', "errorMarker");
                                code.setLineClass(line, "errorLine");
                                errorLines.push(line);
                            }
                        }
                    }
                    return null;
                }
                return shader;
            }

            function onWindowResize(event){
                var isMaxWidth = ((resizer.currentWidth === resizer.maxWidth)|| (resizer.currentWidth === resizer.minWidth)),
                    isMaxHeight = ((resizer.currentHeight === resizer.maxHeight)|| (resizer.currentHeight === resizer.minHeight));
                toolbar.style.width = window.innerWidth - 47 + 'px';
                resizer.isResizing = false;
                resizer.maxWidth = window.innerWidth - 75;
                resizer.maxHeight = window.innerHeight - 125;
                if (isMaxWidth || (resizer.currentWidth > resizer.maxWidth)){
                    resizer.currentWidth = resizer.maxWidth;
                }
                if (isMaxHeight || (resizer.currentHeight > resizer.maxHeight)){
                    resizer.currentHeight = resizer.maxHeight;
                }
                if (resizer.currentWidth < resizer.minWidth){ resizer.currentWidth = resizer.minWidth; }
                if (resizer.currentHeight < resizer.minHeight){ resizer.currentHeight = resizer.minHeight; }
                code.getWrapperElement().style.top = '75px';
                code.getWrapperElement().style.left = '25px';
                code.getWrapperElement().style.width = resizer.currentWidth + 'px';
                code.getWrapperElement().style.height = resizer.currentHeight + 'px';
                canvas.width = window.innerWidth / quality;
                canvas.height = window.innerHeight / quality;
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                parameters.screenWidth = canvas.width;
                parameters.screenHeight = canvas.height;
                computeSurfaceCorners();
                gl.viewport(0, 0, canvas.width, canvas.height);
                createRenderTargets();
            }

            var old_pixels = null;
            var new_pixels = new Uint8Array(gl.drawingBufferWidth * gl.drawingBufferHeight * 4);

            // https://www.opengl.org/sdk/docs/man/html/glReadPixels.xhtml
            // glReadPixels and glReadnPixels return values from each pixel
            // with lower left corner at (x+i,y+j) for 0<=i<width and
            // 0<=j<height. This pixel is said to be the ith column in the
            // jth row. Pixels are returned in row order from the lowest to
            // the highest row, left to right in each row.

            var value_threshold = .95;
            var instrument_count = 5;
            var range = 72;
            var bass = 28;
            var dynamic_range = 6.0;
            var softest = 40;
            var maximum_value = 0;
            var start_time_seconds = new Date().getTime() / 1000.0;

            /**
             * Converts an RGB color value to HSV. Conversion formula
             * adapted from http://en.wikipedia.org/wiki/HSV_color_space.
             * Assumes r, g, and b are contained in the set [0, 255] and
             * returns h, s, and v in the set [0, 1].
             *
             * @param   Number  r       The red color value
             * @param   Number  g       The green color value
             * @param   Number  b       The blue color value
             * @return  Array           The HSV representation
             */
            var rgb_to_hsv = function(r, g, b){
                r = r / 255;
                g = g / 255;
                b = b / 255;
                var max = Math.max(r, g, b);
                var min = Math.min(r, g, b);
                var h, s, v = max;
                var d = max - min;
                s = max === 0 ? 0 : d / max;
                if (max == min){
                    h = 0;
                } else {
                    // More efficient than switch?
                    if        (max == r) {
                        h = (g - b) / d + (g < b ? 6 : 0);
                    } else if (max == g) {
                        h = (b - r) / d + 2;
                    } else if (max == b) {
                        h = (r - g) / d + 4;
                    }
                    h /= 6;
                }
                return [h, s, v];
            }

            var create_on_event = function(score, x, y, h, v) {
               ///var insno = ((x / gl.drawingBufferWidth) * instrument_count) + 1;
               var insno = Math.floor((h * instrument_count) + 2);
               var key = Math.floor((y / gl.drawingBufferHeight) * range + bass);
               var velocity = Math.floor(v * dynamic_range + softest);
               var pan = Math.random();
               insno = insno + key / 1000;
               score.add(0, parameters.duration, 144.0, insno, key, velocity, pan);
            }

            var create_off_event = function(score, x, y, h, v) {
               ///var insno = ((x / gl.drawingBufferWidth) * instrument_count) + 1;
               var insno = Math.floor((h * instrument_count) + 2);
               var key = Math.floor((y / gl.drawingBufferHeight) * range + bass);
               var velocity = Math.floor(v * dynamic_range + softest);
               var pan = Math.random();
               insno = insno + key / 1000;
               score.add(parameters.duration, -1, 144.0, -insno, key, velocity, pan);
            }

            var send_events = function() {
               if (typeof csound.is_playing === 'undefined') {
                    return;
               }
               score.clear();
               maximum_value = 0;
               var old_hsv;
               var new_hsv;
               // By row from bottom (0) to top (height - 1).
               var stride = Math.floor(parameters.stride);
               var offset = Math.floor(stride / 2);
               for (var row_index = offset; row_index < gl.drawingBufferHeight; row_index += stride) {
                  // By column from left (0) to right (width - 1).
                  for (var column_index = offset; column_index < gl.drawingBufferWidth; column_index += stride) {
                     var i = 4 * (row_index * gl.drawingBufferHeight + column_index);
                     old_hsv = rgb_to_hsv(old_pixels[i + 0], old_pixels[i + 1], old_pixels[i + 2], old_pixels[i + 3]);
                     new_hsv = rgb_to_hsv(new_pixels[i + 0], new_pixels[i + 1], new_pixels[i + 2], new_pixels[i + 3]);
                     if (new_hsv[2] > maximum_value) {
                        maximum_value = new_hsv[2];
                     }
                     if (isNaN(new_hsv[2]) || isNaN(old_hsv[2])) {
                        console.warn(sprintf("Index out of range at row %d column %d.", row, column));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ('Indexing is wrong: isNaN for:' + new_hsv + ' or ' + old_hsv);
                     }
                     // On event.
                     if ((old_hsv[2] < value_threshold) && (new_hsv[2] >= value_threshold)) {
                        create_on_event(score, column_index, row_index, new_hsv[0], new_hsv[2]);
                     }
                     // Off event.
                     if ((old_hsv[2] >= value_threshold) && (new_hsv[2] < value_threshold)) {
                        create_off_event(score, column_index, row_index, new_hsv[0], new_hsv[2]);
                     }
                  }
               }
               score.temper();
               ChordSpace.conformScoreToChord(score, chord, false);
               score.sendToCsound(csound);
            }

            var score_time_cell = document.getElementById('Time_cell');
            var X_cell = document.getElementById("X_cell");
            var Y_cell = document.getElementById("Y_cell");
            var Chord_cell = document.getElementById("Chord_cell");
            var Notes_cell = document.getElementById("Notes_cell");

            function render() {
                if (!currentProgram) return;
                parameters.time = Date.now() - parameters.startTime;
                // Set uniforms for custom shader.
                gl.useProgram(currentProgram);
                gl.uniform1f(currentProgram.uniformsCache.time, parameters.time / 1000);
                gl.uniform1f(currentProgram.uniformsCache.tempo, parameters.tempo);
                gl.uniform1f(currentProgram.uniformsCache.zoom, parameters.zoom);
                gl.uniform2f(currentProgram.uniformsCache.mouse, surface.lastX, surface.lastY);
                gl.uniform1f(currentProgram.uniformsCache.stride, parameters.stride);
                gl.uniform2f(currentProgram.uniformsCache.resolution, parameters.screenWidth, parameters.screenHeight);
                gl.uniform1i(currentProgram.uniformsCache.backbuffer, 0);
                gl.uniform2f(currentProgram.uniformsCache.surfaceSize, surface.width, surface.height);
                gl.bindBuffer(gl.ARRAY_BUFFER, surface.buffer);
                gl.vertexAttribPointer(surface.positionAttribute, 2, gl.FLOAT, false, 0, 0);
                gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
                gl.vertexAttribPointer(vertexPosition, 2, gl.FLOAT, false, 0, 0);
                gl.activeTexture(gl.TEXTURE0);
                gl.bindTexture(gl.TEXTURE_2D, backTarget.texture);
                // Render custom shader to front buffer
                gl.bindFramebuffer(gl.FRAMEBUFFER, frontTarget.framebuffer);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                // Set uniforms for screen shader
                gl.useProgram(screenProgram);
                gl.uniform2f(screenProgram.uniformsCache.resolution, parameters.screenWidth, parameters.screenHeight);
                gl.uniform1i(screenProgram.uniformsCache.texture, 1);
                gl.bindBuffer(gl.ARRAY_BUFFER, vertex_buffer);
                gl.vertexAttribPointer(screenVertexPosition, 2, gl.FLOAT, false, 0, 0);
                gl.activeTexture(gl.TEXTURE1);
                gl.bindTexture(gl.TEXTURE_2D, frontTarget.texture);
                // Render front buffer to screen
                gl.bindFramebuffer(gl.FRAMEBUFFER, null);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.drawArrays(gl.TRIANGLES, 0, 6);
                old_pixels = new_pixels.slice();
                // Use pixel buffer objects here?
                gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, new_pixels);
                send_events();
                var current_time_seconds = new Date().getTime() / 1000.0;
                var score_time = current_time_seconds - start_time_seconds;
                score_time_cell.innerHTML = score_time.toFixed(3);
                X_cell.innerHTML = parameters.mouseX.toFixed(3);
                Y_cell.innerHTML = parameters.mouseY.toFixed(3);
                Chord_cell.innerHTML = chord.name();
            }

            function animate() {
                requestAnimationFrame(animate);
                render();
            }

            var gui = null;
            var default_json = {
  "remembered": {
    "Default": {
      "0": {}
    },
    "undefined": {
      "0": {
        "duration": 4,
        "tempo": 0.03269831796308114,
        "zoom": 26.593321911518903,
        "stride": 40,
        "gk_Reverb_Feedback": 0.975,
        "gk_Reverb2_Feedback": 0.9069649573637555,
        "gk_MasterOutput_level": 0.4,
        "gk_DelayedPlucked_level": 23.494926719278467,
        "gk_FM_Clang_level": 9.064261555806084,
        "gk_Harpsichord_level": 10.507328072153328,
        "gk_Plucked_level": 9.064261555806084,
        "gk_STKPlucked_level": 11.950394588500558
      }
    }
  },
  "closed": false,
  "folders": {
    "Master effects": {
      "preset": "Default",
      "closed": false,
      "folders": {}
    },
    "Instruments": {
      "preset": "Default",
      "closed": false,
      "folders": {
        "DelayedPlucked": {
          "preset": "Default",
          "closed": false,
          "folders": {}
        },
        "FM Clang": {
          "preset": "Default",
          "closed": false,
          "folders": {}
        },
        "Harpsichord": {
          "preset": "Default",
          "closed": false,
          "folders": {}
        },
        "Plucked": {
          "preset": "Default",
          "closed": false,
          "folders": {}
        },
        "STKPlucked": {
          "preset": "Default",
          "closed": false,
          "folders": {}
        }
      }
    },
    "Chords and transformations": {
      "preset": "Default",
      "closed": true,
      "folders": {}
    }
  },
  "preset": "undefined"
};
            window.onload = function() {
                try {
                    var temporary_json = Silencio.restoreDatGuiJson(default_json);
                    default_json = temporary_json;
                } catch(e) {
                    console.warn(e);
                }
                gui = new dat.GUI({load: parameters, width: 300});
                gui.remember(parameters);
                gui.add(parameters, 'Play').name('Play [Ctrl-P]');
                gui.add(parameters, 'Stop').name('Stop [Ctrl-S]');
                var Master = gui.addFolder('Master effects');
                add_slider(Master, 'duration', 0, 8   ).name('Duration [Alt-D]').listen();
                add_slider(Master, 'tempo', 0, .333334).name('Tempo    [Alt-T]').listen();
                add_slider(Master, 'zoom', 0, 128     ).name('Zoom     [Alt-Z]').listen();
                add_slider(Master, 'stride', 1, 100   ).name('Stride   [Alt-S]').listen();
                add_slider(Master, 'gk_Reverb_Feedback', 0, 1);
                add_slider(Master, 'gk_MasterOutput_level', -40, 40);
                var intruments = gui.addFolder('Instruments');
                var delayedplucked = intruments.addFolder('DelayedPlucked');
                add_slider(delayedplucked, 'gk_DelayedPlucked_level', -40, 40);
                var fmclang = intruments.addFolder('FM Clang');
                add_slider(fmclang, 'gk_FM_Clang_level', -40, 40);
                var Harpsichord = intruments.addFolder('Harpsichord');
                add_slider(Harpsichord, 'gk_Harpsichord_level', -40, 40);
                var Plucked = intruments.addFolder('Plucked');
                add_slider(Plucked, 'gk_Plucked_level', -40, 40);
                var STKPlucked = intruments.addFolder('STKPlucked');
                add_slider(STKPlucked, 'gk_STKPlucked_level', -40, 40);
                var Chords = gui.addFolder('Chords and transformations');
                Chords.add(parameters, 'CM');
                Chords.add(parameters, 'Bb7');
                Chords.add(parameters, 'FM9');
                Chords.add(parameters, 'K'   ).name('K()   [Ctrl-K]');
                Chords.add(parameters, 'T1'  ).name('T(1)  [Ctrl-1]');
                Chords.add(parameters, 'T2'  ).name('T(2)  [Ctrl-2]');
                Chords.add(parameters, 'T3'  ).name('T(3)  [Ctrl-3]');
                Chords.add(parameters, 'T4'  ).name('T(4)  [Ctrl-4]');
                Chords.add(parameters, 'T5'  ).name('T(5)  [Ctrl-5]');
                Chords.add(parameters, 'T6'  ).name('T(6)  [Ctrl-6]');
                Chords.add(parameters, 'T7'  ).name('T(7)  [Ctrl-7]');
                Chords.add(parameters, 'T8'  ).name('T(8)  [Ctrl-8]');
                Chords.add(parameters, 'T9'  ).name('T(9)  [Ctrl-9]');
                Chords.add(parameters, 'T10' ).name('T(10) [Ctrl-A]');
                Chords.add(parameters, 'T11' ).name('T(11) [Ctrl-B]');
                Chords.add(parameters, 'J2_2').name('J(2,2)');
                Chords.add(parameters, 'J2_3').name('J(2,3)');
                Chords.add(parameters, 'J3_1').name('J(3,1)');
                Chords.add(parameters, 'T5'  ).name('D()   [Ctrl-D]');
                gui.revert();
            };
           function gk_update(name, value) {
                if (typeof csound !== 'undefined') {
                    if (csound.is_playing === true) {
                        var numberValue = parseFloat(value);
                        csound.setControlChannel(name, numberValue);
                        csound.message(name + ': ' + numberValue + '\n');
                    }
                }
            };
            function add_slider(gui_folder, token, minimum, maximum) {
                var on_parameter_change = function(value) {
                    if (token.startsWith('gk_')) {
                        gk_update(token, value);
                    }
                    if (token == 'duration') {
                        parameters.duration = parseFloat(value);
                    }
                    if (token == 'zoom') {
                        parameters.zoom = parseFloat(value);
                    }
                    if (token == 'stride') {
                        parameters.stride = parseFloat(value);
                    }
                    if (token == 'tempo') {
                        parameters.tempo = parseFloat(value);
                    }
                };
                var slider = gui_folder.add(parameters, token, minimum, maximum);
                slider.onChange(on_parameter_change);
                return slider;
            };
            // Used to find out what actually happens when a key is pressed.
            function printKey(e) {
              e = e || event;
              //if (document.forms.keyform[e.type + 'Ignore'].checked) return
              var evt = e.type;
              while (evt.length < 10) evt += ' ';
              var data = evt +
                ' keyCode=' + e.keyCode +
                ' which=' + e.which +
                ' charCode=' + e.charCode +
                ' char=' + String.fromCharCode(e.keyCode || e.charCode) +
                (e.shiftKey ? ' +shift' : '') +
                (e.ctrlKey ? ' +ctrl' : '') +
                (e.altKey ? ' +alt' : '') +
                (e.metaKey ? ' +meta' : '') + '\n';
              logMessage(data);
            }
            function toggle_controls() {
                $("#statistics").toggle();
                gui.toggle();
                gui.closed = true;
                gui.closed = false;
            }
            $(document).on("keydown", function (e) {
                //printKey(e);
                var e_char = String.fromCharCode(e.keyCode || e.charCode);
                if (e.ctrlKey === true) {
                    if        (e_char === 'H') {
                        toggle_controls();
                    } else if (e_char === 'K') {
                        parameters.K();
                    } else if (e_char === '1') {
                        parameters.T1();
                    } else if (e_char === '2') {
                        parameters.T2();
                    } else if (e_char === '3') {
                        parameters.T3();
                    } else if (e_char === '4') {
                        parameters.T4();
                    } else if (e_char === '5') {
                        parameters.T5();
                    } else if (e_char === '6') {
                        parameters.T6();
                    } else if (e_char === '7') {
                        parameters.T7();
                    } else if (e_char === '8') {
                        parameters.T8();
                    } else if (e_char === '9') {
                        parameters.T9();
                    } else if (e_char === 'A') {
                        parameters.T10();
                    } else if (e_char === 'B') {
                        parameters.T11();
                    } else if (e_char === 'D') {
                        parameters.T5();
                     } else if (e_char === 'P') {
                        parameters.Play();
                    } else if (e_char === 'S') {
                        parameters.Stop();
                    } else if (e_char === 'X') {
                        parameters.Close();
                    }
                } else if (e.altKey === true) {
                    var factor = 1.05;
                    if (e.shiftKey === true) {
                        factor = 1 / 1.05;
                    }
                    if        (e_char === 'Z') {
                        parameters.zoom *= factor;
                        if (parameters.zoom < 0) {
                            parameters.zoom = 0;
                        } else if (parameters.zoom > 128) {
                            parameters.zoom = 128;
                        }
                    } else if (e_char === 'T') {
                        parameters.tempo *= factor;
                        if (parameters.tempo < 0) {
                            parameters.tempo = 0;
                        } else if (parameters.tempo > .333334) {
                            parameters.tempo = .333334;
                        }
                    } else if (e_char === 'S') {
                        parameters.stride *= factor;
                        if (parameters.stride < 1) {
                            parameters.stride = 1;
                        } else if (parameters.stride > 100) {
                            parameters.stride = 100;
                        }
                    } else if (e_char === 'D') {
                        parameters.duration *= factor;
                        if (parameters.duration < 0) {
                            parameters.duration = 0;
                        } else if (parameters.duration > 8) {
                            parameters.duration = 8;
                        }
                    }
                }
                return false;
             });
             } catch (err) {
                alert(err);
                console.log(err.message);
                console.log(err.stack);
            }
        </script>
    </body>
</html>
